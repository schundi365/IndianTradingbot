<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEM Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            color: #e2e8f0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #334155;
        }
        
        .card h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #60a5fa;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #334155;
        }
        
        .stat:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 0.95em;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .stat-value.positive {
            color: #10b981;
        }
        
        .stat-value.negative {
            color: #ef4444;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-secondary {
            background: #6366f1;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4f46e5;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }
        
        .controls button {
            flex: 1;
            min-width: 140px;
            white-space: nowrap;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1em;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        
        th {
            background: #0f172a;
            color: #60a5fa;
            font-weight: 600;
        }
        
        tr:hover {
            background: #0f172a;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-success {
            background: #10b981;
            color: white;
        }
        
        .badge-danger {
            background: #ef4444;
            color: white;
        }
        
        .recommendation {
            background: #1e293b;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        .recommendation h3 {
            color: #f59e0b;
            margin-bottom: 10px;
        }
        
        .recommendation p {
            color: #94a3b8;
            margin-bottom: 8px;
        }
        
        .recommendation .impact {
            color: #10b981;
            font-weight: 600;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #334155;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #60a5fa;
        }
        
        .tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.running {
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.stopped {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #6366f1;
        }
        
        .toast.success {
            border-left-color: #10b981;
        }
        
        .toast.error {
            border-left-color: #ef4444;
        }
        
        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid #334155;
        }
        
        .modal-content h2 {
            color: #f59e0b;
            margin-bottom: 20px;
        }
        
        .modal-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .modal-content ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .modal-content li {
            margin-bottom: 10px;
        }
        
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .info-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid #6366f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .validation-error {
            color: #ef4444;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        
        .validation-warning {
            color: #f59e0b;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        
        /* Accordion Styles */
        .accordion-header {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 1px solid #334155;
        }
        
        .accordion-header:hover {
            background: #1e293b;
            border-color: #60a5fa;
        }
        
        .accordion-header span:first-child {
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .accordion-icon {
            transition: transform 0.3s;
            font-size: 0.8em;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 15px;
        }
        
        .accordion-content.active {
            max-height: 2000px;
            padding: 20px 15px;
        }
        
        .config-section {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíé GEM Trading Dashboard</h1>
            <p class="subtitle">Real-time monitoring and configuration</p>
        </header>
        
        <!-- Refresh Button for Dashboard -->
        <div style="margin-bottom: 20px; text-align: right;">
            <button class="btn btn-secondary" onclick="refreshDashboard(event)" title="Refresh Dashboard">üîÑ</button>
        </div>
        
        <!-- Status Cards -->
        <div class="grid">
            <div class="card">
                <h2>Bot Status</h2>
                <div class="stat">
                    <span class="stat-label">Status</span>
                    <span class="stat-value" id="bot-status">
                        <span class="status-indicator stopped"></span>
                        Stopped
                    </span>
                </div>
                <div class="stat">
                    <span class="stat-label">MT5 Connection</span>
                    <span class="stat-value" id="mt5-connection">
                        <span class="status-indicator stopped"></span>
                        Not Connected
                    </span>
                </div>
                <div class="controls">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn btn-primary" id="start-btn" onclick="startBot()">Start Bot</button>
                        <button class="btn btn-danger" id="stop-btn" onclick="stopBot()">Stop Bot</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-warning" id="restart-btn" onclick="restartBot()">üîÑ Restart Bot</button>
                        <button class="btn btn-secondary" onclick="testMT5Connection()">Test MT5</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Account Balance</h2>
                <div class="stat">
                    <span class="stat-label">Balance</span>
                    <span class="stat-value" id="balance">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Equity</span>
                    <span class="stat-value" id="equity">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Floating P&L</span>
                    <span class="stat-value" id="profit">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Today's Profit</span>
                    <span class="stat-value" id="profit-today">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Month to Date</span>
                    <span class="stat-value" id="profit-mtd">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Year to Date</span>
                    <span class="stat-value" id="profit-ytd">$0.00</span>
                </div>
            </div>
            
            <div class="card">
                <h2>Performance</h2>
                <div class="stat">
                    <span class="stat-label">Win Rate</span>
                    <span class="stat-value" id="win-rate">0%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Trades</span>
                    <span class="stat-value" id="total-trades">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Trades Today</span>
                    <span class="stat-value" id="total-trades-today">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Today's Wins</span>
                    <span class="stat-value positive" id="today-wins">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Today's Losses</span>
                    <span class="stat-value negative" id="today-losses">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Open Positions</span>
                    <span class="stat-value" id="open-positions">0</span>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="showTab('config')">Configuration</div>
                <div class="tab" onclick="showTab('charts')">Charts & Analytics</div>
                <div class="tab" onclick="showTab('trades')">Trade History</div>
                <div class="tab" onclick="showTab('positions')">Open Positions</div>
                <div class="tab" onclick="showTab('analysis')">AI Recommendations</div>
                <div class="tab" onclick="showTab('logs')">System Logs</div>
            </div>
            
            <!-- Configuration Tab -->
            <div id="config-tab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Bot Configuration</h2>
                    <button class="btn btn-secondary" onclick="refreshConfig(event)" title="Reload Configuration">üîÑ</button>
                </div>
                
                <!-- Configuration Preset Selector -->
                <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px;">
                    <label style="color: white; font-weight: 600; margin-bottom: 10px; display: block;">üìã Configuration Preset</label>
                    <select id="config-preset" style="width: 100%; padding: 10px; border-radius: 5px; border: none;" onchange="loadPreset()">
                        <option value="profitable">‚úÖ Profitable Balanced (H1) - Recommended</option>
                        <option value="conservative">üõ°Ô∏è Conservative (H4) - Safest</option>
                        <option value="aggressive">‚ö° Aggressive (M30) - Experienced</option>
                        <option value="custom">üé® Custom - Manual Settings</option>
                    </select>
                    <small style="color: rgba(255,255,255,0.9); display: block; margin-top: 8px;">
                        Select a preset or customize individual settings below
                    </small>
                </div>
                
                <form id="config-form">
                    <!-- Basic Settings -->
                    <div class="config-section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">‚öôÔ∏è Basic Settings</h3>
                        <div class="grid">
                            <div class="form-group">
                                <label>Trading Symbols</label>
                                <select id="symbols" multiple style="height: 200px;">
                                    <!-- Commodities - Metals (Default) -->
                                    <optgroup label="üí∞ Commodities - Metals">
                                        <option value="XAUUSD" selected>XAUUSD (Gold)</option>
                                        <option value="XAGUSD" selected>XAGUSD (Silver)</option>
                                        <option value="XPTUSD">XPTUSD (Platinum)</option>
                                        <option value="XPDUSD">XPDUSD (Palladium)</option>
                                    </optgroup>
                                    
                                    <!-- Forex Majors -->
                                    <optgroup label="üí± Forex Majors">
                                        <option value="EURUSD">EURUSD (Euro/USD)</option>
                                        <option value="GBPUSD">GBPUSD (Pound/USD)</option>
                                        <option value="USDJPY">USDJPY (USD/Yen)</option>
                                        <option value="USDCHF">USDCHF (USD/Franc)</option>
                                        <option value="AUDUSD">AUDUSD (Aussie/USD)</option>
                                        <option value="USDCAD">USDCAD (USD/CAD)</option>
                                        <option value="NZDUSD">NZDUSD (Kiwi/USD)</option>
                                    </optgroup>
                                    
                                    <!-- Forex Crosses -->
                                    <optgroup label="üí± Forex Crosses">
                                        <option value="EURJPY">EURJPY (Euro/Yen)</option>
                                        <option value="GBPJPY">GBPJPY (Pound/Yen)</option>
                                        <option value="EURGBP">EURGBP (Euro/Pound)</option>
                                        <option value="EURAUD">EURAUD (Euro/Aussie)</option>
                                        <option value="EURCAD">EURCAD (Euro/CAD)</option>
                                        <option value="GBPAUD">GBPAUD (Pound/Aussie)</option>
                                        <option value="GBPCAD">GBPCAD (Pound/CAD)</option>
                                    </optgroup>
                                    
                                    <!-- Commodities - Energy -->
                                    <optgroup label="‚ö° Commodities - Energy">
                                        <option value="XTIUSD">XTIUSD (Crude Oil WTI)</option>
                                        <option value="XBRUSD">XBRUSD (Crude Oil Brent)</option>
                                        <option value="XNGUSD">XNGUSD (Natural Gas)</option>
                                    </optgroup>
                                    
                                    <!-- Indices -->
                                    <optgroup label="üìä Indices">
                                        <option value="US30">US30 (Dow Jones)</option>
                                        <option value="US500">US500 (S&P 500)</option>
                                        <option value="NAS100">NAS100 (NASDAQ)</option>
                                        <option value="UK100">UK100 (FTSE 100)</option>
                                        <option value="GER40">GER40 (DAX 40)</option>
                                        <option value="FRA40">FRA40 (CAC 40)</option>
                                        <option value="JPN225">JPN225 (Nikkei)</option>
                                        <option value="AUS200">AUS200 (ASX 200)</option>
                                    </optgroup>
                                </select>
                                <small style="color: #94a3b8;">Hold Ctrl/Cmd to select multiple. Default: Gold & Silver</small>
                                <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('metals')">Metals Only</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('forex')">+ Forex Majors</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('all')">Select All</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('none')">Clear All</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Timeframe</label>
                                <select id="timeframe">
                                    <option value="1">M1 (1 minute) - Not Recommended</option>
                                    <option value="5">M5 (5 minutes)</option>
                                    <option value="15">M15 (15 minutes)</option>
                                    <option value="30">M30 (30 minutes)</option>
                                    <option value="16385" selected>H1 (1 hour) - Recommended</option>
                                    <option value="16388">H4 (4 hours)</option>
                                    <option value="16408">D1 (Daily)</option>
                                </select>
                                <small style="color: #94a3b8;">Higher timeframes = better signals</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Risk Per Trade (%)</label>
                                <input type="number" id="risk-percent" value="0.5" step="0.1" min="0.1" max="5" onchange="validateRisk()">
                                <div class="validation-warning" id="risk-warning">‚ö†Ô∏è Risk above 1% is aggressive</div>
                                <div class="validation-error" id="risk-error">‚ùå Risk must be between 0.1% and 5%</div>
                            </div>
                            
                            <div class="form-group">
                                <label>Risk/Reward Ratio</label>
                                <input type="number" id="reward-ratio" value="2.0" step="0.1" min="1.0" max="5.0">
                                <small style="color: #94a3b8;">Minimum 1:2 recommended</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Min Trade Confidence (%)</label>
                                <input type="number" id="min-confidence" value="70" step="5" min="20" max="90" onchange="validateConfidence()">
                                <div class="validation-warning" id="confidence-warning">‚ö†Ô∏è Confidence below 50% may result in poor trades</div>
                                <small style="color: #94a3b8;">Higher = fewer but better trades</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Max Daily Loss (%)</label>
                                <input type="number" id="max-daily-loss" value="3" step="0.5" min="1" max="10" onchange="validateDailyLoss()">
                                <div class="validation-warning" id="daily-loss-warning">‚ö†Ô∏è Daily loss above 5% is very risky</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings - Collapsible -->
                    <div class="config-section" style="margin-top: 20px;">
                        <div class="accordion-header" onclick="toggleAccordion('indicators')">
                            <span>üìä Indicator Settings</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="indicators-content" class="accordion-content">
                            <div class="grid">
                                <!-- Moving Averages -->
                                <div class="form-group">
                                    <label>Fast MA Period</label>
                                    <input type="number" id="fast-ma" value="20" min="5" max="100">
                                    <small style="color: #94a3b8;">Standard: 20</small>
                                </div>
                                <div class="form-group">
                                    <label>Slow MA Period</label>
                                    <input type="number" id="slow-ma" value="50" min="20" max="200">
                                    <small style="color: #94a3b8;">Standard: 50</small>
                                </div>
                                
                                <!-- RSI -->
                                <div class="form-group">
                                    <label>RSI Period</label>
                                    <input type="number" id="rsi-period" value="14" min="7" max="28">
                                    <small style="color: #94a3b8;">Standard: 14</small>
                                </div>
                                <div class="form-group">
                                    <label>RSI Overbought</label>
                                    <input type="number" id="rsi-overbought" value="70" min="60" max="90">
                                    <small style="color: #94a3b8;">Don't buy above this</small>
                                </div>
                                <div class="form-group">
                                    <label>RSI Oversold</label>
                                    <input type="number" id="rsi-oversold" value="30" min="10" max="40">
                                    <small style="color: #94a3b8;">Don't sell below this</small>
                                </div>
                                
                                <!-- MACD -->
                                <div class="form-group">
                                    <label>MACD Fast</label>
                                    <input type="number" id="macd-fast" value="12" min="5" max="20">
                                    <small style="color: #94a3b8;">Standard: 12</small>
                                </div>
                                <div class="form-group">
                                    <label>MACD Slow</label>
                                    <input type="number" id="macd-slow" value="26" min="20" max="40">
                                    <small style="color: #94a3b8;">Standard: 26</small>
                                </div>
                                <div class="form-group">
                                    <label>MACD Signal</label>
                                    <input type="number" id="macd-signal" value="9" min="5" max="15">
                                    <small style="color: #94a3b8;">Standard: 9</small>
                                </div>
                                <div class="form-group">
                                    <label>MACD Min Histogram</label>
                                    <input type="number" id="macd-min-histogram" value="0.5" step="0.1" min="0" max="2">
                                    <small style="color: #94a3b8;">Minimum momentum strength</small>
                                </div>
                                
                                <!-- ATR -->
                                <div class="form-group">
                                    <label>ATR Period</label>
                                    <input type="number" id="atr-period" value="14" min="7" max="28">
                                    <small style="color: #94a3b8;">Standard: 14</small>
                                </div>
                                <div class="form-group">
                                    <label>ATR Multiplier (Stop Loss)</label>
                                    <input type="number" id="atr-multiplier" value="2.0" step="0.1" min="0.5" max="4">
                                    <small style="color: #94a3b8;">Higher = wider stops</small>
                                </div>
                                
                                <!-- ADX -->
                                <div class="form-group">
                                    <label>ADX Min Strength</label>
                                    <input type="number" id="adx-min" value="25" min="15" max="40">
                                    <small style="color: #94a3b8;">Only trade when ADX > this</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters Section -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('filters')">
                            <span>üõ°Ô∏è Trade Filters</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="filters-content" class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>Enable RSI Filter</label>
                                    <select id="use-rsi">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enable MACD Filter</label>
                                    <select id="use-macd">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enable ADX Filter</label>
                                    <select id="use-adx">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enable Trend Filter</label>
                                    <select id="use-trend-filter">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                    <small style="color: #94a3b8;">Uses H4 timeframe for trend</small>
                                </div>
                                <div class="form-group">
                                    <label>Trend MA Period</label>
                                    <input type="number" id="trend-ma-period" value="100" min="50" max="200">
                                    <small style="color: #94a3b8;">For H4 trend filter</small>
                                </div>
                                <div class="form-group">
                                    <label>Enable Trading Hours</label>
                                    <select id="enable-trading-hours">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No (24/7)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Trading Start Hour (UTC)</label>
                                    <input type="number" id="trading-start-hour" value="8" min="0" max="23">
                                    <small style="color: #94a3b8;">8 AM = London open</small>
                                </div>
                                <div class="form-group">
                                    <label>Trading End Hour (UTC)</label>
                                    <input type="number" id="trading-end-hour" value="16" min="0" max="23">
                                    <small style="color: #94a3b8;">4 PM = Before NY close</small>
                                </div>
                                <div class="form-group">
                                    <label>Avoid News Trading</label>
                                    <select id="avoid-news">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>News Buffer (minutes)</label>
                                    <input type="number" id="news-buffer" value="60" min="15" max="120" step="15">
                                    <small style="color: #94a3b8;">Avoid trading X min before/after news</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Position Management -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('position')">
                            <span>üíº Position Management</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="position-content" class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>Use Split Orders</label>
                                    <select id="use-split-orders">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No (Single TP)</option>
                                    </select>
                                    <small style="color: #94a3b8;">Multiple TP levels</small>
                                </div>
                                <div class="form-group">
                                    <label>Number of Positions</label>
                                    <input type="number" id="num-positions" value="3" min="1" max="5">
                                    <small style="color: #94a3b8;">Split into X positions</small>
                                </div>
                                <div class="form-group">
                                    <label>TP Level 1 (R:R)</label>
                                    <input type="number" id="tp-level-1" value="1.5" step="0.1" min="0.5" max="5">
                                </div>
                                <div class="form-group">
                                    <label>TP Level 2 (R:R)</label>
                                    <input type="number" id="tp-level-2" value="2.5" step="0.1" min="1" max="8">
                                </div>
                                <div class="form-group">
                                    <label>TP Level 3 (R:R)</label>
                                    <input type="number" id="tp-level-3" value="4.0" step="0.1" min="2" max="10">
                                </div>
                                <div class="form-group">
                                    <label>Max Trades Total</label>
                                    <input type="number" id="max-trades-total" value="10" min="1" max="50">
                                    <small style="color: #94a3b8;">Max open trades</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Trades Per Symbol</label>
                                    <input type="number" id="max-trades-per-symbol" value="3" min="1" max="10">
                                </div>
                                <div class="form-group">
                                    <label>Enable Trailing Stop</label>
                                    <select id="enable-trailing">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Trail Activation (ATR)</label>
                                    <input type="number" id="trail-activation" value="1.5" step="0.1" min="0.5" max="3">
                                    <small style="color: #94a3b8;">Start trailing after X*ATR profit</small>
                                </div>
                                <div class="form-group">
                                    <label>Trail Distance (ATR)</label>
                                    <input type="number" id="trail-distance" value="1.0" step="0.1" min="0.3" max="2">
                                    <small style="color: #94a3b8;">Trail X*ATR behind price</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Management -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('risk')">
                            <span>‚ö†Ô∏è Risk Management</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="risk-content" class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>Enable Adaptive Risk</label>
                                    <select id="enable-adaptive-risk">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No (Fixed Risk)</option>
                                    </select>
                                    <small style="color: #94a3b8;">Adjusts risk based on market conditions</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Risk Multiplier</label>
                                    <input type="number" id="max-risk-multiplier" value="1.5" step="0.1" min="1" max="3">
                                    <small style="color: #94a3b8;">Max risk increase in good conditions</small>
                                </div>
                                <div class="form-group">
                                    <label>Min Risk Multiplier</label>
                                    <input type="number" id="min-risk-multiplier" value="0.5" step="0.1" min="0.1" max="1">
                                    <small style="color: #94a3b8;">Min risk in bad conditions</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Drawdown (%)</label>
                                    <input type="number" id="max-drawdown" value="10" min="5" max="30">
                                    <small style="color: #94a3b8;">Stop trading if drawdown exceeds</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Daily Trades</label>
                                    <input type="number" id="max-daily-trades" value="20" min="5" max="100">
                                    <small style="color: #94a3b8;">Limit trades per day</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #667eea;">
                        <strong style="color: #667eea;">üí° Tip:</strong> 
                        <span style="color: #64748b;">Start with the "Profitable Balanced" preset and adjust gradually. Test changes on demo account first!</span>
                    </div>
                    
                    <button type="submit" class="btn btn-secondary" id="save-config-btn" style="margin-top: 20px;">üíæ Save Configuration</button>
                </form>
            </div>
            
            <!-- Charts & Analytics Tab -->
            <div id="charts-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Charts & Analytics</h2>
                    <button class="btn btn-secondary" onclick="refreshCharts(event)" title="Refresh Charts">üîÑ</button>
                </div>
                
                <!-- Date Range Filter for Charts -->
                <div style="margin-bottom: 20px; padding: 15px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <label style="margin-bottom: 5px;">Chart Date Range</label>
                            <select id="chart-date-range" onchange="applyChartDateRange()" style="padding: 8px;">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="last7days" selected>Last 7 Days</option>
                                <option value="last30days">Last 30 Days</option>
                                <option value="thisweek">This Week</option>
                                <option value="lastweek">Last Week</option>
                                <option value="thismonth">This Month</option>
                                <option value="lastmonth">Last Month</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="applyChartDateRange()" style="padding: 8px 16px;">Apply</button>
                        </div>
                    </div>
                </div>
                
                <div class="grid" style="margin-bottom: 30px;">
                    <!-- Profit by Symbol Chart -->
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Profit by Symbol</h3>
                        <canvas id="symbol-profit-chart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Win/Loss by Symbol Chart -->
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Win/Loss by Symbol</h3>
                        <canvas id="symbol-winloss-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                
                <div class="grid" style="margin-bottom: 30px;">
                    <!-- Daily Profit Trend -->
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Daily Profit Trend (Last 7 Days)</h3>
                        <canvas id="daily-profit-chart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Hourly Performance -->
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Hourly Performance</h3>
                        <canvas id="hourly-profit-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">Trade Distribution</h3>
                    <canvas id="trade-distribution-chart" style="max-height: 400px;"></canvas>
                </div>
            </div>
            
            <!-- Trade History Tab -->
            <div id="trades-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Trade History</h2>
                    <button class="btn btn-secondary" onclick="refreshTrades(event)" title="Refresh Trades">üîÑ</button>
                </div>
                
                <!-- Win Rate Statistics -->
                <div class="grid" style="margin-bottom: 20px;">
                    <div class="card" style="padding: 15px;">
                        <h3 style="color: #60a5fa; margin-bottom: 10px; font-size: 1em;">Overall Win Rate</h3>
                        <div style="font-size: 2em; font-weight: bold;" id="overall-win-rate">0%</div>
                        <div style="color: #94a3b8; font-size: 0.9em;" id="overall-trades-count">0 trades</div>
                    </div>
                    <div class="card" style="padding: 15px;">
                        <h3 style="color: #60a5fa; margin-bottom: 10px; font-size: 1em;">Today's Win Rate</h3>
                        <div style="font-size: 2em; font-weight: bold;" id="today-win-rate">0%</div>
                        <div style="color: #94a3b8; font-size: 0.9em;" id="today-trades-count">0 trades</div>
                    </div>
                    <div class="card" style="padding: 15px;">
                        <h3 style="color: #60a5fa; margin-bottom: 10px; font-size: 1em;">Last 7 Days Win Rate</h3>
                        <div style="font-size: 2em; font-weight: bold;" id="week-win-rate">0%</div>
                        <div style="color: #94a3b8; font-size: 0.9em;" id="week-trades-count">0 trades</div>
                    </div>
                </div>
                
                <!-- Filters and Sorting -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="margin-bottom: 5px;">Date Range</label>
                        <select id="date-range" onchange="applySortFilter()" style="padding: 8px;">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="last7days" selected>Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                            <option value="thisweek">This Week</option>
                            <option value="lastweek">Last Week</option>
                            <option value="thismonth">This Month</option>
                            <option value="lastmonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-date-from" style="margin-bottom: 0; min-width: 150px; display: none;">
                        <label style="margin-bottom: 5px;">From Date</label>
                        <input type="date" id="date-from" onchange="applySortFilter()" style="padding: 8px;">
                    </div>
                    
                    <div class="form-group" id="custom-date-to" style="margin-bottom: 0; min-width: 150px; display: none;">
                        <label style="margin-bottom: 5px;">To Date</label>
                        <input type="date" id="date-to" onchange="applySortFilter()" style="padding: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="margin-bottom: 5px;">Sort By</label>
                        <select id="sort-by" onchange="applySortFilter()" style="padding: 8px;">
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="profit-desc">Profit (Highest First)</option>
                            <option value="profit-asc">Profit (Lowest First)</option>
                            <option value="amount-desc">Amount (Highest First)</option>
                            <option value="amount-asc">Amount (Lowest First)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="margin-bottom: 5px;">Filter</label>
                        <select id="filter-by" onchange="applySortFilter()" style="padding: 8px;">
                            <option value="all">All Trades</option>
                            <option value="wins">Wins Only</option>
                            <option value="losses">Losses Only</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="margin-bottom: 5px;">Symbol</label>
                        <select id="filter-symbol" onchange="applySortFilter()" style="padding: 8px;">
                            <option value="all">All Symbols</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn btn-secondary" onclick="resetFilters()" style="padding: 8px 16px;">Reset</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="trades-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Volume</th>
                                <th>Open Price</th>
                                <th>Close Price</th>
                                <th>Pips</th>
                                <th>Profit</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body">
                            <tr><td colspan="8" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Open Positions Tab -->
            <div id="positions-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Open Positions</h2>
                    <button class="btn btn-secondary" onclick="refreshPositions(event)" title="Refresh Positions">üîÑ</button>
                </div>
                <div class="table-container">
                    <table id="positions-table">
                        <thead>
                            <tr>
                                <th>Ticket</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Volume</th>
                                <th>Entry</th>
                                <th>Current</th>
                                <th>SL</th>
                                <th>TP</th>
                                <th>Profit</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body">
                            <tr><td colspan="9" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">AI Recommendations</h2>
                    <button class="btn btn-secondary" onclick="refreshRecommendations(event)" title="Refresh Recommendations">üîÑ</button>
                </div>
                <div id="recommendations-container">
                    <div class="loading">Loading recommendations...</div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <h2>System Logs</h2>
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="loadLogs()">Refresh Logs</button>
                    <button class="btn btn-secondary" onclick="downloadLogs()">Download Logs</button>
                </div>
                <div style="background: #0f172a; padding: 20px; border-radius: 8px; max-height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9em;">
                    <pre id="logs-content" style="margin: 0; color: #94a3b8;">Loading logs...</pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Disclaimer Modal -->
    <div class="modal" id="disclaimer-modal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Risk Warning & Disclaimer</h2>
            
            <div class="warning-box">
                <strong>IMPORTANT: Trading involves substantial risk of loss</strong>
            </div>
            
            <p>Before using GEM Trading Bot, please read and understand the following:</p>
            
            <ul>
                <li><strong>Risk of Loss:</strong> Trading forex, gold, and other instruments carries a high level of risk and may not be suitable for all investors. You could lose some or all of your invested capital.</li>
                
                <li><strong>No Guarantee:</strong> Past performance is not indicative of future results. This bot does not guarantee profits.</li>
                
                <li><strong>Automated Trading:</strong> This bot makes automated trading decisions. Always monitor your account and understand the risks.</li>
                
                <li><strong>Test First:</strong> Always test on a demo account before using real money.</li>
                
                <li><strong>Your Responsibility:</strong> You are solely responsible for your trading decisions and any losses incurred.</li>
                
                <li><strong>Market Conditions:</strong> Market conditions can change rapidly. The bot may not perform well in all market conditions.</li>
            </ul>
            
            <div class="info-box">
                <strong>Recommendations:</strong>
                <ul style="margin-top: 10px;">
                    <li>Start with conservative settings (Risk ‚â§ 0.5%)</li>
                    <li>Use proper risk management</li>
                    <li>Never risk more than you can afford to lose</li>
                    <li>Monitor your account regularly</li>
                    <li>Test thoroughly on demo first</li>
                </ul>
            </div>
            
            <p style="margin-top: 20px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="accept-disclaimer" style="width: auto; margin-right: 10px;">
                    <span>I understand and accept the risks involved in automated trading</span>
                </label>
            </p>
            
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="acceptDisclaimer()" id="accept-btn" disabled>I Understand - Continue</button>
                <button class="btn btn-danger" onclick="window.close()">Exit</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <script>
        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Disclaimer Modal
        window.addEventListener('load', function() {
            const disclaimerAccepted = localStorage.getItem('disclaimerAccepted');
            if (!disclaimerAccepted) {
                document.getElementById('disclaimer-modal').classList.add('active');
            }
        });
        
        document.getElementById('accept-disclaimer').addEventListener('change', function() {
            document.getElementById('accept-btn').disabled = !this.checked;
        });
        
        function acceptDisclaimer() {
            localStorage.setItem('disclaimerAccepted', 'true');
            document.getElementById('disclaimer-modal').classList.remove('active');
            showToast('Welcome to GEM Trading! Please configure your settings.', 'success');
        }
        
        // Symbol Selection Helper Functions
        function selectSymbolGroup(group) {
            const symbolSelect = document.getElementById('symbols');
            const options = symbolSelect.options;
            
            // Define symbol groups
            const metals = ['XAUUSD', 'XAGUSD', 'XPTUSD', 'XPDUSD'];
            const forexMajors = ['EURUSD', 'GBPUSD', 'USDJPY', 'USDCHF', 'AUDUSD', 'USDCAD', 'NZDUSD'];
            const forexCrosses = ['EURJPY', 'GBPJPY', 'EURGBP', 'EURAUD', 'EURCAD', 'GBPAUD', 'GBPCAD'];
            const energy = ['XTIUSD', 'XBRUSD', 'XNGUSD'];
            const indices = ['US30', 'US500', 'NAS100', 'UK100', 'GER40', 'FRA40', 'JPN225', 'AUS200'];
            
            // Clear all selections first
            for (let i = 0; i < options.length; i++) {
                options[i].selected = false;
            }
            
            // Select based on group
            if (group === 'metals') {
                // Select only metals
                for (let i = 0; i < options.length; i++) {
                    if (metals.includes(options[i].value)) {
                        options[i].selected = true;
                    }
                }
                showToast('‚úÖ Metals selected (Conservative)', 'success');
            } else if (group === 'forex') {
                // Select metals + forex majors
                for (let i = 0; i < options.length; i++) {
                    if (metals.includes(options[i].value) || forexMajors.includes(options[i].value)) {
                        options[i].selected = true;
                    }
                }
                showToast('‚úÖ Metals + Forex Majors selected (Balanced)', 'success');
            } else if (group === 'all') {
                // Select all
                for (let i = 0; i < options.length; i++) {
                    options[i].selected = true;
                }
                showToast('‚úÖ All symbols selected (Advanced)', 'success');
            } else if (group === 'none') {
                // Already cleared above
                showToast('‚úÖ All symbols cleared', 'success');
            }
        }
        
        // Validation Functions
        function validateRisk() {
            const risk = parseFloat(document.getElementById('risk-percent').value);
            const warning = document.getElementById('risk-warning');
            const error = document.getElementById('risk-error');
            
            error.style.display = 'none';
            warning.style.display = 'none';
            
            if (risk < 0.1 || risk > 5) {
                error.style.display = 'block';
                return false;
            } else if (risk > 1) {
                warning.style.display = 'block';
            }
            return true;
        }
        
        function validateConfidence() {
            const confidence = parseFloat(document.getElementById('min-confidence').value);
            const warning = document.getElementById('confidence-warning');
            
            warning.style.display = 'none';
            
            if (confidence < 30) {
                warning.style.display = 'block';
            }
            return true;
        }
        
        function validateDailyLoss() {
            const loss = parseFloat(document.getElementById('max-daily-loss').value);
            const warning = document.getElementById('daily-loss-warning');
            
            warning.style.display = 'none';
            
            if (loss > 10) {
                warning.style.display = 'block';
            }
            return true;
        }
        
        function validateAllInputs() {
            const riskValid = validateRisk();
            const confidenceValid = validateConfidence();
            const lossValid = validateDailyLoss();
            
            return riskValid && confidenceValid && lossValid;
        }
        
        // MT5 Connection Test
        function testMT5Connection() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Testing...';
            
            fetch('/api/mt5/test')
                .then(r => r.json())
                .then(data => {
                    if (data.connected) {
                        showToast(`‚úÖ MT5 Connected: ${data.account_name} (${data.server})`, 'success');
                        updateMT5Status(true, data);
                    } else {
                        showToast('‚ùå MT5 Not Connected: ' + data.error, 'error');
                        updateMT5Status(false);
                    }
                })
                .catch(err => {
                    showToast('‚ùå Connection test failed: ' + err.message, 'error');
                    updateMT5Status(false);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Test MT5';
                });
        }
        
        // Check MT5 connection status (silent, no toast)
        function checkMT5ConnectionStatus() {
            fetch('/api/mt5/test')
                .then(r => r.json())
                .then(data => {
                    if (data.connected) {
                        updateMT5Status(true, data);
                    } else {
                        updateMT5Status(false);
                    }
                })
                .catch(err => {
                    console.log('MT5 connection check failed:', err);
                    updateMT5Status(false);
                });
        }
        
        function updateMT5Status(connected, data = null) {
            const statusEl = document.getElementById('mt5-connection');
            if (connected) {
                statusEl.innerHTML = '<span class="status-indicator running"></span>Connected';
                document.getElementById('start-btn').disabled = false;
            } else {
                statusEl.innerHTML = '<span class="status-indicator stopped"></span>Not Connected';
                document.getElementById('start-btn').disabled = true;
            }
        }
        
        // Auto-calculate recommended values based on timeframe
        const autoCalculateValues = {
            '1': { risk: 0.3, atr: 0.8, confidence: 40, scalp: 20 },
            '5': { risk: 0.3, atr: 1.0, confidence: 45, scalp: 30 },
            '15': { risk: 0.4, atr: 1.2, confidence: 50, scalp: 45 },
            '30': { risk: 0.5, atr: 1.5, confidence: 55, scalp: 60 },
            '60': { risk: 0.5, atr: 1.8, confidence: 60, scalp: 90 }
        };
        
        // Get currency symbol
        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'EUR': '‚Ç¨',
                'GBP': '¬£',
                'JPY': '¬•',
                'AUD': 'A$',
                'CAD': 'C$',
                'CHF': 'CHF ',
                'CNY': '¬•',
                'SEK': 'kr',
                'NZD': 'NZ$'
            };
            return symbols[currency] || currency + ' ';
        }
        
        // Toggle auto-calculate for parameters
        function toggleAuto(param) {
            const timeframe = document.getElementById('timeframe').value;
            const autoValues = autoCalculateValues[timeframe];
            
            if (param === 'risk') {
                const checkbox = document.getElementById('auto-risk');
                const input = document.getElementById('risk-percent');
                if (checkbox.checked) {
                    input.value = autoValues.risk;
                    input.disabled = true;
                    input.style.opacity = '0.6';
                } else {
                    input.disabled = false;
                    input.style.opacity = '1';
                }
            } else if (param === 'atr') {
                const checkbox = document.getElementById('auto-atr');
                const input = document.getElementById('atr-multiplier');
                if (checkbox.checked) {
                    input.value = autoValues.atr;
                    input.disabled = true;
                    input.style.opacity = '0.6';
                } else {
                    input.disabled = false;
                    input.style.opacity = '1';
                }
            } else if (param === 'confidence') {
                const checkbox = document.getElementById('auto-confidence');
                const input = document.getElementById('min-confidence');
                if (checkbox.checked) {
                    input.value = autoValues.confidence;
                    input.disabled = true;
                    input.style.opacity = '0.6';
                } else {
                    input.disabled = false;
                    input.style.opacity = '1';
                }
            } else if (param === 'scalp') {
                const checkbox = document.getElementById('auto-scalp');
                const input = document.getElementById('scalp-max-hold');
                if (checkbox.checked) {
                    input.value = autoValues.scalp;
                    input.disabled = true;
                    input.style.opacity = '0.6';
                } else {
                    input.disabled = false;
                    input.style.opacity = '1';
                }
            }
        }
        
        // Update auto values when timeframe changes
        document.getElementById('timeframe').addEventListener('change', function() {
            if (document.getElementById('auto-risk').checked) toggleAuto('risk');
            if (document.getElementById('auto-atr').checked) toggleAuto('atr');
            if (document.getElementById('auto-confidence').checked) toggleAuto('confidence');
            if (document.getElementById('auto-scalp').checked) toggleAuto('scalp');
        });
        
        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Stop positions auto-refresh when leaving positions tab
            stopPositionsAutoRefresh();
            
            // Load data for the tab
            if (tabName === 'charts') applyChartDateRange();
            if (tabName === 'trades') loadTrades();
            if (tabName === 'positions') {
                // Start auto-refresh for positions tab
                startPositionsAutoRefresh();
            }
            if (tabName === 'analysis') loadRecommendations();
            if (tabName === 'logs') loadLogs();
        }
        
        // Load logs
        function loadLogs() {
            const logsContent = document.getElementById('logs-content');
            logsContent.textContent = 'Loading logs...';
            
            fetch('/api/logs?lines=100')
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        logsContent.textContent = data.logs.join('');
                        // Scroll to bottom
                        logsContent.parentElement.scrollTop = logsContent.parentElement.scrollHeight;
                    } else if (data.status === 'error') {
                        logsContent.textContent = 'Error: ' + data.message;
                    } else {
                        logsContent.textContent = 'No logs available yet. Start the bot to generate logs.';
                    }
                })
                .catch(err => {
                    console.error('Failed to load logs:', err);
                    logsContent.textContent = 'Error loading logs: ' + err.message + '\n\nPossible causes:\n- Log file is locked by another process\n- Dashboard server issue\n- Network error\n\nTry:\n1. Refresh the page\n2. Restart the dashboard\n3. Check if bot is running';
                    showToast('‚ùå Failed to load logs', 'error');
                });
        }
        
        // Download logs
        function downloadLogs() {
            fetch('/api/logs/download')
                .then(r => {
                    if (!r.ok) {
                        throw new Error('Failed to download logs');
                    }
                    return r.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'gem_trading_logs.txt';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast('‚úÖ Logs downloaded successfully', 'success');
                })
                .catch(err => {
                    console.error('Failed to download logs:', err);
                    showToast('‚ùå Failed to download logs: ' + err.message, 'error');
                });
        }
        
        // Update status every 5 seconds
        setInterval(updateStatus, 5000);
        updateStatus();
        
        // Refresh functions for each tab
        function refreshDashboard(e) {
            const btn = e.target;
            btn.disabled = true;
            
            // Refresh all dashboard data
            updateStatus();
            checkMT5ConnectionStatus();
            
            setTimeout(() => {
                btn.disabled = false;
                showToast('‚úÖ Dashboard refreshed', 'success');
            }, 1000);
        }
        
        function refreshCharts(e) {
            const btn = e.target;
            btn.disabled = true;
            
            applyChartDateRange();
            
            setTimeout(() => {
                btn.disabled = false;
            }, 1000);
        }
        
        function refreshTrades(e) {
            const btn = e.target;
            btn.disabled = true;
            
            loadTrades();
            
            setTimeout(() => {
                btn.disabled = false;
                showToast('‚úÖ Trade history refreshed', 'success');
            }, 1000);
        }
        
        function refreshPositions(e) {
            const btn = e.target;
            btn.disabled = true;
            
            loadPositions();
            
            setTimeout(() => {
                btn.disabled = false;
                showToast('‚úÖ Positions refreshed', 'success');
            }, 1000);
        }
        
        function refreshRecommendations(e) {
            const btn = e.target;
            btn.disabled = true;
            
            loadRecommendations();
            
            setTimeout(() => {
                btn.disabled = false;
                showToast('‚úÖ Recommendations refreshed', 'success');
            }, 1000);
        }
        
        function refreshConfig(e) {
            const btn = e.target;
            btn.disabled = true;
            
            // Reload configuration from server
            fetch('/api/config/get')
                .then(r => r.json())
                .then(data => {
                    if (data.config) {
                        // Populate form with current config
                        Object.keys(data.config).forEach(key => {
                            const element = document.getElementById(key.replace(/_/g, '-'));
                            if (element) {
                                if (element.tagName === 'SELECT' && element.multiple) {
                                    // Handle multi-select
                                    const values = data.config[key];
                                    Array.from(element.options).forEach(option => {
                                        option.selected = values.includes(option.value);
                                    });
                                } else {
                                    element.value = data.config[key];
                                }
                            }
                        });
                        showToast('‚úÖ Configuration reloaded', 'success');
                    }
                })
                .catch(err => {
                    showToast('‚ùå Failed to reload configuration', 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Reload Configuration';
                });
        }
        
        // Check MT5 connection on page load
        setTimeout(checkMT5ConnectionStatus, 1000);
        
        function updateStatus() {
            fetch('/api/bot/status')
                .then(r => r.json())
                .then(data => {
                    // Store currency
                    accountCurrency = data.currency || 'USD';
                    
                    // Get currency symbol
                    const currencySymbol = getCurrencySymbol(accountCurrency);
                    
                    // Handle balance data (default to 0 if undefined)
                    const balance = data.balance || 0;
                    const equity = data.equity || 0;
                    const profit = data.profit || 0;
                    const profitToday = data.profit_today || 0;
                    const profitMtd = data.profit_mtd || 0;
                    const profitYtd = data.profit_ytd || 0;
                    const openPositions = data.open_positions || 0;
                    
                    document.getElementById('balance').textContent = currencySymbol + balance.toFixed(2);
                    document.getElementById('equity').textContent = currencySymbol + equity.toFixed(2);
                    
                    const profitEl = document.getElementById('profit');
                    profitEl.textContent = currencySymbol + profit.toFixed(2);
                    profitEl.className = 'stat-value ' + (profit >= 0 ? 'positive' : 'negative');
                    
                    // Today's profit
                    const profitTodayEl = document.getElementById('profit-today');
                    profitTodayEl.textContent = currencySymbol + profitToday.toFixed(2);
                    profitTodayEl.className = 'stat-value ' + (profitToday >= 0 ? 'positive' : 'negative');
                    
                    // Month to date
                    const profitMtdEl = document.getElementById('profit-mtd');
                    profitMtdEl.textContent = currencySymbol + profitMtd.toFixed(2);
                    profitMtdEl.className = 'stat-value ' + (profitMtd >= 0 ? 'positive' : 'negative');
                    
                    // Year to date
                    const profitYtdEl = document.getElementById('profit-ytd');
                    profitYtdEl.textContent = currencySymbol + profitYtd.toFixed(2);
                    profitYtdEl.className = 'stat-value ' + (profitYtd >= 0 ? 'positive' : 'negative');
                    
                    document.getElementById('open-positions').textContent = openPositions;
                    
                    const statusEl = document.getElementById('bot-status');
                    if (data.running) {
                        statusEl.innerHTML = '<span class="status-indicator running"></span>Running';
                    } else {
                        statusEl.innerHTML = '<span class="status-indicator stopped"></span>Stopped';
                    }
                    
                    // Show error if present
                    if (data.error) {
                        console.warn('Status error:', data.error);
                    }
                })
                .catch(err => {
                    console.error('Failed to fetch bot status:', err);
                    // Don't show toast on every error, just log it
                });
            
            fetch('/api/analysis/performance')
                .then(r => r.json())
                .then(data => {
                    // Handle performance data (default to 0 if undefined)
                    const winRate = data.win_rate || 0;
                    const totalTrades = data.total_trades || 0;
                    const todayWins = data.today_wins || 0;
                    const todayLosses = data.today_losses || 0;
                    const totalTradesToday = todayWins + todayLosses;
                    
                    document.getElementById('win-rate').textContent = winRate + '%';
                    document.getElementById('total-trades').textContent = totalTrades;
                    document.getElementById('total-trades-today').textContent = totalTradesToday;
                    
                    // Update today's wins (green)
                    const todayWinsEl = document.getElementById('today-wins');
                    todayWinsEl.textContent = todayWins;
                    todayWinsEl.className = 'stat-value positive';
                    
                    // Update today's losses (red)
                    const todayLossesEl = document.getElementById('today-losses');
                    todayLossesEl.textContent = todayLosses;
                    todayLossesEl.className = 'stat-value negative';
                })
                .catch(err => {
                    console.error('Failed to fetch performance:', err);
                    // Set defaults on error
                    document.getElementById('win-rate').textContent = '0%';
                    document.getElementById('total-trades').textContent = '0';
                    document.getElementById('total-trades-today').textContent = '0';
                    document.getElementById('today-wins').textContent = '0';
                    document.getElementById('today-losses').textContent = '0';
                });
        }
        
        function startBot() {
            // Check MT5 connection first
            const mt5Status = document.getElementById('mt5-connection').textContent;
            if (mt5Status.includes('Not Connected')) {
                showToast('‚ùå Cannot start bot: MT5 not connected. Click "Test MT5" first.', 'error');
                return;
            }
            
            // Validate configuration
            if (!validateAllInputs()) {
                showToast('‚ùå Cannot start bot: Please fix configuration errors', 'error');
                return;
            }
            
            // Confirm if risky settings
            const risk = parseFloat(document.getElementById('risk-percent').value);
            if (risk > 1) {
                if (!confirm('‚ö†Ô∏è WARNING: Risk per trade is above 1%. This is aggressive. Continue?')) {
                    return;
                }
            }
            
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Starting...';
            
            fetch('/api/bot/start', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('‚úÖ ' + data.message, 'success');
                    } else {
                        showToast('‚ùå ' + data.message, 'error');
                    }
                    updateStatus();
                })
                .catch(err => {
                    showToast('‚ùå Failed to start bot: ' + err.message, 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Start Bot';
                });
        }
        
        function stopBot() {
            if (!confirm('Stop the trading bot? Open positions will remain open.')) {
                return;
            }
            
            const btn = document.getElementById('stop-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Stopping...';
            
            fetch('/api/bot/stop', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('‚úÖ ' + data.message, 'success');
                    } else {
                        showToast('‚ùå ' + data.message, 'error');
                    }
                    updateStatus();
                })
                .catch(err => {
                    showToast('‚ùå Failed to stop bot: ' + err.message, 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Stop Bot';
                });
        }
        
        function restartBot() {
            if (!confirm('Restart the trading bot? This will apply any configuration changes.')) {
                return;
            }
            
            const btn = document.getElementById('restart-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Restarting...';
            
            // First stop the bot
            fetch('/api/bot/stop', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('üîÑ Bot stopped, restarting...', 'info');
                        
                        // Wait 2 seconds then start
                        setTimeout(() => {
                            fetch('/api/bot/start', {method: 'POST'})
                                .then(r => r.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        showToast('‚úÖ Bot restarted successfully', 'success');
                                    } else {
                                        showToast('‚ùå Failed to restart: ' + data.message, 'error');
                                    }
                                    updateStatus();
                                })
                                .catch(err => {
                                    showToast('‚ùå Failed to restart bot: ' + err.message, 'error');
                                })
                                .finally(() => {
                                    btn.disabled = false;
                                    btn.innerHTML = 'üîÑ Restart Bot';
                                });
                        }, 2000);
                    } else {
                        showToast('‚ùå Failed to stop bot: ' + data.message, 'error');
                        btn.disabled = false;
                        btn.innerHTML = 'üîÑ Restart Bot';
                    }
                })
                .catch(err => {
                    showToast('‚ùå Failed to restart bot: ' + err.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Restart Bot';
                });
        }
        
        // Global variable to store all trades
        let allTrades = [];
        let accountCurrency = 'USD'; // Default currency
        
        // Show/hide custom date inputs
        document.getElementById('date-range').addEventListener('change', function() {
            const customFrom = document.getElementById('custom-date-from');
            const customTo = document.getElementById('custom-date-to');
            if (this.value === 'custom') {
                customFrom.style.display = 'block';
                customTo.style.display = 'block';
            } else {
                customFrom.style.display = 'none';
                customTo.style.display = 'none';
            }
        });
        
        // Helper function to get date range
        function getDateRange(rangeType) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;
            
            switch(rangeType) {
                case 'today':
                    startDate = today;
                    endDate = new Date(today.getTime() + 24*60*60*1000);
                    break;
                case 'yesterday':
                    startDate = new Date(today.getTime() - 24*60*60*1000);
                    endDate = today;
                    break;
                case 'last7days':
                    startDate = new Date(today.getTime() - 7*24*60*60*1000);
                    endDate = new Date(today.getTime() + 24*60*60*1000);
                    break;
                case 'last30days':
                    startDate = new Date(today.getTime() - 30*24*60*60*1000);
                    endDate = new Date(today.getTime() + 24*60*60*1000);
                    break;
                case 'thisweek':
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(today.setDate(diff));
                    endDate = new Date(today.getTime() + 7*24*60*60*1000);
                    break;
                case 'lastweek':
                    const lastWeekStart = new Date(today.getTime() - 7*24*60*60*1000);
                    const lastWeekDay = lastWeekStart.getDay();
                    const lastWeekDiff = lastWeekStart.getDate() - lastWeekDay + (lastWeekDay === 0 ? -6 : 1);
                    startDate = new Date(lastWeekStart.setDate(lastWeekDiff));
                    endDate = new Date(startDate.getTime() + 7*24*60*60*1000);
                    break;
                case 'thismonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'lastmonth':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'custom':
                    const fromInput = document.getElementById('date-from').value;
                    const toInput = document.getElementById('date-to').value;
                    if (fromInput) startDate = new Date(fromInput);
                    if (toInput) endDate = new Date(toInput + 'T23:59:59');
                    break;
                case 'all':
                default:
                    return null;
            }
            
            return { startDate, endDate };
        }
        
        // Calculate win rates
        function calculateWinRates(trades) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const last7Days = new Date(today.getTime() - 7*24*60*60*1000);
            
            // Overall
            const overallWins = trades.filter(t => t.profit > 0).length;
            const overallTotal = trades.length;
            const overallWinRate = overallTotal > 0 ? ((overallWins / overallTotal) * 100).toFixed(1) : 0;
            
            // Today
            const todayTrades = trades.filter(t => {
                const tradeDate = new Date(t.time);
                return tradeDate >= today;
            });
            const todayWins = todayTrades.filter(t => t.profit > 0).length;
            const todayTotal = todayTrades.length;
            const todayWinRate = todayTotal > 0 ? ((todayWins / todayTotal) * 100).toFixed(1) : 0;
            
            // Last 7 days
            const weekTrades = trades.filter(t => {
                const tradeDate = new Date(t.time);
                return tradeDate >= last7Days;
            });
            const weekWins = weekTrades.filter(t => t.profit > 0).length;
            const weekTotal = weekTrades.length;
            const weekWinRate = weekTotal > 0 ? ((weekWins / weekTotal) * 100).toFixed(1) : 0;
            
            // Update display
            document.getElementById('overall-win-rate').textContent = overallWinRate + '%';
            document.getElementById('overall-win-rate').className = overallWinRate >= 50 ? 'positive' : 'negative';
            document.getElementById('overall-trades-count').textContent = `${overallWins}W / ${overallTotal - overallWins}L (${overallTotal} trades)`;
            
            document.getElementById('today-win-rate').textContent = todayWinRate + '%';
            document.getElementById('today-win-rate').className = todayWinRate >= 50 ? 'positive' : 'negative';
            document.getElementById('today-trades-count').textContent = `${todayWins}W / ${todayTotal - todayWins}L (${todayTotal} trades)`;
            
            document.getElementById('week-win-rate').textContent = weekWinRate + '%';
            document.getElementById('week-win-rate').className = weekWinRate >= 50 ? 'positive' : 'negative';
            document.getElementById('week-trades-count').textContent = `${weekWins}W / ${weekTotal - weekWins}L (${weekTotal} trades)`;
        }
        
        // Apply sort and filter
        function applySortFilter() {
            let filteredTrades = [...allTrades];
            
            // Apply date range filter
            const dateRange = document.getElementById('date-range').value;
            const range = getDateRange(dateRange);
            
            if (range && range.startDate && range.endDate) {
                filteredTrades = filteredTrades.filter(t => {
                    const tradeDate = new Date(t.time);
                    return tradeDate >= range.startDate && tradeDate < range.endDate;
                });
            }
            
            // Apply win/loss filter
            const filterBy = document.getElementById('filter-by').value;
            if (filterBy === 'wins') {
                filteredTrades = filteredTrades.filter(t => t.profit > 0);
            } else if (filterBy === 'losses') {
                filteredTrades = filteredTrades.filter(t => t.profit < 0);
            }
            
            // Apply symbol filter
            const filterSymbol = document.getElementById('filter-symbol').value;
            if (filterSymbol !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.symbol === filterSymbol);
            }
            
            // Apply sort
            const sortBy = document.getElementById('sort-by').value;
            
            if (sortBy === 'date-desc') {
                filteredTrades.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortBy === 'date-asc') {
                filteredTrades.sort((a, b) => a.timestamp - b.timestamp);
            } else if (sortBy === 'profit-desc') {
                filteredTrades.sort((a, b) => b.profit - a.profit);
            } else if (sortBy === 'profit-asc') {
                filteredTrades.sort((a, b) => a.profit - b.profit);
            } else if (sortBy === 'amount-desc') {
                filteredTrades.sort((a, b) => Math.abs(b.profit) - Math.abs(a.profit));
            } else if (sortBy === 'amount-asc') {
                filteredTrades.sort((a, b) => Math.abs(a.profit) - Math.abs(b.profit));
            }
            
            // Calculate and display win rates (always based on all trades)
            calculateWinRates(allTrades);
            
            // Display filtered and sorted trades
            displayTrades(filteredTrades);
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('date-range').value = 'last7days';
            document.getElementById('sort-by').value = 'date-desc';
            document.getElementById('filter-by').value = 'all';
            document.getElementById('filter-symbol').value = 'all';
            document.getElementById('custom-date-from').style.display = 'none';
            document.getElementById('custom-date-to').style.display = 'none';
            applySortFilter();
        }
        
        // Display trades in table
        function displayTrades(trades) {
            const tbody = document.getElementById('trades-body');
            tbody.innerHTML = '';
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No trades found</td></tr>';
                return;
            }
            
            const currencySymbol = getCurrencySymbol(accountCurrency);
            
            trades.forEach(trade => {
                const row = tbody.insertRow();
                
                // Calculate pips display
                const pips = trade.pips ? trade.pips.toFixed(1) : 'N/A';
                const pipsClass = trade.profit >= 0 ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td>${trade.time}</td>
                    <td>${trade.symbol}</td>
                    <td><span class="badge ${trade.type === 'BUY' ? 'badge-success' : 'badge-danger'}">${trade.type}</span></td>
                    <td>${trade.volume}</td>
                    <td>${trade.price_open ? trade.price_open.toFixed(5) : 'N/A'}</td>
                    <td>${trade.price_close ? trade.price_close.toFixed(5) : 'N/A'}</td>
                    <td class="${pipsClass}">${pips}</td>
                    <td class="${trade.profit >= 0 ? 'positive' : 'negative'}">${currencySymbol}${trade.profit.toFixed(2)}</td>
                `;
            });
        }
        
        function loadTrades() {
            fetch('/api/trades/history')
                .then(r => r.json())
                .then(data => {
                    allTrades = data.trades;
                    
                    // Populate symbol filter
                    const symbols = [...new Set(allTrades.map(t => t.symbol))];
                    const symbolFilter = document.getElementById('filter-symbol');
                    symbolFilter.innerHTML = '<option value="all">All Symbols</option>';
                    symbols.forEach(symbol => {
                        symbolFilter.innerHTML += `<option value="${symbol}">${symbol}</option>`;
                    });
                    
                    // Apply initial sort/filter
                    applySortFilter();
                });
        }
        
        // Auto-refresh interval for positions
        let positionsRefreshInterval = null;
        
        function loadPositions() {
            fetch('/api/trades/open')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('positions-body');
                    tbody.innerHTML = '';
                    
                    if (data.positions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="loading">No open positions</td></tr>';
                        return;
                    }
                    
                    const currencySymbol = getCurrencySymbol(accountCurrency);
                    
                    data.positions.forEach(pos => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${pos.ticket}</td>
                            <td>${pos.symbol}</td>
                            <td><span class="badge ${pos.type === 'BUY' ? 'badge-success' : 'badge-danger'}">${pos.type}</span></td>
                            <td>${pos.volume}</td>
                            <td>${pos.price_open.toFixed(5)}</td>
                            <td>${pos.price_current.toFixed(5)}</td>
                            <td>${pos.sl.toFixed(5)}</td>
                            <td>${pos.tp.toFixed(5)}</td>
                            <td class="${pos.profit >= 0 ? 'positive' : 'negative'}">${currencySymbol}${pos.profit.toFixed(2)}</td>
                        `;
                    });
                })
                .catch(err => {
                    console.error('Failed to load positions:', err);
                });
        }
        
        function startPositionsAutoRefresh() {
            // Clear any existing interval
            if (positionsRefreshInterval) {
                clearInterval(positionsRefreshInterval);
            }
            
            // Load immediately
            loadPositions();
            
            // Then refresh every 2 seconds
            positionsRefreshInterval = setInterval(loadPositions, 2000);
        }
        
        function stopPositionsAutoRefresh() {
            if (positionsRefreshInterval) {
                clearInterval(positionsRefreshInterval);
                positionsRefreshInterval = null;
            }
        }
        
        function loadRecommendations() {
            fetch('/api/analysis/recommendations')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('recommendations-container');
                    container.innerHTML = '';
                    
                    data.recommendations.forEach(rec => {
                        const div = document.createElement('div');
                        div.className = 'recommendation';
                        div.innerHTML = `
                            <h3>Priority ${rec.priority}: ${rec.title}</h3>
                            <p>${rec.description}</p>
                            <p class="impact">${rec.impact}</p>
                            <button class="btn btn-secondary" onclick="alert('${rec.action}')">${rec.action}</button>
                        `;
                        container.appendChild(div);
                    });
                });
        }
        
        // Load charts
        let charts = {};
        
        function loadCharts() {
            fetch('/api/charts/data')
                .then(r => r.json())
                .then(data => {
                    // Destroy existing charts
                    Object.values(charts).forEach(chart => chart.destroy());
                    charts = {};
                    
                    // Profit by Symbol
                    const symbolLabels = Object.keys(data.symbol_profits);
                    const symbolProfits = Object.values(data.symbol_profits);
                    const symbolColors = symbolProfits.map(p => p >= 0 ? '#10b981' : '#ef4444');
                    
                    charts.symbolProfit = new Chart(document.getElementById('symbol-profit-chart'), {
                        type: 'bar',
                        data: {
                            labels: symbolLabels,
                            datasets: [{
                                label: 'Profit ($)',
                                data: symbolProfits,
                                backgroundColor: symbolColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Win/Loss by Symbol
                    const winLossLabels = Object.keys(data.symbol_wins);
                    const wins = Object.values(data.symbol_wins);
                    const losses = Object.values(data.symbol_losses);
                    
                    charts.symbolWinLoss = new Chart(document.getElementById('symbol-winloss-chart'), {
                        type: 'bar',
                        data: {
                            labels: winLossLabels,
                            datasets: [
                                {
                                    label: 'Wins',
                                    data: wins,
                                    backgroundColor: '#10b981'
                                },
                                {
                                    label: 'Losses',
                                    data: losses,
                                    backgroundColor: '#ef4444'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Daily Profit Trend
                    charts.dailyProfit = new Chart(document.getElementById('daily-profit-chart'), {
                        type: 'line',
                        data: {
                            labels: data.daily_labels,
                            datasets: [{
                                label: 'Daily Profit ($)',
                                data: data.daily_values,
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Hourly Performance
                    const hourlyLabels = Object.keys(data.hourly_profits).map(h => h + ':00');
                    const hourlyProfits = Object.values(data.hourly_profits);
                    const hourlyColors = hourlyProfits.map(p => p >= 0 ? '#10b981' : '#ef4444');
                    
                    charts.hourlyProfit = new Chart(document.getElementById('hourly-profit-chart'), {
                        type: 'bar',
                        data: {
                            labels: hourlyLabels,
                            datasets: [{
                                label: 'Profit ($)',
                                data: hourlyProfits,
                                backgroundColor: hourlyColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Trade Distribution (Doughnut)
                    const tradeLabels = Object.keys(data.symbol_trades);
                    const tradeCounts = Object.values(data.symbol_trades);
                    
                    charts.tradeDistribution = new Chart(document.getElementById('trade-distribution-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: tradeLabels,
                            datasets: [{
                                data: tradeCounts,
                                backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { color: '#94a3b8' }
                                }
                            }
                        }
                    });
                });
        }
        
        // Apply chart date range filter
        function applyChartDateRange() {
            const dateRange = document.getElementById('chart-date-range').value;
            
            // Show loading state
            const chartContainers = document.querySelectorAll('.chart-container canvas');
            chartContainers.forEach(canvas => {
                canvas.style.opacity = '0.5';
            });
            
            // Fetch filtered chart data
            fetch(`/api/charts/data?range=${dateRange}`)
                .then(r => r.json())
                .then(data => {
                    // Destroy existing charts
                    Object.values(charts).forEach(chart => chart.destroy());
                    charts = {};
                    
                    // Get range label for chart titles
                    const rangeLabels = {
                        'all': 'All Time',
                        'today': 'Today',
                        'last7days': 'Last 7 Days',
                        'last30days': 'Last 30 Days',
                        'thisweek': 'This Week',
                        'lastweek': 'Last Week',
                        'thismonth': 'This Month',
                        'lastmonth': 'Last Month'
                    };
                    const rangeLabel = rangeLabels[dateRange] || 'All Time';
                    
                    // Profit by Symbol
                    const symbolLabels = Object.keys(data.symbol_profits);
                    const symbolProfits = Object.values(data.symbol_profits);
                    const symbolColors = symbolProfits.map(p => p >= 0 ? '#10b981' : '#ef4444');
                    
                    charts.symbolProfit = new Chart(document.getElementById('symbol-profit-chart'), {
                        type: 'bar',
                        data: {
                            labels: symbolLabels,
                            datasets: [{
                                label: 'Profit ($)',
                                data: symbolProfits,
                                backgroundColor: symbolColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: `Profit by Symbol (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Win/Loss by Symbol
                    const winLossLabels = Object.keys(data.symbol_wins);
                    const wins = Object.values(data.symbol_wins);
                    const losses = Object.values(data.symbol_losses);
                    
                    charts.symbolWinLoss = new Chart(document.getElementById('symbol-winloss-chart'), {
                        type: 'bar',
                        data: {
                            labels: winLossLabels,
                            datasets: [
                                {
                                    label: 'Wins',
                                    data: wins,
                                    backgroundColor: '#10b981'
                                },
                                {
                                    label: 'Losses',
                                    data: losses,
                                    backgroundColor: '#ef4444'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                },
                                title: {
                                    display: true,
                                    text: `Win/Loss by Symbol (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Daily Profit Trend
                    charts.dailyProfit = new Chart(document.getElementById('daily-profit-chart'), {
                        type: 'line',
                        data: {
                            labels: data.daily_labels,
                            datasets: [{
                                label: 'Daily Profit ($)',
                                data: data.daily_values,
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                },
                                title: {
                                    display: true,
                                    text: `Daily Profit Trend (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Hourly Performance
                    const hourlyLabels = Object.keys(data.hourly_profits).map(h => h + ':00');
                    const hourlyProfits = Object.values(data.hourly_profits);
                    const hourlyColors = hourlyProfits.map(p => p >= 0 ? '#10b981' : '#ef4444');
                    
                    charts.hourlyProfit = new Chart(document.getElementById('hourly-profit-chart'), {
                        type: 'bar',
                        data: {
                            labels: hourlyLabels,
                            datasets: [{
                                label: 'Profit ($)',
                                data: hourlyProfits,
                                backgroundColor: hourlyColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: `Hourly Performance (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Trade Distribution (Doughnut)
                    const tradeLabels = Object.keys(data.symbol_trades);
                    const tradeCounts = Object.values(data.symbol_trades);
                    
                    charts.tradeDistribution = new Chart(document.getElementById('trade-distribution-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: tradeLabels,
                            datasets: [{
                                data: tradeCounts,
                                backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { color: '#94a3b8' }
                                },
                                title: {
                                    display: true,
                                    text: `Trade Distribution (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            }
                        }
                    });
                    
                    // Restore opacity
                    chartContainers.forEach(canvas => {
                        canvas.style.opacity = '1';
                    });
                    
                    // Show success toast
                    showToast(`Charts updated for ${rangeLabel}`, 'success');
                })
                .catch(err => {
                    console.error('Failed to load chart data:', err);
                    showToast('Failed to update charts', 'error');
                    
                    // Restore opacity
                    chartContainers.forEach(canvas => {
                        canvas.style.opacity = '1';
                    });
                });
        }
        
        // Accordion toggle functionality
        function toggleAccordion(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const header = event.currentTarget;
            
            header.classList.toggle('active');
            content.classList.toggle('active');
        }
        
        // Configuration presets
        const configPresets = {
            profitable: {
                timeframe: '16385', // H1
                risk_percent: 0.5,
                reward_ratio: 2.0,
                min_confidence: 70,
                max_daily_loss: 3,
                fast_ma: 20,
                slow_ma: 50,
                rsi_period: 14,
                rsi_overbought: 70,
                rsi_oversold: 30,
                macd_fast: 12,
                macd_slow: 26,
                macd_signal: 9,
                macd_min_histogram: 0.5,
                atr_period: 14,
                atr_multiplier: 2.0,
                adx_min: 25,
                use_rsi: 'true',
                use_macd: 'true',
                use_adx: 'true',
                use_trend_filter: 'true',
                trend_ma_period: 100,
                enable_trading_hours: 'true',
                trading_start_hour: 8,
                trading_end_hour: 16,
                avoid_news: 'true',
                news_buffer: 60,
                use_split_orders: 'true',
                num_positions: 3,
                tp_level_1: 1.5,
                tp_level_2: 2.5,
                tp_level_3: 4.0,
                max_trades_total: 10,
                max_trades_per_symbol: 3,
                enable_trailing: 'true',
                trail_activation: 1.5,
                trail_distance: 1.0,
                enable_adaptive_risk: 'true',
                max_risk_multiplier: 1.5,
                min_risk_multiplier: 0.5,
                max_drawdown: 10,
                max_daily_trades: 20
            },
            conservative: {
                timeframe: '16388', // H4
                risk_percent: 0.3,
                reward_ratio: 2.5,
                min_confidence: 75,
                max_daily_loss: 2,
                fast_ma: 20,
                slow_ma: 50,
                rsi_period: 14,
                rsi_overbought: 65,
                rsi_oversold: 35,
                macd_fast: 12,
                macd_slow: 26,
                macd_signal: 9,
                macd_min_histogram: 0.8,
                atr_period: 14,
                atr_multiplier: 2.5,
                adx_min: 30,
                use_rsi: 'true',
                use_macd: 'true',
                use_adx: 'true',
                use_trend_filter: 'true',
                trend_ma_period: 100,
                enable_trading_hours: 'true',
                trading_start_hour: 8,
                trading_end_hour: 16,
                avoid_news: 'true',
                news_buffer: 90,
                use_split_orders: 'true',
                num_positions: 3,
                tp_level_1: 2.0,
                tp_level_2: 3.0,
                tp_level_3: 5.0,
                max_trades_total: 5,
                max_trades_per_symbol: 2,
                enable_trailing: 'true',
                trail_activation: 2.0,
                trail_distance: 1.2,
                enable_adaptive_risk: 'true',
                max_risk_multiplier: 1.2,
                min_risk_multiplier: 0.3,
                max_drawdown: 8,
                max_daily_trades: 10
            },
            aggressive: {
                timeframe: '30', // M30
                risk_percent: 1.0,
                reward_ratio: 1.5,
                min_confidence: 60,
                max_daily_loss: 5,
                fast_ma: 10,
                slow_ma: 30,
                rsi_period: 14,
                rsi_overbought: 75,
                rsi_oversold: 25,
                macd_fast: 12,
                macd_slow: 26,
                macd_signal: 9,
                macd_min_histogram: 0.3,
                atr_period: 14,
                atr_multiplier: 1.5,
                adx_min: 20,
                use_rsi: 'true',
                use_macd: 'true',
                use_adx: 'true',
                use_trend_filter: 'false',
                trend_ma_period: 50,
                enable_trading_hours: 'false',
                trading_start_hour: 0,
                trading_end_hour: 23,
                avoid_news: 'false',
                news_buffer: 30,
                use_split_orders: 'true',
                num_positions: 3,
                tp_level_1: 1.0,
                tp_level_2: 1.5,
                tp_level_3: 2.5,
                max_trades_total: 20,
                max_trades_per_symbol: 5,
                enable_trailing: 'true',
                trail_activation: 1.0,
                trail_distance: 0.8,
                enable_adaptive_risk: 'true',
                max_risk_multiplier: 2.0,
                min_risk_multiplier: 0.5,
                max_drawdown: 15,
                max_daily_trades: 50
            }
        };
        
        // Load preset configuration
        function loadPreset() {
            const preset = document.getElementById('config-preset').value;
            
            if (preset === 'custom') {
                showToast('üí° Custom mode: Adjust settings manually', 'info');
                return;
            }
            
            const config = configPresets[preset];
            if (!config) return;
            
            // Basic settings
            document.getElementById('timeframe').value = config.timeframe;
            document.getElementById('risk-percent').value = config.risk_percent;
            document.getElementById('reward-ratio').value = config.reward_ratio;
            document.getElementById('min-confidence').value = config.min_confidence;
            document.getElementById('max-daily-loss').value = config.max_daily_loss;
            
            // Indicators
            document.getElementById('fast-ma').value = config.fast_ma;
            document.getElementById('slow-ma').value = config.slow_ma;
            document.getElementById('rsi-period').value = config.rsi_period;
            document.getElementById('rsi-overbought').value = config.rsi_overbought;
            document.getElementById('rsi-oversold').value = config.rsi_oversold;
            document.getElementById('macd-fast').value = config.macd_fast;
            document.getElementById('macd-slow').value = config.macd_slow;
            document.getElementById('macd-signal').value = config.macd_signal;
            document.getElementById('macd-min-histogram').value = config.macd_min_histogram;
            document.getElementById('atr-period').value = config.atr_period;
            document.getElementById('atr-multiplier').value = config.atr_multiplier;
            document.getElementById('adx-min').value = config.adx_min;
            
            // Filters
            document.getElementById('use-rsi').value = config.use_rsi;
            document.getElementById('use-macd').value = config.use_macd;
            document.getElementById('use-adx').value = config.use_adx;
            document.getElementById('use-trend-filter').value = config.use_trend_filter;
            document.getElementById('trend-ma-period').value = config.trend_ma_period;
            document.getElementById('enable-trading-hours').value = config.enable_trading_hours;
            document.getElementById('trading-start-hour').value = config.trading_start_hour;
            document.getElementById('trading-end-hour').value = config.trading_end_hour;
            document.getElementById('avoid-news').value = config.avoid_news;
            document.getElementById('news-buffer').value = config.news_buffer;
            
            // Position Management
            document.getElementById('use-split-orders').value = config.use_split_orders;
            document.getElementById('num-positions').value = config.num_positions;
            document.getElementById('tp-level-1').value = config.tp_level_1;
            document.getElementById('tp-level-2').value = config.tp_level_2;
            document.getElementById('tp-level-3').value = config.tp_level_3;
            document.getElementById('max-trades-total').value = config.max_trades_total;
            document.getElementById('max-trades-per-symbol').value = config.max_trades_per_symbol;
            document.getElementById('enable-trailing').value = config.enable_trailing;
            document.getElementById('trail-activation').value = config.trail_activation;
            document.getElementById('trail-distance').value = config.trail_distance;
            
            // Risk Management
            document.getElementById('enable-adaptive-risk').value = config.enable_adaptive_risk;
            document.getElementById('max-risk-multiplier').value = config.max_risk_multiplier;
            document.getElementById('min-risk-multiplier').value = config.min_risk_multiplier;
            document.getElementById('max-drawdown').value = config.max_drawdown;
            document.getElementById('max-daily-trades').value = config.max_daily_trades;
            
            // Validate after loading
            validateRisk();
            validateConfidence();
            validateDailyLoss();
            
            const presetNames = {
                profitable: 'Profitable Balanced',
                conservative: 'Conservative',
                aggressive: 'Aggressive'
            };
            
            showToast(`‚úÖ Loaded ${presetNames[preset]} preset`, 'success');
        }
        
        // Save configuration
        document.getElementById('config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate all inputs
            if (!validateAllInputs()) {
                showToast('‚ùå Please fix validation errors before saving', 'error');
                return;
            }
            
            const btn = document.getElementById('save-config-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Saving...';
            
            // Collect all configuration values
            const config = {
                // Basic settings
                symbols: Array.from(document.getElementById('symbols').selectedOptions).map(o => o.value),
                timeframe: parseInt(document.getElementById('timeframe').value),
                risk_percent: parseFloat(document.getElementById('risk-percent').value),
                reward_ratio: parseFloat(document.getElementById('reward-ratio').value),
                min_confidence: parseFloat(document.getElementById('min-confidence').value) / 100,
                max_daily_loss: parseFloat(document.getElementById('max-daily-loss').value),
                
                // Indicators
                fast_ma_period: parseInt(document.getElementById('fast-ma').value),
                slow_ma_period: parseInt(document.getElementById('slow-ma').value),
                rsi_period: parseInt(document.getElementById('rsi-period').value),
                rsi_overbought: parseInt(document.getElementById('rsi-overbought').value),
                rsi_oversold: parseInt(document.getElementById('rsi-oversold').value),
                macd_fast: parseInt(document.getElementById('macd-fast').value),
                macd_slow: parseInt(document.getElementById('macd-slow').value),
                macd_signal: parseInt(document.getElementById('macd-signal').value),
                macd_min_histogram: parseFloat(document.getElementById('macd-min-histogram').value),
                atr_period: parseInt(document.getElementById('atr-period').value),
                atr_multiplier: parseFloat(document.getElementById('atr-multiplier').value),
                adx_min_strength: parseInt(document.getElementById('adx-min').value),
                
                // Filters
                use_rsi: document.getElementById('use-rsi').value === 'true',
                use_macd: document.getElementById('use-macd').value === 'true',
                use_adx: document.getElementById('use-adx').value === 'true',
                use_trend_filter: document.getElementById('use-trend-filter').value === 'true',
                trend_ma_period: parseInt(document.getElementById('trend-ma-period').value),
                enable_trading_hours: document.getElementById('enable-trading-hours').value === 'true',
                trading_start_hour: parseInt(document.getElementById('trading-start-hour').value),
                trading_end_hour: parseInt(document.getElementById('trading-end-hour').value),
                avoid_news_trading: document.getElementById('avoid-news').value === 'true',
                news_buffer_minutes: parseInt(document.getElementById('news-buffer').value),
                
                // Position Management
                use_split_orders: document.getElementById('use-split-orders').value === 'true',
                num_positions: parseInt(document.getElementById('num-positions').value),
                tp_level_1: parseFloat(document.getElementById('tp-level-1').value),
                tp_level_2: parseFloat(document.getElementById('tp-level-2').value),
                tp_level_3: parseFloat(document.getElementById('tp-level-3').value),
                max_trades_total: parseInt(document.getElementById('max-trades-total').value),
                max_trades_per_symbol: parseInt(document.getElementById('max-trades-per-symbol').value),
                enable_trailing_stop: document.getElementById('enable-trailing').value === 'true',
                trail_activation: parseFloat(document.getElementById('trail-activation').value),
                trail_distance: parseFloat(document.getElementById('trail-distance').value),
                
                // Risk Management
                use_adaptive_risk: document.getElementById('enable-adaptive-risk').value === 'true',
                max_risk_multiplier: parseFloat(document.getElementById('max-risk-multiplier').value),
                min_risk_multiplier: parseFloat(document.getElementById('min-risk-multiplier').value),
                max_drawdown_percent: parseFloat(document.getElementById('max-drawdown').value),
                max_daily_trades: parseInt(document.getElementById('max-daily-trades').value)
            };
            
            fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('‚úÖ Configuration saved successfully!', 'success');
                } else {
                    showToast('‚ùå Failed to save: ' + data.message, 'error');
                }
            })
            .catch(err => {
                showToast('‚ùå Error saving configuration: ' + err.message, 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = 'üíæ Save Configuration';
            });
        });
    </script>
</body>
</html>
