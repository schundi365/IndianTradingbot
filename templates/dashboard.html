<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEM Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            color: #e2e8f0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #334155;
        }
        
        .card h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #60a5fa;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #334155;
        }
        
        .stat:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 0.95em;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .stat-value.positive {
            color: #10b981;
        }
        
        .stat-value.negative {
            color: #ef4444;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-secondary {
            background: #6366f1;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4f46e5;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }
        
        .controls button {
            flex: 1;
            min-width: 140px;
            white-space: nowrap;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1em;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        
        th {
            background: #0f172a;
            color: #60a5fa;
            font-weight: 600;
        }
        
        tr:hover {
            background: #0f172a;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-success {
            background: #10b981;
            color: white;
        }
        
        .badge-danger {
            background: #ef4444;
            color: white;
        }
        
        .recommendation {
            background: #1e293b;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        .recommendation h3 {
            color: #f59e0b;
            margin-bottom: 10px;
        }
        
        .recommendation p {
            color: #94a3b8;
            margin-bottom: 8px;
        }
        
        .recommendation .impact {
            color: #10b981;
            font-weight: 600;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #334155;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #60a5fa;
        }
        
        .tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.running {
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.stopped {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #6366f1;
        }
        
        .toast.success {
            border-left-color: #10b981;
        }
        
        .toast.error {
            border-left-color: #ef4444;
        }
        
        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid #334155;
        }
        
        .modal-content h2 {
            color: #f59e0b;
            margin-bottom: 20px;
        }
        
        .modal-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .modal-content ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .modal-content li {
            margin-bottom: 10px;
        }
        
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .info-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid #6366f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .validation-error {
            color: #ef4444;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        
        .validation-warning {
            color: #f59e0b;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        
        /* Accordion Styles */
        .accordion-header {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 1px solid #334155;
        }
        
        .accordion-header:hover {
            background: #1e293b;
            border-color: #60a5fa;
        }
        
        .accordion-header span:first-child {
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .accordion-icon {
            transition: transform 0.3s;
            font-size: 0.8em;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 15px;
        }
        
        .accordion-content.active {
            max-height: 2000px;
            padding: 20px 15px;
        }
        
        .config-section {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíé GEM Trading Dashboard</h1>
            <p class="subtitle">Real-time monitoring and configuration</p>
        </header>
        
        <!-- Refresh Button for Dashboard -->
        <div style="margin-bottom: 20px; text-align: right;">
            <button class="btn btn-secondary" onclick="refreshDashboard(event)" title="Refresh Dashboard">üîÑ</button>
        </div>
        
        <!-- Status Cards -->
        <div class="grid">
            <div class="card">
                <h2>Bot Status</h2>
                <div class="stat">
                    <span class="stat-label">Status</span>
                    <span class="stat-value" id="bot-status">
                        <span class="status-indicator stopped"></span>
                        Stopped
                    </span>
                </div>
                <div class="stat">
                    <span class="stat-label">MT5 Connection</span>
                    <span class="stat-value" id="mt5-connection">
                        <span class="status-indicator stopped"></span>
                        Not Connected
                    </span>
                </div>
                <div class="controls">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn btn-primary" id="start-btn" onclick="startBot()">Start Bot</button>
                        <button class="btn btn-danger" id="stop-btn" onclick="stopBot()">Stop Bot</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-warning" id="restart-btn" onclick="restartBot()">üîÑ Restart Bot</button>
                        <button class="btn btn-secondary" onclick="testMT5Connection()">Test MT5</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Account Balance</h2>
                <div class="stat">
                    <span class="stat-label">Balance</span>
                    <span class="stat-value" id="balance">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Equity</span>
                    <span class="stat-value" id="equity">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Floating P&L</span>
                    <span class="stat-value" id="profit">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Today's Profit</span>
                    <span class="stat-value" id="profit-today">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Month to Date</span>
                    <span class="stat-value" id="profit-mtd">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Year to Date</span>
                    <span class="stat-value" id="profit-ytd">$0.00</span>
                </div>
            </div>
            
            <div class="card">
                <h2>Performance</h2>
                
                <!-- No Trades Info Box (hidden when trades exist) -->
                <div id="no-trades-info" style="display: none; padding: 15px; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">‚ÑπÔ∏è</span>
                        <div>
                            <strong style="color: white; display: block; margin-bottom: 5px;">No Trading History Yet</strong>
                            <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">
                                Your bot hasn't executed any trades yet. This is normal for:
                            </p>
                            <ul style="color: rgba(255,255,255,0.9); margin: 8px 0 0 20px; font-size: 13px;">
                                <li>New installations</li>
                                <li>Fresh demo accounts</li>
                                <li>Waiting for quality trade signals</li>
                                <li>High confidence threshold (bot is selective)</li>
                            </ul>
                            <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 13px;">
                                <strong>Tip:</strong> The bot is now optimized with 50% confidence for better signal generation. Lower values may increase trades but reduce quality.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="stat">
                    <span class="stat-label">Win Rate</span>
                    <span class="stat-value" id="win-rate">0%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Trades</span>
                    <span class="stat-value" id="total-trades">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Trades Today</span>
                    <span class="stat-value" id="total-trades-today">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Today's Wins</span>
                    <span class="stat-value positive" id="today-wins">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Today's Losses</span>
                    <span class="stat-value negative" id="today-losses">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Open Positions</span>
                    <span class="stat-value" id="open-positions">0</span>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="showTab('config')">Configuration</div>
                <div class="tab" onclick="showTab('trend-detection')">Trend Detection</div>
                <div class="tab" onclick="showTab('charts')">Charts & Analytics</div>
                <div class="tab" onclick="showTab('trades')">Trade History</div>
                <div class="tab" onclick="showTab('positions')">Open Positions</div>
                <div class="tab" onclick="showTab('analysis')">AI Recommendations</div>
                <div class="tab" onclick="showTab('logs')">System Logs</div>
            </div>
            
            <!-- Configuration Tab -->
            <div id="config-tab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Bot Configuration</h2>
                    <button class="btn btn-secondary" onclick="refreshConfig(event)" title="Reload Configuration">üîÑ</button>
                </div>
                
                <!-- Configuration Preset Selector -->
                <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px;">
                    <label style="color: white; font-weight: 600; margin-bottom: 10px; display: block;">üìã Configuration Preset</label>
                    <select id="config-preset" style="width: 100%; padding: 10px; border-radius: 5px; border: none;" onchange="loadPreset()">
                        <option value="profitable">‚úÖ Profitable Balanced (H1) - Recommended</option>
                        <option value="conservative">üõ°Ô∏è Conservative (H4) - Safest</option>
                        <option value="aggressive">‚ö° Aggressive (M30) - Experienced</option>
                        <option value="crypto">‚Çø Crypto Trading (H1) - High Volatility</option>
                        <option value="custom">üé® Custom - Manual Settings</option>
                    </select>
                    <small style="color: rgba(255,255,255,0.9); display: block; margin-top: 8px;">
                        Select a preset or customize individual settings below
                    </small>
                </div>
                
                <form id="config-form">
                    <!-- Basic Settings -->
                    <div class="config-section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">‚öôÔ∏è Basic Settings</h3>
                        <div class="grid">
                            <div class="form-group">
                                <label>Trading Symbols</label>
                                <select id="symbols" multiple style="height: 200px;">
                                    <!-- Commodities - Metals (Default) -->
                                    <optgroup label="üí∞ Commodities - Metals">
                                        <option value="XAUUSD" selected>XAUUSD (Gold)</option>
                                        <option value="XAGUSD" selected>XAGUSD (Silver)</option>
                                        <option value="XPTUSD">XPTUSD (Platinum)</option>
                                        <option value="XPDUSD">XPDUSD (Palladium)</option>
                                    </optgroup>
                                    
                                    <!-- Forex Majors -->
                                    <optgroup label="üí± Forex Majors">
                                        <option value="EURUSD">EURUSD (Euro/USD)</option>
                                        <option value="GBPUSD">GBPUSD (Pound/USD)</option>
                                        <option value="USDJPY">USDJPY (USD/Yen)</option>
                                        <option value="USDCHF">USDCHF (USD/Franc)</option>
                                        <option value="AUDUSD">AUDUSD (Aussie/USD)</option>
                                        <option value="USDCAD">USDCAD (USD/CAD)</option>
                                        <option value="NZDUSD">NZDUSD (Kiwi/USD)</option>
                                    </optgroup>
                                    
                                    <!-- Forex Crosses -->
                                    <optgroup label="üí± Forex Crosses">
                                        <option value="EURJPY">EURJPY (Euro/Yen)</option>
                                        <option value="GBPJPY">GBPJPY (Pound/Yen)</option>
                                        <option value="EURGBP">EURGBP (Euro/Pound)</option>
                                        <option value="EURAUD">EURAUD (Euro/Aussie)</option>
                                        <option value="EURCAD">EURCAD (Euro/CAD)</option>
                                        <option value="GBPAUD">GBPAUD (Pound/Aussie)</option>
                                        <option value="GBPCAD">GBPCAD (Pound/CAD)</option>
                                    </optgroup>
                                    
                                    <!-- Cryptocurrencies -->
                                    <optgroup label="‚Çø Cryptocurrencies">
                                        <option value="BTCUSD">BTCUSD (Bitcoin)</option>
                                        <option value="ETHUSD">ETHUSD (Ethereum)</option>
                                        <option value="LTCUSD">LTCUSD (Litecoin)</option>
                                        <option value="XRPUSD">XRPUSD (Ripple)</option>
                                        <option value="BCHUSD">BCHUSD (Bitcoin Cash)</option>
                                        <option value="ADAUSD">ADAUSD (Cardano)</option>
                                        <option value="DOTUSD">DOTUSD (Polkadot)</option>
                                        <option value="LINKUSD">LINKUSD (Chainlink)</option>
                                        <option value="XLMUSD">XLMUSD (Stellar)</option>
                                        <option value="UNIUSD">UNIUSD (Uniswap)</option>
                                        <option value="SOLUSD">SOLUSD (Solana)</option>
                                        <option value="MATICUSD">MATICUSD (Polygon)</option>
                                        <option value="AVAXUSD">AVAXUSD (Avalanche)</option>
                                        <option value="DOGEUSD">DOGEUSD (Dogecoin)</option>
                                        <option value="SHIBUSD">SHIBUSD (Shiba Inu)</option>
                                    </optgroup>
                                    
                                    <!-- Commodities - Energy -->
                                    <optgroup label="‚ö° Commodities - Energy">
                                        <option value="XTIUSD">XTIUSD (Crude Oil WTI)</option>
                                        <option value="XBRUSD">XBRUSD (Crude Oil Brent)</option>
                                        <option value="XNGUSD">XNGUSD (Natural Gas)</option>
                                    </optgroup>
                                    
                                    <!-- Indices -->
                                    <optgroup label="üìä Indices">
                                        <option value="US30">US30 (Dow Jones)</option>
                                        <option value="US500">US500 (S&P 500)</option>
                                        <option value="NAS100">NAS100 (NASDAQ)</option>
                                        <option value="UK100">UK100 (FTSE 100)</option>
                                        <option value="GER40">GER40 (DAX 40)</option>
                                        <option value="FRA40">FRA40 (CAC 40)</option>
                                        <option value="JPN225">JPN225 (Nikkei)</option>
                                        <option value="AUS200">AUS200 (ASX 200)</option>
                                    </optgroup>
                                </select>
                                <small style="color: #94a3b8;">Hold Ctrl/Cmd to select multiple. Default: Gold & Silver</small>
                                <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('metals')">Metals Only</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('forex')">+ Forex Majors</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('crypto')">‚Çø Crypto</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('all')">Select All</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="selectSymbolGroup('none')">Clear All</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Timeframe</label>
                                <select id="timeframe">
                                    <option value="1">M1 (1 minute) - Not Recommended</option>
                                    <option value="5">M5 (5 minutes)</option>
                                    <option value="15" selected>M15 (15 minutes) - Recommended</option>
                                    <option value="30">M30 (30 minutes)</option>
                                    <option value="16385">H1 (1 hour)</option>
                                    <option value="16388">H4 (4 hours)</option>
                                    <option value="16408">D1 (Daily)</option>
                                </select>
                                <small style="color: #94a3b8;">Higher timeframes = better signals</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Risk Per Trade (%)</label>
                                <input type="number" id="risk-percent" value="0.5" step="0.1" min="0.1" max="5" onchange="validateRisk()">
                                <div class="validation-warning" id="risk-warning">‚ö†Ô∏è Risk above 1% is aggressive</div>
                                <div class="validation-error" id="risk-error">‚ùå Risk must be between 0.1% and 5%</div>
                            </div>
                            
                            <div class="form-group">
                                <label>Risk/Reward Ratio</label>
                                <input type="number" id="reward-ratio" value="2.0" step="0.1" min="1.0" max="5.0">
                                <small style="color: #94a3b8;">Minimum 1:2 recommended (only used if pip-based disabled)</small>
                            </div>
                            
                            <!-- Pip-Based TP/SL Controls -->
                            <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); border-radius: 8px; color: white;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                    <span style="font-size: 18px;">üéØ</span>
                                    <strong style="font-size: 15px;">TP/SL Calculation Method</strong>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                    <strong>‚ö†Ô∏è CRITICAL:</strong> Both SL and TP must use the same calculation method!<br>
                                    <small>Mixing methods causes SL > TP (negative risk/reward)</small>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="color: white; font-weight: bold;">Stop Loss Method</label>
                                    <select id="use-pip-based-sl" onchange="updateTPSLMethodWarning()" style="background: rgba(255,255,255,0.9); color: #1e293b;">
                                        <option value="false">ATR-Based (Adaptive to volatility)</option>
                                        <option value="true">Pip-Based (Fixed distance)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="sl-pips-group" style="display: none; margin-bottom: 15px;">
                                    <label style="color: white; font-weight: bold;">Stop Loss (Pips)</label>
                                    <input type="number" id="sl-pips" value="50" step="5" min="10" max="500" style="background: rgba(255,255,255,0.9); color: #1e293b;">
                                    <small style="color: rgba(255,255,255,0.9);">Distance from entry in pips</small>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="color: white; font-weight: bold;">Take Profit Method</label>
                                    <select id="use-pip-based-tp" onchange="updateTPSLMethodWarning()" style="background: rgba(255,255,255,0.9); color: #1e293b;">
                                        <option value="false">Ratio-Based (Multiple of SL)</option>
                                        <option value="true">Pip-Based (Fixed distance)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="tp-pips-group" style="display: none; margin-bottom: 15px;">
                                    <label style="color: white; font-weight: bold;">Take Profit Base (Pips)</label>
                                    <input type="number" id="tp-pips" value="100" step="10" min="20" max="1000" style="background: rgba(255,255,255,0.9); color: #1e293b;">
                                    <small style="color: rgba(255,255,255,0.9);">Base TP distance (multiplied by TP levels)</small>
                                </div>
                                
                                <div id="tpsl-method-warning" style="display: none; background: rgba(220, 38, 38, 0.9); padding: 10px; border-radius: 6px; margin-top: 10px;">
                                    <strong>‚ùå WARNING: Inconsistent Methods!</strong><br>
                                    <small>SL and TP use different calculation methods. This can cause SL > TP!</small>
                                </div>
                                
                                <div id="tpsl-method-ok" style="display: none; background: rgba(34, 197, 94, 0.9); padding: 10px; border-radius: 6px; margin-top: 10px;">
                                    <strong>‚úì Methods Consistent</strong><br>
                                    <small id="tpsl-method-description"></small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Min Trade Confidence (%)</label>
                                <input type="number" id="min-confidence" value="50" step="5" min="20" max="90" onchange="validateConfidence()">
                                <div class="validation-warning" id="confidence-warning">‚ö†Ô∏è Confidence below 50% may result in poor trades</div>
                                <small style="color: #94a3b8;">Higher = fewer but better trades</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Max Daily Loss (%)</label>
                                <input type="number" id="max-daily-loss" value="3" step="0.5" min="1" max="10" onchange="validateDailyLoss()">
                                <div class="validation-warning" id="daily-loss-warning">‚ö†Ô∏è Daily loss above 5% is very risky</div>
                            </div>
                            
                            <div class="form-group">
                                <label>Analysis Bars</label>
                                <input type="number" id="analysis-bars" value="200" step="10" min="50" max="1000" onchange="validateAnalysisBars()">
                                <small style="color: #94a3b8;">Number of historical bars for signal analysis</small>
                                <div class="validation-warning" id="analysis-bars-warning">‚ö†Ô∏è More bars = slower analysis but better accuracy</div>
                                <div class="validation-error" id="analysis-bars-error">‚ùå Analysis bars must be between 50 and 1000</div>
                                
                                <!-- Analysis Bars Information Panel -->
                                <div style="margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 8px; color: white; font-size: 13px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 16px;">üí°</span>
                                        <strong>Analysis Bars Guide</strong>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                                        <div>
                                            <strong>üìä Timeframe Recommendations:</strong><br>
                                            ‚Ä¢ M1-M5: 50-100 bars<br>
                                            ‚Ä¢ M15-M30: 100-200 bars<br>
                                            ‚Ä¢ H1-H4: 200-300 bars<br>
                                            ‚Ä¢ D1+: 300-500 bars
                                        </div>
                                        <div>
                                            <strong>‚ö° Performance Impact:</strong><br>
                                            ‚Ä¢ 50-150: Fast analysis<br>
                                            ‚Ä¢ 200-300: Balanced<br>
                                            ‚Ä¢ 400-500: Slower but accurate<br>
                                            ‚Ä¢ 500+: Research/backtesting
                                        </div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-top: 8px;">
                                        <strong>üéØ Rule of Thumb:</strong> Use 10-20x your timeframe in minutes as bar count<br>
                                        <em>Example: H1 (60 min) ‚Üí 200-300 bars optimal</em>
                                    </div>
                                </div>
                                
                                <!-- Symbol Data Availability Checker -->
                                <div style="margin-top: 10px;">
                                    <button type="button" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;" onclick="checkSymbolDataAvailability()">
                                        üîç Check Symbol Data Availability
                                    </button>
                                    <div id="symbol-data-status" style="margin-top: 8px; display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings - Collapsible -->
                    <div class="config-section" style="margin-top: 20px;">
                        <div class="accordion-header" onclick="toggleAccordion('indicators')">
                            <span>üìä Indicator Settings</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="indicators-content" class="accordion-content">
                            <div class="grid">
                                <!-- Moving Averages -->
                                <div class="form-group">
                                    <label>Fast MA Period</label>
                                    <input type="number" id="fast-ma" value="10" min="5" max="100">
                                    <small style="color: #94a3b8;">Optimized: 10 (faster signals)</small>
                                </div>
                                <div class="form-group">
                                    <label>Slow MA Period</label>
                                    <input type="number" id="slow-ma" value="21" min="20" max="200">
                                    <small style="color: #94a3b8;">Optimized: 21 (balanced)</small>
                                </div>
                                
                                <!-- RSI -->
                                <div class="form-group">
                                    <label>RSI Period</label>
                                    <input type="number" id="rsi-period" value="14" min="7" max="28">
                                    <small style="color: #94a3b8;">Standard: 14</small>
                                </div>
                                <div class="form-group">
                                    <label>RSI Overbought</label>
                                    <input type="number" id="rsi-overbought" value="70" min="60" max="90">
                                    <small style="color: #94a3b8;">Don't buy above this</small>
                                </div>
                                <div class="form-group">
                                    <label>RSI Oversold</label>
                                    <input type="number" id="rsi-oversold" value="30" min="10" max="40">
                                    <small style="color: #94a3b8;">Don't sell below this</small>
                                </div>
                                
                                <!-- MACD -->
                                <div class="form-group">
                                    <label>MACD Fast</label>
                                    <input type="number" id="macd-fast" value="12" min="5" max="20">
                                    <small style="color: #94a3b8;">Standard: 12</small>
                                </div>
                                <div class="form-group">
                                    <label>MACD Slow</label>
                                    <input type="number" id="macd-slow" value="26" min="20" max="40">
                                    <small style="color: #94a3b8;">Standard: 26</small>
                                </div>
                                <div class="form-group">
                                    <label>MACD Signal</label>
                                    <input type="number" id="macd-signal" value="9" min="5" max="15">
                                    <small style="color: #94a3b8;">Standard: 9</small>
                                </div>
                                <div class="form-group">
                                    <label>MACD Min Histogram</label>
                                    <input type="number" id="macd-min-histogram" value="0.0005" step="0.0001" min="0" max="2">
                                    <small style="color: #94a3b8;">Minimum momentum strength (Valid range: 0.0001 to 0.01)</small>
                                </div>
                                
                                <!-- ATR -->
                                <div class="form-group">
                                    <label>ATR Period</label>
                                    <input type="number" id="atr-period" value="14" min="7" max="28">
                                    <small style="color: #94a3b8;">Standard: 14</small>
                                </div>
                                <div class="form-group">
                                    <label>ATR Multiplier (Stop Loss)</label>
                                    <input type="number" id="atr-multiplier" value="2.0" step="0.1" min="0.5" max="4">
                                    <small style="color: #94a3b8;">Higher = wider stops</small>
                                </div>
                                
                                <!-- ADX -->
                                <div class="form-group">
                                    <label>ADX Min Strength</label>
                                    <input type="number" id="adx-min" value="25" min="15" max="40">
                                    <small style="color: #94a3b8;">Only trade when ADX > this</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters Section -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('filters')">
                            <span>üõ°Ô∏è Trade Filters</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="filters-content" class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>Enable RSI Filter</label>
                                    <select id="use-rsi">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enable MACD Filter</label>
                                    <select id="use-macd">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enable ADX Filter</label>
                                    <select id="use-adx">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enable Trend Filter</label>
                                    <select id="use-trend-filter">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                    <small style="color: #94a3b8;">Uses H4 timeframe for trend</small>
                                </div>
                                <div class="form-group">
                                    <label>Trend MA Period</label>
                                    <input type="number" id="trend-ma-period" value="100" min="50" max="200">
                                    <small style="color: #94a3b8;">For H4 trend filter</small>
                                </div>
                                <div class="form-group">
                                    <label>Enable Trading Hours</label>
                                    <select id="enable-trading-hours">
                                        <option value="false" selected>No (24/7) - Recommended</option>
                                        <option value="true">Yes (Restricted Hours)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Trading Start Hour (UTC)</label>
                                    <input type="number" id="trading-start-hour" value="8" min="0" max="23">
                                    <small style="color: #94a3b8;">8 AM = London open</small>
                                </div>
                                <div class="form-group">
                                    <label>Trading End Hour (UTC)</label>
                                    <input type="number" id="trading-end-hour" value="16" min="0" max="23">
                                    <small style="color: #94a3b8;">4 PM = Before NY close</small>
                                </div>
                                <div class="form-group">
                                    <label>Avoid News Trading</label>
                                    <select id="avoid-news">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>News Buffer (minutes)</label>
                                    <input type="number" id="news-buffer" value="60" min="15" max="120" step="15">
                                    <small style="color: #94a3b8;">Avoid trading X min before/after news</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Position Management -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('position')">
                            <span>üíº Position Management</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="position-content" class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>Use Split Orders</label>
                                    <select id="use-split-orders">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No (Single TP)</option>
                                    </select>
                                    <small style="color: #94a3b8;">Multiple TP levels</small>
                                </div>
                                <div class="form-group">
                                    <label>Number of Positions</label>
                                    <input type="number" id="num-positions" value="3" min="1" max="5">
                                    <small style="color: #94a3b8;">Split into X positions</small>
                                </div>
                                <div class="form-group">
                                    <label>TP Level 1 (R:R)</label>
                                    <input type="number" id="tp-level-1" value="1.5" step="0.1" min="0.5" max="5">
                                </div>
                                <div class="form-group">
                                    <label>TP Level 2 (R:R)</label>
                                    <input type="number" id="tp-level-2" value="2.5" step="0.1" min="1" max="8">
                                </div>
                                <div class="form-group">
                                    <label>TP Level 3 (R:R)</label>
                                    <input type="number" id="tp-level-3" value="4.0" step="0.1" min="2" max="10">
                                </div>
                                <div class="form-group">
                                    <label>Max Lot Size Per Order</label>
                                    <input type="number" id="max-lot-per-order" value="0.5" step="0.01" min="0.01" max="10" onchange="validateMaxLotSize()">
                                    <small style="color: #94a3b8;">Maximum lot size for individual orders (broker limit)</small>
                                    <div class="validation-warning" id="max-lot-warning">‚ö†Ô∏è Large lot sizes may be rejected by broker</div>
                                    <div class="validation-error" id="max-lot-error">‚ùå Max lot size must be between 0.01 and 10</div>
                                </div>
                                <div class="form-group">
                                    <label>Max Trades Total</label>
                                    <input type="number" id="max-trades-total" value="10" min="1" max="50">
                                    <small style="color: #94a3b8;">Max open trades</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Trades Per Symbol</label>
                                    <input type="number" id="max-trades-per-symbol" value="3" min="1" max="10">
                                </div>
                                <div class="form-group">
                                    <label>Enable Trailing Stop</label>
                                    <select id="enable-trailing">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Trail Activation (ATR)</label>
                                    <input type="number" id="trail-activation" value="1.5" step="0.1" min="0.5" max="3">
                                    <small style="color: #94a3b8;">Start trailing after X*ATR profit</small>
                                </div>
                                <div class="form-group">
                                    <label>Trail Distance (ATR)</label>
                                    <input type="number" id="trail-distance" value="1.0" step="0.1" min="0.3" max="2">
                                    <small style="color: #94a3b8;">Trail X*ATR behind price</small>
                                </div>
                            </div>

                            <!-- TP Caps Section -->
                            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 8px;">
                                <h4 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <span>üéØ</span>
                                    <span>TP Caps (Symbol-Specific Limits)</span>
                                </h4>
                                <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px; margin-bottom: 15px; color: white; font-size: 13px;">
                                    <strong>üí° What is this?</strong><br>
                                    Prevents unrealistic take profit levels on volatile symbols like Gold and Silver.<br>
                                    <strong>Benefits:</strong> More realistic TPs, higher hit rate, better suited for volatile markets<br>
                                    <strong>Example:</strong> Gold TP capped at 2.0 (200 points) even if R:R ratio suggests 5.0
                                </div>
                                <div class="grid">
                                    <div class="form-group">
                                        <label style="color: white;">XAUUSD (Gold) Cap</label>
                                        <input type="number" id="tp-cap-xauusd" value="2.0" step="0.1" min="0.5" max="10">
                                        <small style="color: rgba(255,255,255,0.8);">Max TP distance (200 points)</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="color: white;">XAGUSD (Silver) Cap</label>
                                        <input type="number" id="tp-cap-xagusd" value="0.25" step="0.05" min="0.1" max="2">
                                        <small style="color: rgba(255,255,255,0.8);">Max TP distance (250 points)</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="color: white;">XPTUSD (Platinum) Cap</label>
                                        <input type="number" id="tp-cap-xptusd" value="3.0" step="0.1" min="0.5" max="10">
                                        <small style="color: rgba(255,255,255,0.8);">Max TP distance (300 points)</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="color: white;">XPDUSD (Palladium) Cap</label>
                                        <input type="number" id="tp-cap-xpdusd" value="5.0" step="0.5" min="1" max="20">
                                        <small style="color: rgba(255,255,255,0.8);">Max TP distance (500 points)</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="color: white;">DEFAULT (Forex) Cap</label>
                                        <input type="number" id="tp-cap-default" value="0.01" step="0.001" min="0.005" max="0.1">
                                        <small style="color: rgba(255,255,255,0.8);">Max TP for other symbols (~100 pips)</small>
                                    </div>
                                </div>
                                <div style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 12px;">
                                    <strong>üìä How TP Caps Work:</strong><br>
                                    ‚Ä¢ Calculates TP normally using R:R ratio<br>
                                    ‚Ä¢ If TP exceeds symbol-specific cap, applies the cap<br>
                                    ‚Ä¢ For split orders: TP1=1.0x cap, TP2=1.5x cap, TP3=2.0x cap<br>
                                    ‚Ä¢ Only affects symbols with caps defined (Forex unaffected)<br>
                                    ‚Ä¢ Set to 0 to disable cap for a specific symbol
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Management -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('risk')">
                            <span>‚ö†Ô∏è Risk Management</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="risk-content" class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>Enable Adaptive Risk</label>
                                    <select id="enable-adaptive-risk">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No (Fixed Risk)</option>
                                    </select>
                                    <small style="color: #94a3b8;">Adjusts risk based on market conditions</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Risk Multiplier</label>
                                    <input type="number" id="max-risk-multiplier" value="1.5" step="0.1" min="1" max="3">
                                    <small style="color: #94a3b8;">Max risk increase in good conditions</small>
                                </div>
                                <div class="form-group">
                                    <label>Min Risk Multiplier</label>
                                    <input type="number" id="min-risk-multiplier" value="0.5" step="0.1" min="0.1" max="1">
                                    <small style="color: #94a3b8;">Min risk in bad conditions</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Drawdown (%)</label>
                                    <input type="number" id="max-drawdown" value="10" min="5" max="30">
                                    <small style="color: #94a3b8;">Stop trading if drawdown exceeds</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Daily Trades</label>
                                    <input type="number" id="max-daily-trades" value="999" min="5" max="999">
                                    <small style="color: #94a3b8;">Limit trades per day</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Volume Analysis -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('volume')">
                            <span>üìä Volume Analysis</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="volume-content" class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>Enable Volume Filter</label>
                                    <select id="use-volume-filter">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No (Trade All Signals)</option>
                                    </select>
                                    <small style="color: #94a3b8;">Filter trades based on volume confirmation</small>
                                </div>
                                <div class="form-group">
                                    <label>Min Volume Multiplier</label>
                                    <input type="number" id="min-volume-ma" value="0.7" step="0.1" min="0.3" max="2.0">
                                    <small style="color: #94a3b8;">Volume must be X times average (0.7 = 70%, lower = more trades)</small>
                                </div>
                                <div class="form-group">
                                    <label>Volume MA Period</label>
                                    <input type="number" id="volume-ma-period" value="20" min="10" max="50">
                                    <small style="color: #94a3b8;">Periods for volume moving average</small>
                                </div>
                                <div class="form-group">
                                    <label>OBV Period</label>
                                    <input type="number" id="obv-period" value="20" min="10" max="50">
                                    <small style="color: #94a3b8;">On-Balance Volume indicator period</small>
                                </div>
                                <div class="form-group">
                                    <label>Volume Spike Threshold</label>
                                    <input type="number" id="volume-spike-threshold" value="1.5" min="1.2" max="3.0" step="0.1">
                                    <small style="color: #94a3b8;">Spike detection (X times average)</small>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                <strong style="color: #92400e;">‚ÑπÔ∏è Volume Filter Info:</strong>
                                <ul style="margin: 8px 0 0 20px; color: #78350f; font-size: 13px;">
                                    <li>Requires 2 of 3 signals: above average volume, increasing trend, or matching OBV</li>
                                    <li>Helps filter weak signals and improve trade quality</li>
                                    <li>Disable if you want to trade all technical signals</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Trend Detection -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('trend-detection')">
                            <span>üîç Advanced Trend Detection</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="trend-detection-content" class="accordion-content">
                            <!-- Main Controls -->
                            <div class="grid">
                                <div class="form-group">
                                    <label>Enable Trend Detection</label>
                                    <select id="use-trend-detection">
                                        <option value="true" selected>Yes (Advanced Analysis)</option>
                                        <option value="false">No (Basic Indicators Only)</option>
                                    </select>
                                    <small style="color: #94a3b8;">Advanced market structure and divergence analysis</small>
                                </div>
                                <div class="form-group">
                                    <label>Detection Sensitivity (1-10)</label>
                                    <input type="number" id="trend-detection-sensitivity" value="5" min="1" max="10">
                                    <small style="color: #94a3b8;">Higher = more sensitive to trend changes</small>
                                </div>
                                <div class="form-group">
                                    <label>Min Trend Confidence (%)</label>
                                    <input type="number" id="min-trend-confidence" value="60" min="20" max="90" step="5">
                                    <small style="color: #94a3b8;">Minimum confidence for trend signals</small>
                                </div>
                                <div class="form-group">
                                    <label>Enable Early Warning Signals</label>
                                    <select id="enable-early-signals">
                                        <option value="true" selected>Yes (Recommended)</option>
                                        <option value="false">No</option>
                                    </select>
                                    <small style="color: #94a3b8;">Get signals before full trend confirmation</small>
                                </div>
                            </div>
                            
                            <!-- EMA Settings -->
                            <div style="margin-top: 15px;">
                                <h4 style="color: #60a5fa; margin-bottom: 10px;">üìà EMA Momentum Analysis</h4>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>Fast EMA Period</label>
                                        <input type="number" id="ema-fast-period" value="20" min="5" max="50">
                                        <small style="color: #94a3b8;">Optimized: 10 (faster signals)</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Slow EMA Period</label>
                                        <input type="number" id="ema-slow-period" value="50" min="20" max="100">
                                        <small style="color: #94a3b8;">Optimized: 21 (balanced)</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Aroon Settings -->
                            <div style="margin-top: 15px;">
                                <h4 style="color: #60a5fa; margin-bottom: 10px;">üìä Aroon Indicator</h4>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>Aroon Period</label>
                                        <input type="number" id="aroon-period" value="25" min="14" max="50">
                                        <small style="color: #94a3b8;">Standard: 25</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Aroon Threshold</label>
                                        <input type="number" id="aroon-threshold" value="70" min="50" max="90">
                                        <small style="color: #94a3b8;">Minimum for strong trend signals</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Market Structure Settings -->
                            <div style="margin-top: 15px;">
                                <h4 style="color: #60a5fa; margin-bottom: 10px;">üèóÔ∏è Market Structure Analysis</h4>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>Min Swing Strength</label>
                                        <input type="number" id="min-swing-strength" value="3" min="2" max="10">
                                        <small style="color: #94a3b8;">Minimum bars for swing point detection</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Structure Break Threshold (%)</label>
                                        <input type="number" id="structure-break-threshold" value="0.1" min="0.05" max="0.5" step="0.05">
                                        <small style="color: #94a3b8;">Minimum % move for structure break</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Divergence Settings -->
                            <div style="margin-top: 15px;">
                                <h4 style="color: #60a5fa; margin-bottom: 10px;">üìâ Divergence Detection</h4>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>Divergence Lookback</label>
                                        <input type="number" id="divergence-lookback" value="50" min="20" max="100">
                                        <small style="color: #94a3b8;">Bars to analyze for divergences</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Min Divergence Strength</label>
                                        <input type="number" id="min-divergence-strength" value="0.3" min="0.1" max="0.8" step="0.1">
                                        <small style="color: #94a3b8;">Minimum strength to validate divergence</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trendline Settings -->
                            <div style="margin-top: 15px;">
                                <h4 style="color: #60a5fa; margin-bottom: 10px;">üìê Trendline Analysis</h4>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>Max Active Trendlines</label>
                                        <input type="number" id="max-trendlines" value="5" min="2" max="10">
                                        <small style="color: #94a3b8;">Maximum trendlines to track</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Min Trendline Touches</label>
                                        <input type="number" id="min-trendline-touches" value="2" min="2" max="5">
                                        <small style="color: #94a3b8;">Minimum touches for valid trendline</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Min Trendline Angle (¬∞)</label>
                                        <input type="number" id="trendline-angle-min" value="10" min="5" max="30">
                                        <small style="color: #94a3b8;">Minimum angle to avoid flat lines</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Max Trendline Angle (¬∞)</label>
                                        <input type="number" id="trendline-angle-max" value="80" min="60" max="85">
                                        <small style="color: #94a3b8;">Maximum angle to avoid steep lines</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Multi-Timeframe Settings -->
                            <div style="margin-top: 15px;">
                                <h4 style="color: #60a5fa; margin-bottom: 10px;">‚è∞ Multi-Timeframe Confirmation</h4>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>Enable MTF Confirmation</label>
                                        <select id="enable-mtf-confirmation">
                                            <option value="true" selected>Yes (Recommended)</option>
                                            <option value="false">No</option>
                                        </select>
                                        <small style="color: #94a3b8;">Confirm signals with higher timeframes</small>
                                    </div>
                                    <div class="form-group">
                                        <label>MTF Weight</label>
                                        <input type="number" id="mtf-weight" value="0.3" min="0.1" max="0.5" step="0.1">
                                        <small style="color: #94a3b8;">Weight of MTF confirmation in signals</small>
                                    </div>
                                    <div class="form-group">
                                        <label>MTF Alignment Threshold</label>
                                        <input type="number" id="mtf-alignment-threshold" value="0.6" min="0.3" max="0.9" step="0.1">
                                        <small style="color: #94a3b8;">Minimum alignment score for confirmation</small>
                                    </div>
                                    <div class="form-group">
                                        <label>MTF Contradiction Penalty</label>
                                        <input type="number" id="mtf-contradiction-penalty" value="0.4" min="0.1" max="0.8" step="0.1">
                                        <small style="color: #94a3b8;">Penalty for contradictory signals</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Performance Settings -->
                            <div style="margin-top: 15px;">
                                <h4 style="color: #60a5fa; margin-bottom: 10px;">‚ö° Performance Settings</h4>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>Analysis Timeout (ms)</label>
                                        <select id="max-analysis-time-ms">
                                            <option value="100">100ms (Fast - May Skip Analysis)</option>
                                            <option value="150">150ms (Balanced)</option>
                                            <option value="200">200ms (Recommended)</option>
                                            <option value="250" selected>250ms (Complete Analysis)</option>
                                            <option value="300">300ms (Comprehensive)</option>
                                            <option value="500">500ms (Maximum Detail)</option>
                                        </select>
                                        <small style="color: #94a3b8;">
                                            ‚ö†Ô∏è If seeing "skipping divergence" warnings, increase this value
                                        </small>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; padding: 10px; background: #1e293b; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                    <small style="color: #fbbf24; display: block; margin-bottom: 5px;"><strong>‚ö° Performance Guide:</strong></small>
                                    <small style="color: #94a3b8; display: block; line-height: 1.5;">
                                        ‚Ä¢ <strong>100-150ms:</strong> Fast but may skip divergence detection<br>
                                        ‚Ä¢ <strong>200-250ms:</strong> Balanced - recommended for most users<br>
                                        ‚Ä¢ <strong>300-500ms:</strong> Complete analysis, best for fewer symbols
                                    </small>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 6px; color: white;">
                                <strong style="display: block; margin-bottom: 8px;">üîç Advanced Trend Detection Features:</strong>
                                <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                                    <li>Market structure break detection (higher highs/lower lows)</li>
                                    <li>RSI and MACD divergence analysis with multi-swing validation</li>
                                    <li>Automatic trendline identification and break detection</li>
                                    <li>EMA momentum analysis with slope confirmation</li>
                                    <li>Multi-timeframe signal confirmation</li>
                                    <li>Volume pattern analysis and exhaustion detection</li>
                                    <li>Early warning signals for trend weakness</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #667eea;">
                        <strong style="color: #667eea;">üí° Tip:</strong> 
                        <span style="color: #64748b;">Start with the "Profitable Balanced" preset and adjust gradually. Test changes on demo account first!</span>
                    </div>
                    
                    <!-- ML Features Section -->
                    <div class="config-section" style="margin-top: 10px;">
                        <div class="accordion-header" onclick="toggleAccordion('ml-features')">
                            <span>ü§ñ ML & AI Features</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="ml-features-content" class="accordion-content">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="color: white; margin: 0; font-size: 0.95em;">
                                    <strong>üöÄ Advanced ML Features:</strong> Pattern recognition, sentiment analysis, and machine learning predictions to enhance trading signals.
                                </p>
                            </div>
                            
                            <!-- Enable/Disable ML Features -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #60a5fa; margin-bottom: 15px;">üéØ Feature Toggles</h4>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="pattern_enabled" name="pattern_enabled">
                                            üìä Pattern Recognition
                                        </label>
                                        <small style="color: #64748b; display: block; margin-top: 5px;">
                                            Detects chart patterns (double tops, triangles, etc.)
                                        </small>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="sentiment_enabled" name="sentiment_enabled">
                                            üì∞ Sentiment Analysis
                                        </label>
                                        <small style="color: #64748b; display: block; margin-top: 5px;">
                                            Analyzes market sentiment from news
                                        </small>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="ml_enabled" name="ml_enabled">
                                            üß† ML Predictions
                                        </label>
                                        <small style="color: #64748b; display: block; margin-top: 5px;">
                                            XGBoost model predictions (requires training)
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Signal Weights -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #60a5fa; margin-bottom: 15px;">‚öñÔ∏è Signal Weights</h4>
                                <p style="color: #94a3b8; font-size: 0.9em; margin-bottom: 10px;">
                                    Adjust how much each signal type influences trading decisions (weights are auto-normalized)
                                </p>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                    <div class="form-group">
                                        <label for="technical_weight">Technical Analysis</label>
                                        <input type="number" id="technical_weight" name="technical_weight" 
                                               min="0" max="1" step="0.05" value="0.4">
                                        <small style="color: #64748b;">Default: 0.4 (40%)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="ml_weight">ML Predictions</label>
                                        <input type="number" id="ml_weight" name="ml_weight" 
                                               min="0" max="1" step="0.05" value="0.3">
                                        <small style="color: #64748b;">Default: 0.3 (30%)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="sentiment_weight">Sentiment</label>
                                        <input type="number" id="sentiment_weight" name="sentiment_weight" 
                                               min="0" max="1" step="0.05" value="0.15">
                                        <small style="color: #64748b;">Default: 0.15 (15%)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="pattern_weight">Patterns</label>
                                        <input type="number" id="pattern_weight" name="pattern_weight" 
                                               min="0" max="1" step="0.05" value="0.15">
                                        <small style="color: #64748b;">Default: 0.15 (15%)</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ML Configuration -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #60a5fa; margin-bottom: 15px;">üîß ML Configuration</h4>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                                    <div class="form-group">
                                        <label for="ml_min_confidence">Minimum Confidence</label>
                                        <input type="number" id="ml_min_confidence" name="ml_min_confidence" 
                                               min="0" max="1" step="0.05" value="0.6">
                                        <small style="color: #64748b;">Minimum confidence to trade (0.6 = 60%)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="ml_require_agreement">Require Agreement</label>
                                        <select id="ml_require_agreement" name="ml_require_agreement">
                                            <option value="2">2+ components must agree</option>
                                            <option value="3">3+ components must agree</option>
                                            <option value="all">All components must agree</option>
                                        </select>
                                        <small style="color: #64748b;">Signal agreement requirement</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Paths -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #60a5fa; margin-bottom: 15px;">üìÅ Data Paths</h4>
                                <div class="grid" style="grid-template-columns: 1fr;">
                                    <div class="form-group">
                                        <label for="ml_model_path">ML Model Path</label>
                                        <input type="text" id="ml_model_path" name="ml_model_path" 
                                               value="models/ml_signal_model.pkl" placeholder="models/ml_signal_model.pkl">
                                        <small style="color: #64748b;">Path to trained ML model file</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="ml_training_data_path">Training Data Path</label>
                                        <input type="text" id="ml_training_data_path" name="ml_training_data_path" 
                                               value="data/training_data.csv" placeholder="data/training_data.csv">
                                        <small style="color: #64748b;">Path to historical training data</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="news_data_path">News Data Path (Optional)</label>
                                        <input type="text" id="news_data_path" name="news_data_path" 
                                               value="" placeholder="data/news_headlines.json">
                                        <small style="color: #64748b;">Path to news data for sentiment analysis</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ML Training Options -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #60a5fa; margin-bottom: 15px;">üéì Training Options</h4>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="ml_auto_retrain" name="ml_auto_retrain">
                                            üîÑ Auto-Retrain Model
                                        </label>
                                        <small style="color: #64748b; display: block; margin-top: 5px;">
                                            Automatically retrain model with new data
                                        </small>
                                    </div>
                                    <div class="form-group">
                                        <label for="ml_retrain_frequency">Retrain Frequency</label>
                                        <select id="ml_retrain_frequency" name="ml_retrain_frequency">
                                            <option value="daily">Daily</option>
                                            <option value="weekly" selected>Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                        <small style="color: #64748b;">How often to retrain</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="ml_min_training_samples">Min Training Samples</label>
                                        <input type="number" id="ml_min_training_samples" name="ml_min_training_samples" 
                                               min="50" max="1000" step="10" value="100">
                                        <small style="color: #64748b;">Minimum samples needed to train</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pattern Recognition Settings -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #60a5fa; margin-bottom: 15px;">üìä Pattern Recognition Settings</h4>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                    <div class="form-group">
                                        <label for="pattern_min_confidence">Pattern Min Confidence</label>
                                        <input type="number" id="pattern_min_confidence" name="pattern_min_confidence" 
                                               min="0" max="1" step="0.05" value="0.6">
                                        <small style="color: #64748b;">Minimum pattern confidence</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="pattern_lookback">Pattern Lookback</label>
                                        <input type="number" id="pattern_lookback" name="pattern_lookback" 
                                               min="10" max="100" step="5" value="30">
                                        <small style="color: #64748b;">Bars to analyze for patterns</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sentiment Analysis Settings -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #60a5fa; margin-bottom: 15px;">üì∞ Sentiment Analysis Settings</h4>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                    <div class="form-group">
                                        <label for="sentiment_cache_duration">Cache Duration (hours)</label>
                                        <input type="number" id="sentiment_cache_duration" name="sentiment_cache_duration" 
                                               min="0.5" max="24" step="0.5" value="1">
                                        <small style="color: #64748b;">How long to cache sentiment data</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="sentiment_min_confidence">Min Confidence</label>
                                        <input type="number" id="sentiment_min_confidence" name="sentiment_min_confidence" 
                                               min="0" max="1" step="0.05" value="0.5">
                                        <small style="color: #64748b;">Minimum sentiment confidence</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ML Status & Actions -->
                            <div style="background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #334155;">
                                <h4 style="color: #60a5fa; margin-bottom: 15px;">üìä ML Status & Actions</h4>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                    <button type="button" class="btn btn-primary" onclick="trainMLModel()" style="width: 100%;">
                                        üéì Train ML Model
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="testMLFeatures()" style="width: 100%;">
                                        üß™ Test ML Features
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="viewMLStats()" style="width: 100%;">
                                        üìà View ML Statistics
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="exportMLData()" style="width: 100%;">
                                        üíæ Export Training Data
                                    </button>
                                </div>
                                <div id="ml-status-display" style="margin-top: 15px; padding: 10px; background: #1e293b; border-radius: 5px; display: none;">
                                    <p style="margin: 0; color: #94a3b8;" id="ml-status-text"></p>
                                </div>
                            </div>
                            
                            <!-- Quick Start Guide -->
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <h4 style="color: white; margin-bottom: 10px;">üöÄ Quick Start Guide</h4>
                                <ol style="color: white; margin: 0; padding-left: 20px; font-size: 0.9em;">
                                    <li style="margin-bottom: 5px;"><strong>Start with Pattern Recognition:</strong> Enable it first, set weight to 0.2-0.3</li>
                                    <li style="margin-bottom: 5px;"><strong>Add Sentiment (Optional):</strong> If you have news data, enable sentiment analysis</li>
                                    <li style="margin-bottom: 5px;"><strong>Collect Data:</strong> Run bot for 1-2 weeks to collect training data</li>
                                    <li style="margin-bottom: 5px;"><strong>Train ML Model:</strong> Click "Train ML Model" after collecting 100+ trades</li>
                                    <li style="margin-bottom: 5px;"><strong>Enable ML:</strong> Once trained, enable ML predictions</li>
                                    <li><strong>Monitor & Adjust:</strong> Track performance and adjust weights accordingly</li>
                                </ol>
                            </div>
                            
                            <!-- Warning -->
                            <div style="background: #7c2d12; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ef4444;">
                                <p style="color: #fecaca; margin: 0; font-size: 0.9em;">
                                    <strong>‚ö†Ô∏è Important:</strong> ML features require installation of additional dependencies. 
                                    Run <code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">python install_ml_features.py</code> first.
                                    Test on demo account before using on live trading!
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Hour-Based Trading Filter -->
                    <div class="config-section" style="margin-top: 20px;">
                        <div class="accordion-header" onclick="toggleAccordion('hour-filter')">
                            <span>üïê Hour-Based Trading Filter</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="hour-filter-content" class="accordion-content">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enable-hour-filter" checked>
                                    Enable Hour-Based Filter
                                </label>
                                <small style="color: #94a3b8; display: block; margin-top: 5px;">
                                    Filter trades based on historical performance by hour (UTC)
                                </small>
                            </div>
                            
                            <div class="grid">
                                <div class="form-group">
                                    <label>Golden Hours (Profitable)</label>
                                    <input type="text" id="golden-hours" value="8,11,13,14,15,19,23" placeholder="8,11,13,14,15,19,23">
                                    <small style="color: #94a3b8;">Comma-separated hours (UTC)</small>
                                </div>
                                <div class="form-group">
                                    <label>Dead Hours (Avoid Trading)</label>
                                    <input type="text" id="dead-hours" value="0,1,2,17,20,21,22" placeholder="0,1,2,17,20,21,22">
                                    <small style="color: #94a3b8;">Comma-separated hours (UTC)</small>
                                </div>
                                <div class="form-group">
                                    <label>ROC Threshold (%)</label>
                                    <input type="number" id="roc-threshold" value="0.15" min="0.05" max="1.0" step="0.05">
                                    <small style="color: #94a3b8;">Rate of change threshold</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time-Based Exit Settings -->
                    <div class="config-section" style="margin-top: 20px;">
                        <div class="accordion-header" onclick="toggleAccordion('time-exit')">
                            <span>‚è±Ô∏è Time-Based Exit</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="time-exit-content" class="accordion-content">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enable-time-based-exit">
                                    Enable Time-Based Exit
                                </label>
                                <small style="color: #94a3b8; display: block; margin-top: 5px;">
                                    Automatically close positions after max hold time
                                </small>
                            </div>
                            
                            <div class="grid">
                                <div class="form-group">
                                    <label>Max Hold Time (Minutes)</label>
                                    <input type="number" id="max-hold-minutes" value="45" min="5" max="240" step="5">
                                    <small style="color: #94a3b8;">Maximum time to hold position</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Breakeven Stop Settings -->
                    <div class="config-section" style="margin-top: 20px;">
                        <div class="accordion-header" onclick="toggleAccordion('breakeven')">
                            <span>üéØ Breakeven Stop</span>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div id="breakeven-content" class="accordion-content">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enable-breakeven-stop" checked>
                                    Enable Breakeven Stop
                                </label>
                                <small style="color: #94a3b8; display: block; margin-top: 5px;">
                                    Move SL to entry once profitable
                                </small>
                            </div>
                            
                            <div class="grid">
                                <div class="form-group">
                                    <label>Breakeven ATR Threshold</label>
                                    <input type="number" id="breakeven-atr-threshold" value="0.3" min="0.1" max="2.0" step="0.1">
                                    <small style="color: #94a3b8;">ATR multiplier to trigger (0.3 = 30%)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-secondary" id="save-config-btn" style="margin-top: 20px;">üíæ Save Configuration</button>
                </form>
            </div>
            
            <!-- Trend Detection Tab -->
            <div id="trend-detection-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üîç Advanced Trend Detection</h2>
                    <button class="btn btn-secondary" onclick="refreshTrendDetection(event)" title="Refresh Trend Analysis">üîÑ</button>
                </div>
                
                <!-- Status Overview -->
                <div class="grid" style="margin-bottom: 30px;">
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">System Status</h3>
                        <div class="stat">
                            <span class="stat-label">Trend Detection</span>
                            <span class="stat-value" id="trend-detection-enabled">
                                <span class="status-indicator stopped"></span>
                                Loading...
                            </span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Sensitivity Level</span>
                            <span class="stat-value" id="trend-sensitivity-level">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Min Confidence</span>
                            <span class="stat-value" id="trend-min-confidence">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Early Signals</span>
                            <span class="stat-value" id="trend-early-signals">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">MTF Confirmation</span>
                            <span class="stat-value" id="trend-mtf-confirmation">-</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Signal Summary</h3>
                        <div class="stat">
                            <span class="stat-label">Active Signals</span>
                            <span class="stat-value" id="active-signals-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Bullish Signals</span>
                            <span class="stat-value positive" id="bullish-signals-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Bearish Signals</span>
                            <span class="stat-value negative" id="bearish-signals-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Early Warnings</span>
                            <span class="stat-value" id="early-warnings-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Last Update</span>
                            <span class="stat-value" id="trend-last-update">Never</span>
                        </div>
                    </div>
                </div>
                
                <!-- Symbol Analysis -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">Symbol Analysis</h3>
                    <div id="symbol-analysis-container">
                        <div class="loading">Loading trend analysis...</div>
                    </div>
                </div>
                
                <!-- Market Structure Analysis -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">Market Structure Analysis</h3>
                    <div id="market-structure-container">
                        <div class="loading">Loading market structure analysis...</div>
                    </div>
                </div>
                
                <!-- Multi-Timeframe Alignment -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">Multi-Timeframe Alignment</h3>
                    <div id="mtf-alignment-container">
                        <div class="loading">Loading multi-timeframe analysis...</div>
                    </div>
                </div>
                
                <!-- Volume Analysis -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">Volume Analysis</h3>
                    <div id="volume-analysis-container">
                        <div class="loading">Loading volume analysis...</div>
                    </div>
                </div>
                
                <!-- Divergence Detection -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">Divergence Detection</h3>
                    <div id="divergence-analysis-container">
                        <div class="loading">Loading divergence analysis...</div>
                    </div>
                </div>
            </div>
            
            <!-- Charts & Analytics Tab -->
            <div id="charts-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Charts & Analytics</h2>
                    <button class="btn btn-secondary" onclick="refreshCharts(event)" title="Refresh Charts">üîÑ</button>
                </div>
                
                <!-- Date Range Filter for Charts -->
                <div style="margin-bottom: 20px; padding: 15px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <label style="margin-bottom: 5px;">Chart Date Range</label>
                            <select id="chart-date-range" onchange="applyChartDateRange()" style="padding: 8px;">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="last7days" selected>Last 7 Days</option>
                                <option value="last30days">Last 30 Days</option>
                                <option value="thisweek">This Week</option>
                                <option value="lastweek">Last Week</option>
                                <option value="thismonth">This Month</option>
                                <option value="lastmonth">Last Month</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="applyChartDateRange()" style="padding: 8px 16px;">Apply</button>
                        </div>
                    </div>
                </div>
                
                <div class="grid" style="margin-bottom: 30px;">
                    <!-- Profit by Symbol Chart -->
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Profit by Symbol</h3>
                        <canvas id="symbol-profit-chart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Win/Loss by Symbol Chart -->
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Win/Loss by Symbol</h3>
                        <canvas id="symbol-winloss-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                
                <div class="grid" style="margin-bottom: 30px;">
                    <!-- Daily Profit Trend -->
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Daily Profit Trend (Last 7 Days)</h3>
                        <canvas id="daily-profit-chart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Hourly Performance -->
                    <div class="card">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Hourly Performance</h3>
                        <canvas id="hourly-profit-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">Trade Distribution</h3>
                    <canvas id="trade-distribution-chart" style="max-height: 400px;"></canvas>
                </div>
            </div>
            
            <!-- Trade History Tab -->
            <div id="trades-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Trade History</h2>
                    <button class="btn btn-secondary" onclick="refreshTrades(event)" title="Refresh Trades">üîÑ</button>
                </div>
                
                <!-- Win Rate Statistics -->
                <div class="grid" style="margin-bottom: 20px;">
                    <div class="card" style="padding: 15px;">
                        <h3 style="color: #60a5fa; margin-bottom: 10px; font-size: 1em;">Overall Win Rate</h3>
                        <div style="font-size: 2em; font-weight: bold;" id="overall-win-rate">0%</div>
                        <div style="color: #94a3b8; font-size: 0.9em;" id="overall-trades-count">0 trades</div>
                    </div>
                    <div class="card" style="padding: 15px;">
                        <h3 style="color: #60a5fa; margin-bottom: 10px; font-size: 1em;">Today's Win Rate</h3>
                        <div style="font-size: 2em; font-weight: bold;" id="today-win-rate">0%</div>
                        <div style="color: #94a3b8; font-size: 0.9em;" id="today-trades-count">0 trades</div>
                    </div>
                    <div class="card" style="padding: 15px;">
                        <h3 style="color: #60a5fa; margin-bottom: 10px; font-size: 1em;">Last 7 Days Win Rate</h3>
                        <div style="font-size: 2em; font-weight: bold;" id="week-win-rate">0%</div>
                        <div style="color: #94a3b8; font-size: 0.9em;" id="week-trades-count">0 trades</div>
                    </div>
                </div>
                
                <!-- Filters and Sorting -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="margin-bottom: 5px;">Date Range</label>
                        <select id="date-range" onchange="applySortFilter()" style="padding: 8px;">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="last7days" selected>Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                            <option value="thisweek">This Week</option>
                            <option value="lastweek">Last Week</option>
                            <option value="thismonth">This Month</option>
                            <option value="lastmonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-date-from" style="margin-bottom: 0; min-width: 150px; display: none;">
                        <label style="margin-bottom: 5px;">From Date</label>
                        <input type="date" id="date-from" onchange="applySortFilter()" style="padding: 8px;">
                    </div>
                    
                    <div class="form-group" id="custom-date-to" style="margin-bottom: 0; min-width: 150px; display: none;">
                        <label style="margin-bottom: 5px;">To Date</label>
                        <input type="date" id="date-to" onchange="applySortFilter()" style="padding: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="margin-bottom: 5px;">Sort By</label>
                        <select id="sort-by" onchange="applySortFilter()" style="padding: 8px;">
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="profit-desc">Profit (Highest First)</option>
                            <option value="profit-asc">Profit (Lowest First)</option>
                            <option value="amount-desc">Amount (Highest First)</option>
                            <option value="amount-asc">Amount (Lowest First)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="margin-bottom: 5px;">Filter</label>
                        <select id="filter-by" onchange="applySortFilter()" style="padding: 8px;">
                            <option value="all">All Trades</option>
                            <option value="wins">Wins Only</option>
                            <option value="losses">Losses Only</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="margin-bottom: 5px;">Symbol</label>
                        <select id="filter-symbol" onchange="applySortFilter()" style="padding: 8px;">
                            <option value="all">All Symbols</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn btn-secondary" onclick="resetFilters()" style="padding: 8px 16px;">Reset</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="trades-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Volume</th>
                                <th>Open Price</th>
                                <th>Close Price</th>
                                <th>Pips</th>
                                <th>Profit</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body">
                            <tr><td colspan="8" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Open Positions Tab -->
            <div id="positions-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Open Positions</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="positions-last-update" style="color: #94a3b8; font-size: 0.9em;">Last updated: Never</span>
                        <button class="btn btn-secondary" onclick="refreshPositions(event)" title="Refresh Positions">üîÑ</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="positions-table">
                        <thead>
                            <tr>
                                <th>Ticket</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Volume</th>
                                <th>Entry</th>
                                <th>Current</th>
                                <th>SL</th>
                                <th>TP</th>
                                <th>Profit</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body">
                            <tr><td colspan="10" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">AI Recommendations</h2>
                    <button class="btn btn-secondary" onclick="refreshRecommendations(event)" title="Refresh Recommendations">üîÑ</button>
                </div>
                <div id="recommendations-container">
                    <div class="loading">Loading recommendations...</div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <h2>System Logs & Diagnostics</h2>
                
                <!-- Logging Level Controls -->
                <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); border-radius: 8px;">
                    <label style="color: white; font-weight: 600; margin-bottom: 10px; display: block;">‚öôÔ∏è Logging Level Controls</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 5px; display: block;">Current Logging Level</label>
                            <select id="logging_level" style="width: 100%; padding: 8px; border-radius: 5px; border: none;">
                                <option value="minimal">Minimal (Errors only)</option>
                                <option value="standard" selected>Standard (Basic info)</option>
                                <option value="detailed">Detailed (Full analysis)</option>
                                <option value="debug">Debug (Everything)</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 5px; display: block;">Performance Impact</label>
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; font-size: 12px;">
                                <strong>Minimal:</strong> Fastest<br>
                                <strong>Standard:</strong> Balanced<br>
                                <strong>Detailed:</strong> Full indicators<br>
                                <strong>Debug:</strong> Maximum detail
                            </div>
                        </div>
                        <div>
                            <label style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 5px; display: block;">Actions</label>
                            <button type="button" class="btn btn-primary" onclick="updateLoggingLevel()" style="width: 100%; padding: 8px 16px; font-size: 14px; margin-bottom: 5px;">
                                Apply Logging Level
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="refreshLogs()" style="width: 100%; padding: 6px 12px; font-size: 12px;">
                                üîÑ Refresh Logs
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 12px; color: rgba(255,255,255,0.8);">
                        <strong>üí° Tip:</strong> Change logging level to see more or less detail in the logs below. Higher levels show more information but may impact performance.
                    </div>
                </div>
                
                <!-- MT5 Connection Status -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">üîå MT5 Connection Status</h3>
                    <div id="mt5-diagnostics" style="font-family: 'Courier New', monospace; font-size: 0.9em;">
                        <div style="padding: 10px; background: #1e293b; border-radius: 5px; margin-bottom: 10px;">
                            <strong>Status:</strong> <span id="mt5-status-text">Checking...</span>
                        </div>
                        <div style="padding: 10px; background: #1e293b; border-radius: 5px; margin-bottom: 10px;">
                            <strong>Build:</strong> <span id="mt5-build">-</span>
                        </div>
                        <div style="padding: 10px; background: #1e293b; border-radius: 5px; margin-bottom: 10px;">
                            <strong>Account:</strong> <span id="mt5-account">-</span>
                        </div>
                        <div style="padding: 10px; background: #1e293b; border-radius: 5px;">
                            <strong>Last Check:</strong> <span id="mt5-last-check">-</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="checkMT5Diagnostics()" style="margin-top: 15px;">üîÑ Check MT5 Connection</button>
                </div>
                
                <!-- Debug Information -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">üêõ Debug Information</h3>
                    <div id="debug-info" style="font-family: 'Courier New', monospace; font-size: 0.85em; background: #1e293b; padding: 15px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                        <div><strong>Bot Running:</strong> <span id="debug-bot-running">-</span></div>
                        <div><strong>Symbols Configured:</strong> <span id="debug-symbols">-</span></div>
                        <div><strong>Timeframe:</strong> <span id="debug-timeframe">-</span></div>
                        <div><strong>Min Confidence:</strong> <span id="debug-confidence">-</span></div>
                        <div><strong>Volume Filter:</strong> <span id="debug-volume-filter">-</span></div>
                        <div><strong>Last Analysis:</strong> <span id="debug-last-analysis">-</span></div>
                    </div>
                </div>
                
                <!-- Log Filters -->
                <div style="margin-bottom: 15px; padding: 15px; background: #1e293b; border-radius: 8px;">
                    <strong style="color: #94a3b8; margin-right: 15px;">Filter Logs:</strong>
                    <label style="margin-right: 15px; color: #94a3b8;">
                        <input type="checkbox" id="filter-errors" checked onchange="filterLogs()"> Errors
                    </label>
                    <label style="margin-right: 15px; color: #94a3b8;">
                        <input type="checkbox" id="filter-warnings" checked onchange="filterLogs()"> Warnings
                    </label>
                    <label style="margin-right: 15px; color: #94a3b8;">
                        <input type="checkbox" id="filter-info" checked onchange="filterLogs()"> Info
                    </label>
                    <label style="margin-right: 15px; color: #94a3b8;">
                        <input type="checkbox" id="filter-debug" onchange="filterLogs()"> Debug
                    </label>
                    <label style="color: #94a3b8;">
                        <input type="checkbox" id="filter-signals" checked onchange="filterLogs()"> Signals Only
                    </label>
                </div>
                
                <!-- Log Actions -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="loadLogs()">üîÑ Refresh Logs</button>
                    <button class="btn btn-secondary" onclick="downloadLogs()">üíæ Download Logs</button>
                    <button class="btn btn-secondary" onclick="clearLogsDisplay()">üóëÔ∏è Clear Display</button>
                    <select id="log-lines" onchange="loadLogs()" style="padding: 10px; border-radius: 5px; background: #1e293b; color: white; border: 1px solid #334155; cursor: pointer;">
                        <option value="50">Last 50 lines</option>
                        <option value="100" selected>Last 100 lines</option>
                        <option value="200">Last 200 lines</option>
                        <option value="500">Last 500 lines</option>
                    </select>
                </div>
                
                <!-- Logs Display -->
                <div id="logs-container" style="background: #0f172a; padding: 20px; border-radius: 8px; max-height: 600px; overflow-y: scroll; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.9em; border: 1px solid #334155;">
                    <pre id="logs-content" style="margin: 0; color: #94a3b8; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">Loading logs...</pre>
                </div>
                
                <!-- Help Text -->
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 8px;">
                    <strong style="color: white; display: block; margin-bottom: 10px;">üí° Understanding Logs</strong>
                    <ul style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px; font-size: 0.9em;">
                        <li><strong>ERROR</strong> - Critical issues (MT5 connection failed, etc.)</li>
                        <li><strong>WARNING</strong> - Important notices (trade rejected, etc.)</li>
                        <li><strong>INFO</strong> - Normal operations (bot started, signal detected)</li>
                        <li><strong>DEBUG</strong> - Detailed analysis (every check, filter result)</li>
                        <li><strong>‚úì</strong> - Filter passed</li>
                        <li><strong>‚úó</strong> - Filter rejected (this is normal!)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Disclaimer Modal -->
    <div class="modal" id="disclaimer-modal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Risk Warning & Disclaimer</h2>
            
            <div class="warning-box">
                <strong>IMPORTANT: Trading involves substantial risk of loss</strong>
            </div>
            
            <p>Before using GEM Trading Bot, please read and understand the following:</p>
            
            <ul>
                <li><strong>Risk of Loss:</strong> Trading forex, gold, and other instruments carries a high level of risk and may not be suitable for all investors. You could lose some or all of your invested capital.</li>
                
                <li><strong>No Guarantee:</strong> Past performance is not indicative of future results. This bot does not guarantee profits.</li>
                
                <li><strong>Automated Trading:</strong> This bot makes automated trading decisions. Always monitor your account and understand the risks.</li>
                
                <li><strong>Test First:</strong> Always test on a demo account before using real money.</li>
                
                <li><strong>Your Responsibility:</strong> You are solely responsible for your trading decisions and any losses incurred.</li>
                
                <li><strong>Market Conditions:</strong> Market conditions can change rapidly. The bot may not perform well in all market conditions.</li>
            </ul>
            
            <div class="info-box">
                <strong>Recommendations:</strong>
                <ul style="margin-top: 10px;">
                    <li>Start with conservative settings (Risk ‚â§ 0.5%)</li>
                    <li>Use proper risk management</li>
                    <li>Never risk more than you can afford to lose</li>
                    <li>Monitor your account regularly</li>
                    <li>Test thoroughly on demo first</li>
                </ul>
            </div>
            
            <p style="margin-top: 20px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="accept-disclaimer" style="width: auto; margin-right: 10px;">
                    <span>I understand and accept the risks involved in automated trading</span>
                </label>
            </p>
            
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="acceptDisclaimer()" id="accept-btn" disabled>I Understand - Continue</button>
                <button class="btn btn-danger" onclick="window.close()">Exit</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <script>
        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        

        // Logging Level Control
        function updateLoggingLevel() {
            const level = document.getElementById('logging_level').value;
            
            fetch('/api/logging/level', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({level: level})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('‚úÖ Logging level updated to: ' + level.toUpperCase(), 'success');
                } else {
                    showToast('‚ùå Failed to update logging level: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showToast('‚ùå Error updating logging level: ' + error, 'error');
            });
        }
        
        // Refresh Logs Function
        function refreshLogs() {
            // Refresh the logs display
            if (typeof loadLogs === 'function') {
                loadLogs();
                showToast('üîÑ Logs refreshed', 'info');
            } else {
                // Fallback: reload the logs section
                location.reload();
            }
        }
        
        // Disclaimer Modal
        window.addEventListener('load', function() {
            const disclaimerAccepted = localStorage.getItem('disclaimerAccepted');
            if (!disclaimerAccepted) {
                document.getElementById('disclaimer-modal').classList.add('active');
            }
        });
        
        document.getElementById('accept-disclaimer').addEventListener('change', function() {
            document.getElementById('accept-btn').disabled = !this.checked;
        });
        
        function acceptDisclaimer() {
            localStorage.setItem('disclaimerAccepted', 'true');
            document.getElementById('disclaimer-modal').classList.remove('active');
            showToast('Welcome to GEM Trading! Please configure your settings.', 'success');
        }
        
        // Symbol Selection Helper Functions
        function selectSymbolGroup(group) {
            const symbolSelect = document.getElementById('symbols');
            const options = symbolSelect.options;
            
            // Define symbol groups
            const metals = ['XAUUSD', 'XAGUSD', 'XPTUSD', 'XPDUSD'];
            const forexMajors = ['EURUSD', 'GBPUSD', 'USDJPY', 'USDCHF', 'AUDUSD', 'USDCAD', 'NZDUSD'];
            const forexCrosses = ['EURJPY', 'GBPJPY', 'EURGBP', 'EURAUD', 'EURCAD', 'GBPAUD', 'GBPCAD'];
            const energy = ['XTIUSD', 'XBRUSD', 'XNGUSD'];
            const indices = ['US30', 'US500', 'NAS100', 'UK100', 'GER40', 'FRA40', 'JPN225', 'AUS200'];
            const crypto = ['BTCUSD', 'ETHUSD', 'LTCUSD', 'XRPUSD', 'BCHUSD', 'ADAUSD', 'DOTUSD', 'LINKUSD', 'XLMUSD', 'UNIUSD', 'SOLUSD', 'MATICUSD', 'AVAXUSD', 'DOGEUSD', 'SHIBUSD'];
            
            // Clear all selections first
            for (let i = 0; i < options.length; i++) {
                options[i].selected = false;
            }
            
            // Select based on group
            if (group === 'metals') {
                // Select only metals
                for (let i = 0; i < options.length; i++) {
                    if (metals.includes(options[i].value)) {
                        options[i].selected = true;
                    }
                }
                showToast('‚úÖ Metals selected (Conservative)', 'success');
            } else if (group === 'forex') {
                // Select metals + forex majors
                for (let i = 0; i < options.length; i++) {
                    if (metals.includes(options[i].value) || forexMajors.includes(options[i].value)) {
                        options[i].selected = true;
                    }
                }
                showToast('‚úÖ Metals + Forex Majors selected (Balanced)', 'success');
            } else if (group === 'crypto') {
                // Select major cryptocurrencies
                for (let i = 0; i < options.length; i++) {
                    if (crypto.includes(options[i].value)) {
                        options[i].selected = true;
                    }
                }
                showToast('‚úÖ Cryptocurrencies selected (High Volatility)', 'warning');
            } else if (group === 'all') {
                // Select all
                for (let i = 0; i < options.length; i++) {
                    options[i].selected = true;
                }
                showToast('‚úÖ All symbols selected (Advanced)', 'success');
            } else if (group === 'none') {
                // Already cleared above
                showToast('‚úÖ All symbols cleared', 'success');
            }
        }
        
        // Symbol Data Availability Checker
        async function checkSymbolDataAvailability() {
            const button = event.target;
            const statusDiv = document.getElementById('symbol-data-status');
            const selectedSymbols = Array.from(document.getElementById('symbols').selectedOptions).map(o => o.value);
            const analysisBars = parseInt(document.getElementById('analysis-bars').value);
            const timeframe = parseInt(document.getElementById('timeframe').value);
            
            if (selectedSymbols.length === 0) {
                statusDiv.innerHTML = '<div style="color: #f59e0b; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 4px;">‚ö†Ô∏è Please select symbols first</div>';
                statusDiv.style.display = 'block';
                return;
            }
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Checking...';
            statusDiv.innerHTML = '<div style="color: #6366f1; padding: 8px;">üîç Checking data availability for ' + selectedSymbols.length + ' symbols...</div>';
            statusDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/symbols/data-availability', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: selectedSymbols,
                        bars: analysisBars,
                        timeframe: timeframe
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    let html = '<div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 6px; padding: 10px; margin-top: 8px;">';
                    html += '<div style="color: #10b981; font-weight: 600; margin-bottom: 8px;">üìä Data Availability Results:</div>';
                    
                    // Summary
                    const available = data.results.filter(r => r.available).length;
                    const total = data.results.length;
                    html += `<div style="margin-bottom: 10px; color: #374151;"><strong>Summary:</strong> ${available}/${total} symbols have sufficient data</div>`;
                    
                    // Individual results
                    html += '<div style="display: grid; gap: 6px;">';
                    data.results.forEach(result => {
                        const statusColor = result.available ? '#10b981' : '#ef4444';
                        const statusIcon = result.available ? '‚úÖ' : '‚ùå';
                        const statusText = result.available ? 'Available' : 'Insufficient';
                        
                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px; background: rgba(255,255,255,0.5); border-radius: 4px;">`;
                        html += `<span style="font-weight: 500;">${result.symbol}</span>`;
                        html += `<span style="color: ${statusColor};">${statusIcon} ${result.bars_available}/${analysisBars} bars ${statusText}</span>`;
                        html += `</div>`;
                    });
                    html += '</div>';
                    
                    // Recommendations
                    const insufficient = data.results.filter(r => !r.available);
                    if (insufficient.length > 0) {
                        html += '<div style="margin-top: 10px; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 4px; color: #92400e;">';
                        html += '<strong>üí° Recommendations:</strong><br>';
                        html += `‚Ä¢ Reduce analysis bars to ${Math.min(...insufficient.map(r => r.bars_available))} or less<br>`;
                        html += '‚Ä¢ Or remove symbols with insufficient data<br>';
                        html += '‚Ä¢ Consider using higher timeframes for more historical data';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    statusDiv.innerHTML = html;
                } else {
                    statusDiv.innerHTML = `<div style="color: #ef4444; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">‚ùå Error: ${data.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<div style="color: #ef4444; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">‚ùå Failed to check data availability. Make sure MT5 is connected.</div>';
            } finally {
                button.disabled = false;
                button.innerHTML = 'üîç Check Symbol Data Availability';
            }
        }
        
        // Validation Functions
        function validateRisk() {
            const risk = parseFloat(document.getElementById('risk-percent').value);
            const warning = document.getElementById('risk-warning');
            const error = document.getElementById('risk-error');
            
            error.style.display = 'none';
            warning.style.display = 'none';
            
            if (risk < 0.1 || risk > 5) {
                error.style.display = 'block';
                return false;
            } else if (risk > 1) {
                warning.style.display = 'block';
            }
            return true;
        }
        
        function validateConfidence() {
            const confidence = parseFloat(document.getElementById('min-confidence').value);
            const warning = document.getElementById('confidence-warning');
            
            warning.style.display = 'none';
            
            if (confidence < 30) {
                warning.style.display = 'block';
            }
            return true;
        }
        
        function validateDailyLoss() {
            const loss = parseFloat(document.getElementById('max-daily-loss').value);
            const warning = document.getElementById('daily-loss-warning');
            
            warning.style.display = 'none';
            
            if (loss > 10) {
                warning.style.display = 'block';
            }
            return true;
        }
        
        function validateMaxLotSize() {
            const maxLot = parseFloat(document.getElementById('max-lot-per-order').value);
            const warning = document.getElementById('max-lot-warning');
            const error = document.getElementById('max-lot-error');
            
            error.style.display = 'none';
            warning.style.display = 'none';
            
            if (maxLot < 0.01 || maxLot > 10) {
                error.style.display = 'block';
                return false;
            } else if (maxLot > 2) {
                warning.style.display = 'block';
            }
            return true;
        }
        
        // TP/SL Method Validation
        function updateTPSLMethodWarning() {
            const usePipSL = document.getElementById('use-pip-based-sl').value === 'true';
            const usePipTP = document.getElementById('use-pip-based-tp').value === 'true';
            const warning = document.getElementById('tpsl-method-warning');
            const ok = document.getElementById('tpsl-method-ok');
            const description = document.getElementById('tpsl-method-description');
            const slPipsGroup = document.getElementById('sl-pips-group');
            const tpPipsGroup = document.getElementById('tp-pips-group');
            
            // Show/hide pip input fields
            slPipsGroup.style.display = usePipSL ? 'block' : 'none';
            tpPipsGroup.style.display = usePipTP ? 'block' : 'none';
            
            // Check consistency
            if (usePipSL !== usePipTP) {
                warning.style.display = 'block';
                ok.style.display = 'none';
            } else {
                warning.style.display = 'none';
                ok.style.display = 'block';
                
                if (usePipSL && usePipTP) {
                    const slPips = parseInt(document.getElementById('sl-pips').value) || 50;
                    const tpPips = parseInt(document.getElementById('tp-pips').value) || 100;
                    const tpLevels = [
                        parseFloat(document.getElementById('tp-level-1').value) || 1.5,
                        parseFloat(document.getElementById('tp-level-2').value) || 2.5,
                        parseFloat(document.getElementById('tp-level-3').value) || 4.0
                    ];
                    
                    description.innerHTML = `Both use pip-based calculation:<br>` +
                        `SL: ${slPips} pips | ` +
                        `TP1: ${Math.round(tpPips * tpLevels[0])} pips | ` +
                        `TP2: ${Math.round(tpPips * tpLevels[1])} pips | ` +
                        `TP3: ${Math.round(tpPips * tpLevels[2])} pips`;
                } else {
                    description.innerHTML = 'Both use ATR/ratio-based calculation (adaptive to volatility)';
                }
            }
        }
        
        function validateAnalysisBars() {
            const bars = parseInt(document.getElementById('analysis-bars').value);
            const warning = document.getElementById('analysis-bars-warning');
            const error = document.getElementById('analysis-bars-error');
            
            error.style.display = 'none';
            warning.style.display = 'none';
            
            if (bars < 50 || bars > 1000) {
                error.style.display = 'block';
                return false;
            } else if (bars > 500) {
                warning.style.display = 'block';
            }
            return true;
        }
        
        function validateAllInputs() {
            const riskValid = validateRisk();
            const confidenceValid = validateConfidence();
            const lossValid = validateDailyLoss();
            const maxLotValid = validateMaxLotSize();
            const analysisBarsValid = validateAnalysisBars();
            
            return riskValid && confidenceValid && lossValid && maxLotValid && analysisBarsValid;
        }
        
        // MT5 Connection Test
        function testMT5Connection() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Testing...';
            
            fetch('/api/mt5/test')
                .then(r => r.json())
                .then(data => {
                    if (data.connected) {
                        showToast(`‚úÖ MT5 Connected: ${data.account_name} (${data.server})`, 'success');
                        updateMT5Status(true, data);
                    } else {
                        showToast('‚ùå MT5 Not Connected: ' + data.error, 'error');
                        updateMT5Status(false);
                    }
                })
                .catch(err => {
                    showToast('‚ùå Connection test failed: ' + err.message, 'error');
                    updateMT5Status(false);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Test MT5';
                });
        }
        
        // Check MT5 connection status (silent, no toast)
        function checkMT5ConnectionStatus() {
            fetch('/api/mt5/test')
                .then(r => r.json())
                .then(data => {
                    if (data.connected) {
                        updateMT5Status(true, data);
                    } else {
                        updateMT5Status(false);
                    }
                })
                .catch(err => {
                    console.log('MT5 connection check failed:', err);
                    updateMT5Status(false);
                });
        }
        
        function updateMT5Status(connected, data = null) {
            const statusEl = document.getElementById('mt5-connection');
            if (connected) {
                statusEl.innerHTML = '<span class="status-indicator running"></span>Connected';
                document.getElementById('start-btn').disabled = false;
            } else {
                statusEl.innerHTML = '<span class="status-indicator stopped"></span>Not Connected';
                document.getElementById('start-btn').disabled = true;
            }
        }
        
        // Auto-calculate recommended values based on timeframe
        const autoCalculateValues = {
            '1': { risk: 0.3, atr: 0.8, confidence: 40, scalp: 20 },
            '5': { risk: 0.3, atr: 1.0, confidence:45, scalp: 30 },
            '15': { risk: 0.4, atr: 1.2, confidence: 50, scalp: 45 },
            '30': { risk: 0.5, atr: 1.5, confidence: 50, scalp: 60 },
            '60': { risk: 0.5, atr: 1.8, confidence: 55, scalp: 90 }
        };
        
        // Get currency symbol
        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'EUR': '‚Ç¨',
                'GBP': '¬£',
                'JPY': '¬•',
                'AUD': 'A$',
                'CAD': 'C$',
                'CHF': 'CHF ',
                'CNY': '¬•',
                'SEK': 'kr',
                'NZD': 'NZ$'
            };
            return symbols[currency] || currency + ' ';
        }
        
        // Toggle auto-calculate for parameters
        function toggleAuto(param) {
            const timeframe = document.getElementById('timeframe').value;
            const autoValues = autoCalculateValues[timeframe];
            
            if (param === 'risk') {
                const checkbox = document.getElementById('auto-risk');
                const input = document.getElementById('risk-percent');
                if (checkbox.checked) {
                    input.value = autoValues.risk;
                    input.disabled = true;
                    input.style.opacity = '0.6';
                } else {
                    input.disabled = false;
                    input.style.opacity = '1';
                }
            } else if (param === 'atr') {
                const checkbox = document.getElementById('auto-atr');
                const input = document.getElementById('atr-multiplier');
                if (checkbox.checked) {
                    input.value = autoValues.atr;
                    input.disabled = true;
                    input.style.opacity = '0.6';
                } else {
                    input.disabled = false;
                    input.style.opacity = '1';
                }
            } else if (param === 'confidence') {
                const checkbox = document.getElementById('auto-confidence');
                const input = document.getElementById('min-confidence');
                if (checkbox.checked) {
                    input.value = autoValues.confidence;
                    input.disabled = true;
                    input.style.opacity = '0.6';
                } else {
                    input.disabled = false;
                    input.style.opacity = '1';
                }
            } else if (param === 'scalp') {
                const checkbox = document.getElementById('auto-scalp');
                const input = document.getElementById('scalp-max-hold');
                if (checkbox.checked) {
                    input.value = autoValues.scalp;
                    input.disabled = true;
                    input.style.opacity = '0.6';
                } else {
                    input.disabled = false;
                    input.style.opacity = '1';
                }
            }
        }
        
        // Update auto values when timeframe changes
        document.getElementById('timeframe').addEventListener('change', function() {
            if (document.getElementById('auto-risk').checked) toggleAuto('risk');
            if (document.getElementById('auto-atr').checked) toggleAuto('atr');
            if (document.getElementById('auto-confidence').checked) toggleAuto('confidence');
            if (document.getElementById('auto-scalp').checked) toggleAuto('scalp');
        });
        
        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Stop positions auto-refresh when leaving positions tab
            stopPositionsAutoRefresh();
            
            // Load data for the tab
            if (tabName === 'charts') applyChartDateRange();
            if (tabName === 'trades') loadTrades();
            if (tabName === 'positions') {
                // Start auto-refresh for positions tab
                startPositionsAutoRefresh();
            }
            if (tabName === 'analysis') loadRecommendations();
            if (tabName === 'logs') {
                loadLogs();
                loadCurrentLoggingLevel();
            }
            if (tabName === 'trend-detection') {
                loadTrendDetectionData();
            }
        }
        
        // Load Current Logging Level
        function loadCurrentLoggingLevel() {
            // Try to get current logging level from bot configuration
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    if (config.logging_level) {
                        document.getElementById('logging_level').value = config.logging_level;
                    }
                })
                .catch(error => {
                    console.log('Could not load current logging level:', error);
                });
        }
        
        // Load logs
        function loadLogs() {
            const logsContent = document.getElementById('logs-content');
            const logsContainer = document.getElementById('logs-container');
            const lines = document.getElementById('log-lines')?.value || 100;
            logsContent.textContent = 'Loading logs...';
            
            fetch(`/api/logs?lines=${lines}`)
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        // Store original logs for filtering
                        window.originalLogs = data.logs.join('');
                        filterLogs();
                        // Scroll to bottom after a short delay to ensure content is rendered
                        setTimeout(() => {
                            if (logsContainer) {
                                logsContainer.scrollTop = logsContainer.scrollHeight;
                            }
                        }, 100);
                    } else if (data.status === 'error') {
                        logsContent.textContent = 'Error: ' + data.message;
                    } else {
                        logsContent.textContent = 'No logs available yet. Start the bot to generate logs.';
                    }
                })
                .catch(err => {
                    console.error('Failed to load logs:', err);
                    logsContent.textContent = 'Error loading logs: ' + err.message + '\n\nPossible causes:\n- Log file is locked by another process\n- Dashboard server issue\n- Network error\n\nTry:\n1. Refresh the page\n2. Restart the dashboard\n3. Check if bot is running';
                    showToast('‚ùå Failed to load logs', 'error');
                });
        }
        
        // Filter logs based on checkboxes
        function filterLogs() {
            if (!window.originalLogs) return;
            
            const logsContent = document.getElementById('logs-content');
            const showErrors = document.getElementById('filter-errors')?.checked;
            const showWarnings = document.getElementById('filter-warnings')?.checked;
            const showInfo = document.getElementById('filter-info')?.checked;
            const showDebug = document.getElementById('filter-debug')?.checked;
            const signalsOnly = document.getElementById('filter-signals')?.checked;
            
            let lines = window.originalLogs.split('\n');
            
            if (signalsOnly) {
                // Show only signal-related lines
                lines = lines.filter(line => 
                    line.includes('ANALYZING') ||
                    line.includes('signal') ||
                    line.includes('Signal') ||
                    line.includes('crossover') ||
                    line.includes('filter') ||
                    line.includes('Filter') ||
                    line.includes('‚úì') ||
                    line.includes('‚úó') ||
                    line.includes('REJECTED') ||
                    line.includes('confirmed')
                );
            } else {
                // Filter by log level
                lines = lines.filter(line => {
                    if (showErrors && line.includes('ERROR')) return true;
                    if (showWarnings && line.includes('WARNING')) return true;
                    if (showInfo && line.includes('INFO')) return true;
                    if (showDebug && line.includes('DEBUG')) return true;
                    // Show lines without level markers if any filter is checked
                    if ((showErrors || showWarnings || showInfo || showDebug) && 
                        !line.includes('ERROR') && !line.includes('WARNING') && 
                        !line.includes('INFO') && !line.includes('DEBUG')) {
                        return true;
                    }
                    return false;
                });
            }
            
            logsContent.textContent = lines.join('\n') || 'No logs match the selected filters.';
        }
        
        // Clear logs display
        function clearLogsDisplay() {
            document.getElementById('logs-content').textContent = 'Logs cleared. Click "Refresh Logs" to reload.';
            window.originalLogs = null;
        }
        
        // Check MT5 diagnostics
        function checkMT5Diagnostics() {
            const statusText = document.getElementById('mt5-status-text');
            const buildText = document.getElementById('mt5-build');
            const accountText = document.getElementById('mt5-account');
            const lastCheckText = document.getElementById('mt5-last-check');
            
            statusText.textContent = 'Checking...';
            statusText.style.color = '#fbbf24';
            
            fetch('/api/mt5/test')
                .then(r => r.json())
                .then(data => {
                    const now = new Date().toLocaleTimeString();
                    lastCheckText.textContent = now;
                    
                    if (data.connected) {
                        statusText.textContent = '‚úÖ Connected';
                        statusText.style.color = '#10b981';
                        buildText.textContent = data.server || 'Unknown';
                        accountText.textContent = `${data.account_name} (${data.account_number})`;
                        
                        // Update debug info
                        updateDebugInfo();
                        
                        showToast('‚úÖ MT5 connected successfully', 'success');
                    } else {
                        statusText.textContent = '‚ùå Not Connected';
                        statusText.style.color = '#ef4444';
                        buildText.textContent = data.error || 'Connection failed';
                        accountText.textContent = '-';
                        showToast('‚ùå MT5 connection failed: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    statusText.textContent = '‚ùå Error';
                    statusText.style.color = '#ef4444';
                    buildText.textContent = err.message;
                    accountText.textContent = '-';
                    lastCheckText.textContent = new Date().toLocaleTimeString();
                    showToast('‚ùå Failed to check MT5: ' + err.message, 'error');
                });
        }
        
        // Update debug information
        function updateDebugInfo() {
            // Get current configuration
            fetch('/api/config')
                .then(r => r.json())
                .then(config => {
                    document.getElementById('debug-symbols').textContent = config.symbols?.join(', ') || '-';
                    document.getElementById('debug-timeframe').textContent = config.timeframe || '-';
                    document.getElementById('debug-confidence').textContent = 
                        config.min_confidence ? (config.min_confidence * 100).toFixed(0) + '%' : '-';
                    document.getElementById('debug-volume-filter').textContent = 
                        config.use_volume_filter ? '‚úÖ Enabled' : '‚ùå Disabled';
                })
                .catch(err => console.error('Failed to load config for debug:', err));
            
            // Get bot status
            fetch('/api/bot/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('debug-bot-running').textContent = 
                        data.running ? '‚úÖ Yes' : '‚ùå No';
                    document.getElementById('debug-last-analysis').textContent = 
                        new Date().toLocaleTimeString();
                })
                .catch(err => console.error('Failed to load status for debug:', err));
        }
        
        // Download logs
        function downloadLogs() {
            fetch('/api/logs/download')
                .then(r => {
                    if (!r.ok) {
                        throw new Error('Failed to download logs');
                    }
                    return r.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'gem_trading_logs.txt';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast('‚úÖ Logs downloaded successfully', 'success');
                })
                .catch(err => {
                    console.error('Failed to download logs:', err);
                    showToast('‚ùå Failed to download logs: ' + err.message, 'error');
                });
        }
        
        // Update status every 5 seconds
        setInterval(updateStatus, 5000);
        updateStatus();
        
        // Refresh functions for each tab
        function refreshDashboard(e) {
            const btn = e.target;
            btn.disabled = true;
            
            // Refresh all dashboard data
            updateStatus();
            checkMT5ConnectionStatus();
            
            setTimeout(() => {
                btn.disabled = false;
                showToast('‚úÖ Dashboard refreshed', 'success');
            }, 1000);
        }
        
        function refreshCharts(e) {
            const btn = e.target;
            btn.disabled = true;
            
            applyChartDateRange();
            
            setTimeout(() => {
                btn.disabled = false;
            }, 1000);
        }
        
        function refreshTrades(e) {
            const btn = e.target;
            btn.disabled = true;
            
            loadTrades();
            
            setTimeout(() => {
                btn.disabled = false;
                showToast('‚úÖ Trade history refreshed', 'success');
            }, 1000);
        }
        
        function refreshPositions(e) {
            const btn = e.target;
            btn.disabled = true;
            
            loadPositions();
            
            setTimeout(() => {
                btn.disabled = false;
                showToast('‚úÖ Positions refreshed', 'success');
            }, 1000);
        }
        
        function refreshRecommendations(e) {
            const btn = e.target;
            btn.disabled = true;
            
            loadRecommendations();
            
            setTimeout(() => {
                btn.disabled = false;
                showToast('‚úÖ Recommendations refreshed', 'success');
            }, 1000);
        }
        
        function refreshConfig(e) {
            const btn = e.target;
            btn.disabled = true;
            
            // Reload configuration from server
            fetch('/api/config/get')
                .then(r => r.json())
                .then(data => {
                    if (data.config) {
                        // Populate form with current config
                        Object.keys(data.config).forEach(key => {
                            const element = document.getElementById(key.replace(/_/g, '-'));
                            if (element) {
                                if (element.tagName === 'SELECT' && element.multiple) {
                                    // Handle multi-select
                                    const values = data.config[key];
                                    Array.from(element.options).forEach(option => {
                                        option.selected = values.includes(option.value);
                                    });
                                } else {
                                    element.value = data.config[key];
                                }
                            }
                        });
                        showToast('‚úÖ Configuration reloaded', 'success');
                    }
                })
                .catch(err => {
                    showToast('‚ùå Failed to reload configuration', 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Reload Configuration';
                });
        }
        
        // Trend Detection Functions
        function refreshTrendDetection(e) {
            const btn = e.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Refreshing...';
            
            loadTrendDetectionData()
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ';
                });
        }
        
        async function loadTrendDetectionData() {
            try {
                const response = await fetch('/api/trend-detection/status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateTrendDetectionDisplay(data);
                    showToast('‚úÖ Trend detection data refreshed', 'success');
                } else {
                    showTrendDetectionError(data.message || 'Failed to load trend detection data');
                }
            } catch (error) {
                console.error('Error loading trend detection data:', error);
                showTrendDetectionError('Network error: ' + error.message);
            }
        }
        
        function updateTrendDetectionDisplay(data) {
            // Update system status
            const enabledEl = document.getElementById('trend-detection-enabled');
            if (data.enabled) {
                enabledEl.innerHTML = '<span class="status-indicator running"></span>Enabled';
                
                // Update configuration display
                document.getElementById('trend-sensitivity-level').textContent = data.config.sensitivity + '/10';
                document.getElementById('trend-min-confidence').textContent = Math.round(data.config.min_confidence * 100) + '%';
                document.getElementById('trend-early-signals').textContent = data.config.early_signals ? 'Enabled' : 'Disabled';
                document.getElementById('trend-mtf-confirmation').textContent = data.config.mtf_confirmation ? 'Enabled' : 'Disabled';
                
                // Count signals
                let totalSignals = 0;
                let bullishSignals = 0;
                let bearishSignals = 0;
                let totalWarnings = 0;
                
                Object.values(data.symbols).forEach(symbolData => {
                    if (symbolData.status === 'success') {
                        totalSignals += symbolData.signals_count || 0;
                        
                        symbolData.signals.forEach(signal => {
                            if (signal.type.includes('bullish')) {
                                bullishSignals++;
                            } else if (signal.type.includes('bearish')) {
                                bearishSignals++;
                            }
                        });
                        
                        totalWarnings += symbolData.early_warnings.length || 0;
                    }
                });
                
                // Update signal counts
                document.getElementById('active-signals-count').textContent = totalSignals;
                document.getElementById('bullish-signals-count').textContent = bullishSignals;
                document.getElementById('bearish-signals-count').textContent = bearishSignals;
                document.getElementById('early-warnings-count').textContent = totalWarnings;
                document.getElementById('trend-last-update').textContent = new Date(data.timestamp).toLocaleTimeString();
                
                // Update symbol analysis
                updateSymbolAnalysisDisplay(data.symbols);
                
                // Update market structure display
                updateMarketStructureDisplay(data.symbols);
                
                // Update MTF alignment display
                updateMTFAlignmentDisplay(data.symbols);
                
                // Update volume analysis display
                updateVolumeAnalysisDisplay(data.symbols);
                
                // Update divergence analysis display
                updateDivergenceAnalysisDisplay(data.symbols);
                
            } else {
                enabledEl.innerHTML = '<span class="status-indicator stopped"></span>Disabled';
                document.getElementById('trend-sensitivity-level').textContent = 'N/A';
                document.getElementById('trend-min-confidence').textContent = 'N/A';
                document.getElementById('trend-early-signals').textContent = 'N/A';
                document.getElementById('trend-mtf-confirmation').textContent = 'N/A';
                
                // Show disabled message
                document.getElementById('symbol-analysis-container').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #94a3b8;">' +
                    '<p>Trend detection is disabled in configuration.</p>' +
                    '<p>Enable it in the Configuration tab to see analysis.</p>' +
                    '</div>';
                
                document.getElementById('market-structure-container').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #94a3b8;">Trend detection disabled</div>';
                
                document.getElementById('mtf-alignment-container').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #94a3b8;">Trend detection disabled</div>';
                
                document.getElementById('volume-analysis-container').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #94a3b8;">Trend detection disabled</div>';
                
                document.getElementById('divergence-analysis-container').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #94a3b8;">Trend detection disabled</div>';
            }
        }
        
        function updateSymbolAnalysisDisplay(symbols) {
            const container = document.getElementById('symbol-analysis-container');
            
            if (Object.keys(symbols).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">No symbols configured for analysis</div>';
                return;
            }
            
            let html = '<div class="grid">';
            
            Object.entries(symbols).forEach(([symbol, data]) => {
                if (data.status === 'error') {
                    html += `
                        <div class="card" style="border-left: 3px solid #ef4444;">
                            <h4 style="color: #ef4444; margin-bottom: 10px;">${symbol}</h4>
                            <p style="color: #94a3b8;">Error: ${data.message}</p>
                        </div>
                    `;
                    return;
                }
                
                const confidenceColor = data.overall_confidence > 0.7 ? '#10b981' : 
                                       data.overall_confidence > 0.4 ? '#f59e0b' : '#ef4444';
                
                html += `
                    <div class="card" style="border-left: 3px solid ${confidenceColor};">
                        <h4 style="color: #60a5fa; margin-bottom: 15px;">${symbol}</h4>
                        <div class="stat">
                            <span class="stat-label">Current Price</span>
                            <span class="stat-value">${data.current_price}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Overall Confidence</span>
                            <span class="stat-value" style="color: ${confidenceColor};">${Math.round(data.overall_confidence * 100)}%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Active Signals</span>
                            <span class="stat-value">${data.signals_count}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Early Warnings</span>
                            <span class="stat-value">${data.early_warnings.length}</span>
                        </div>
                `;
                
                // Show signals
                if (data.signals.length > 0) {
                    html += '<div style="margin-top: 15px;"><strong style="color: #60a5fa;">Signals:</strong><ul style="margin: 5px 0 0 20px; font-size: 13px;">';
                    data.signals.forEach(signal => {
                        const signalColor = signal.type.includes('bullish') ? '#10b981' : '#ef4444';
                        const signalIcon = signal.type.includes('bullish') ? 'üìà' : 'üìâ';
                        html += `<li style="color: ${signalColor}; margin-bottom: 3px;">${signalIcon} ${signal.source.toUpperCase()}: ${Math.round(signal.confidence * 100)}% confidence</li>`;
                    });
                    html += '</ul></div>';
                }
                
                // Show early warnings
                if (data.early_warnings.length > 0) {
                    html += '<div style="margin-top: 10px;"><strong style="color: #f59e0b;">Warnings:</strong><ul style="margin: 5px 0 0 20px; font-size: 13px;">';
                    data.early_warnings.slice(0, 2).forEach(warning => {
                        html += `<li style="color: #f59e0b; margin-bottom: 3px;">‚ö†Ô∏è ${warning.description}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function updateMarketStructureDisplay(symbols) {
            const container = document.getElementById('market-structure-container');
            
            let html = '<div class="grid">';
            let hasStructureData = false;
            
            Object.entries(symbols).forEach(([symbol, data]) => {
                if (data.status === 'success' && data.market_structure) {
                    hasStructureData = true;
                    const structure = data.market_structure;
                    const statusColor = structure.confirmed ? '#10b981' : '#f59e0b';
                    
                    html += `
                        <div class="card" style="border-left: 3px solid ${statusColor};">
                            <h4 style="color: #60a5fa; margin-bottom: 15px;">${symbol}</h4>
                            <div class="stat">
                                <span class="stat-label">Break Type</span>
                                <span class="stat-value">${structure.break_type.replace(/_/g, ' ').toUpperCase()}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Break Level</span>
                                <span class="stat-value">${structure.break_level}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Volume Confirmed</span>
                                <span class="stat-value" style="color: ${structure.volume_confirmed ? '#10b981' : '#ef4444'};">
                                    ${structure.volume_confirmed ? 'Yes' : 'No'}
                                </span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Strength</span>
                                <span class="stat-value">${Math.round(structure.strength * 100)}%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Status</span>
                                <span class="stat-value" style="color: ${statusColor};">
                                    ${structure.confirmed ? 'Confirmed' : 'Pending'}
                                </span>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!hasStructureData) {
                html = '<div style="text-align: center; padding: 40px; color: #94a3b8;">No market structure breaks detected</div>';
            } else {
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function updateMTFAlignmentDisplay(symbols) {
            const container = document.getElementById('mtf-alignment-container');
            
            let html = '<div class="grid">';
            let hasMTFData = false;
            
            Object.entries(symbols).forEach(([symbol, data]) => {
                if (data.status === 'success' && data.mtf_alignment) {
                    hasMTFData = true;
                    const mtf = data.mtf_alignment;
                    
                    let alignmentColor = '#ef4444'; // Default red
                    if (mtf.confirmation_level === 'strong') alignmentColor = '#10b981';
                    else if (mtf.confirmation_level === 'moderate') alignmentColor = '#f59e0b';
                    
                    html += `
                        <div class="card" style="border-left: 3px solid ${alignmentColor};">
                            <h4 style="color: #60a5fa; margin-bottom: 15px;">${symbol}</h4>
                            <div class="stat">
                                <span class="stat-label">Primary TF</span>
                                <span class="stat-value">${mtf.primary_timeframe}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Higher TF</span>
                                <span class="stat-value">${mtf.higher_timeframe}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Alignment Score</span>
                                <span class="stat-value">${Math.round(mtf.alignment_score * 100)}%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Confirmation</span>
                                <span class="stat-value" style="color: ${alignmentColor};">
                                    ${mtf.confirmation_level.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!hasMTFData) {
                html = '<div style="text-align: center; padding: 40px; color: #94a3b8;">No multi-timeframe data available</div>';
            } else {
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function updateVolumeAnalysisDisplay(symbols) {
            const container = document.getElementById('volume-analysis-container');
            
            let html = '<div class="grid">';
            let hasVolumeData = false;
            
            Object.entries(symbols).forEach(([symbol, data]) => {
                if (data.status === 'success') {
                    hasVolumeData = true;
                    
                    // Get volume confirmation data
                    const volumeConfirmation = data.volume_confirmation;
                    const hasVolumeConfirmation = volumeConfirmation && volumeConfirmation.strength !== undefined;
                    
                    // Determine volume status color
                    let volumeColor = '#94a3b8'; // Default gray
                    let volumeStatus = 'No Data';
                    
                    if (hasVolumeConfirmation) {
                        if (volumeConfirmation.strength > 0.7) {
                            volumeColor = '#10b981'; // Green for strong
                            volumeStatus = 'Strong';
                        } else if (volumeConfirmation.strength > 0.4) {
                            volumeColor = '#f59e0b'; // Yellow for moderate
                            volumeStatus = 'Moderate';
                        } else {
                            volumeColor = '#ef4444'; // Red for weak
                            volumeStatus = 'Weak';
                        }
                    }
                    
                    html += `
                        <div class="card" style="border-left: 3px solid ${volumeColor};">
                            <h4 style="color: #60a5fa; margin-bottom: 15px;">${symbol}</h4>
                    `;
                    
                    if (hasVolumeConfirmation) {
                        html += `
                            <div class="stat">
                                <span class="stat-label">Volume Status</span>
                                <span class="stat-value" style="color: ${volumeColor};">${volumeStatus}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Volume Spike</span>
                                <span class="stat-value" style="color: ${volumeConfirmation.volume_spike ? '#10b981' : '#ef4444'};">
                                    ${volumeConfirmation.volume_spike ? 'Detected' : 'None'}
                                </span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Volume Ratio</span>
                                <span class="stat-value">${volumeConfirmation.volume_ratio}x</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Strength Score</span>
                                <span class="stat-value">${Math.round(volumeConfirmation.strength * 100)}%</span>
                            </div>
                        `;
                        
                        // Add volume interpretation
                        let interpretation = '';
                        if (volumeConfirmation.volume_spike && volumeConfirmation.strength > 0.6) {
                            interpretation = 'üìà Strong volume support for price movement';
                        } else if (volumeConfirmation.volume_ratio > 1.5) {
                            interpretation = 'üìä Above average volume activity';
                        } else if (volumeConfirmation.strength < 0.3) {
                            interpretation = '‚ö†Ô∏è Weak volume - signals may be unreliable';
                        } else {
                            interpretation = 'üìä Normal volume activity';
                        }
                        
                        html += `
                            <div style="margin-top: 15px; padding: 10px; background: rgba(96, 165, 250, 0.1); border-radius: 6px;">
                                <small style="color: #60a5fa; font-weight: 600;">Analysis:</small><br>
                                <small style="color: #94a3b8;">${interpretation}</small>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="text-align: center; padding: 20px; color: #94a3b8;">
                                <p>Volume analysis not available</p>
                                <small>Requires active trend signals</small>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
            });
            
            if (!hasVolumeData) {
                html = '<div style="text-align: center; padding: 40px; color: #94a3b8;">No volume analysis data available</div>';
            } else {
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function updateDivergenceAnalysisDisplay(symbols) {
            const container = document.getElementById('divergence-analysis-container');
            
            let html = '<div class="grid">';
            let hasDivergenceData = false;
            
            Object.entries(symbols).forEach(([symbol, data]) => {
                if (data.status === 'success' && data.divergences && data.divergences.length > 0) {
                    hasDivergenceData = true;
                    
                    html += `
                        <div class="card" style="border-left: 3px solid #f59e0b;">
                            <h4 style="color: #60a5fa; margin-bottom: 15px;">${symbol}</h4>
                            <div class="stat">
                                <span class="stat-label">Divergences Found</span>
                                <span class="stat-value">${data.divergences.length}</span>
                            </div>
                    `;
                    
                    // Show each divergence
                    data.divergences.forEach((divergence, index) => {
                        const divColor = divergence.type.includes('bullish') ? '#10b981' : '#ef4444';
                        const divIcon = divergence.type.includes('bullish') ? 'üìà' : 'üìâ';
                        const divType = divergence.type.replace(/_/g, ' ').toUpperCase();
                        
                        html += `
                            <div style="margin-top: 15px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; border-left: 3px solid ${divColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: ${divColor};">${divIcon} ${divType}</strong>
                                    <span style="color: ${divergence.validated ? '#10b981' : '#f59e0b'}; font-size: 12px;">
                                        ${divergence.validated ? '‚úÖ Validated' : '‚è≥ Pending'}
                                    </span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                                    <div>
                                        <span style="color: #94a3b8;">Indicator:</span><br>
                                        <span style="color: #e2e8f0;">${divergence.indicator}</span>
                                    </div>
                                    <div>
                                        <span style="color: #94a3b8;">Strength:</span><br>
                                        <span style="color: #e2e8f0;">${Math.round(divergence.strength * 100)}%</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                } else if (data.status === 'success') {
                    // No divergences found
                    html += `
                        <div class="card" style="border-left: 3px solid #94a3b8;">
                            <h4 style="color: #60a5fa; margin-bottom: 15px;">${symbol}</h4>
                            <div style="text-align: center; padding: 20px; color: #94a3b8;">
                                <p>‚úÖ No divergences detected</p>
                                <small>Price and momentum indicators are aligned</small>
                            </div>
                        </div>
                    `;
                    hasDivergenceData = true;
                }
            });
            
            if (!hasDivergenceData) {
                html = '<div style="text-align: center; padding: 40px; color: #94a3b8;">No divergence analysis data available</div>';
            } else {
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function showTrendDetectionError(message) {
            const containers = [
                'symbol-analysis-container',
                'market-structure-container', 
                'mtf-alignment-container',
                'volume-analysis-container',
                'divergence-analysis-container'
            ];
            
            containers.forEach(containerId => {
                document.getElementById(containerId).innerHTML = 
                    `<div style="text-align: center; padding: 40px; color: #ef4444;">
                        <p>‚ùå Error loading data</p>
                        <p style="font-size: 14px; color: #94a3b8;">${message}</p>
                    </div>`;
            });
            
            showToast('‚ùå Failed to load trend detection data: ' + message, 'error');
        }
        
        // Check MT5 connection on page load
        setTimeout(checkMT5ConnectionStatus, 1000);
        
        function updateStatus() {
            fetch('/api/bot/status')
                .then(r => r.json())
                .then(data => {
                    // Store currency
                    accountCurrency = data.currency || 'USD';
                    
                    // Get currency symbol
                    const currencySymbol = getCurrencySymbol(accountCurrency);
                    
                    // Handle balance data (default to 0 if undefined)
                    const balance = data.balance || 0;
                    const equity = data.equity || 0;
                    const profit = data.profit || 0;
                    const profitToday = data.profit_today || 0;
                    const profitMtd = data.profit_mtd || 0;
                    const profitYtd = data.profit_ytd || 0;
                    const openPositions = data.open_positions || 0;
                    
                    document.getElementById('balance').textContent = currencySymbol + balance.toFixed(2);
                    document.getElementById('equity').textContent = currencySymbol + equity.toFixed(2);
                    
                    const profitEl = document.getElementById('profit');
                    profitEl.textContent = currencySymbol + profit.toFixed(2);
                    profitEl.className = 'stat-value ' + (profit >= 0 ? 'positive' : 'negative');
                    
                    // Today's profit
                    const profitTodayEl = document.getElementById('profit-today');
                    profitTodayEl.textContent = currencySymbol + profitToday.toFixed(2);
                    profitTodayEl.className = 'stat-value ' + (profitToday >= 0 ? 'positive' : 'negative');
                    
                    // Month to date
                    const profitMtdEl = document.getElementById('profit-mtd');
                    profitMtdEl.textContent = currencySymbol + profitMtd.toFixed(2);
                    profitMtdEl.className = 'stat-value ' + (profitMtd >= 0 ? 'positive' : 'negative');
                    
                    // Year to date
                    const profitYtdEl = document.getElementById('profit-ytd');
                    profitYtdEl.textContent = currencySymbol + profitYtd.toFixed(2);
                    profitYtdEl.className = 'stat-value ' + (profitYtd >= 0 ? 'positive' : 'negative');
                    
                    document.getElementById('open-positions').textContent = openPositions;
                    
                    const statusEl = document.getElementById('bot-status');
                    if (data.running) {
                        statusEl.innerHTML = '<span class="status-indicator running"></span>Running';
                    } else {
                        statusEl.innerHTML = '<span class="status-indicator stopped"></span>Stopped';
                    }
                    
                    // Show error if present
                    if (data.error) {
                        console.warn('Status error:', data.error);
                    }
                })
                .catch(err => {
                    console.error('Failed to fetch bot status:', err);
                    // Don't show toast on every error, just log it
                });
            
            fetch('/api/analysis/performance')
                .then(r => r.json())
                .then(data => {
                    // Handle performance data (default to 0 if undefined)
                    const winRate = data.win_rate || 0;
                    const totalTrades = data.total_trades || 0;
                    const todayWins = data.today_wins || 0;
                    const todayLosses = data.today_losses || 0;
                    const totalTradesToday = todayWins + todayLosses;
                    
                    // Show/hide no-trades info box
                    const noTradesInfo = document.getElementById('no-trades-info');
                    if (totalTrades === 0) {
                        noTradesInfo.style.display = 'block';
                    } else {
                        noTradesInfo.style.display = 'none';
                    }
                    
                    document.getElementById('win-rate').textContent = winRate + '%';
                    document.getElementById('total-trades').textContent = totalTrades;
                    document.getElementById('total-trades-today').textContent = totalTradesToday;
                    
                    // Update today's wins (green)
                    const todayWinsEl = document.getElementById('today-wins');
                    todayWinsEl.textContent = todayWins;
                    todayWinsEl.className = 'stat-value positive';
                    
                    // Update today's losses (red)
                    const todayLossesEl = document.getElementById('today-losses');
                    todayLossesEl.textContent = todayLosses;
                    todayLossesEl.className = 'stat-value negative';
                })
                .catch(err => {
                    console.error('Failed to fetch performance:', err);
                    // Set defaults on error and show info box
                    document.getElementById('no-trades-info').style.display = 'block';
                    document.getElementById('win-rate').textContent = '0%';
                    document.getElementById('total-trades').textContent = '0';
                    document.getElementById('total-trades-today').textContent = '0';
                    document.getElementById('today-wins').textContent = '0';
                    document.getElementById('today-losses').textContent = '0';
                });
        }
        
        function startBot() {
            // Check MT5 connection first
            const mt5Status = document.getElementById('mt5-connection').textContent;
            if (mt5Status.includes('Not Connected')) {
                showToast('‚ùå Cannot start bot: MT5 not connected. Click "Test MT5" first.', 'error');
                return;
            }
            
            // Validate configuration
            if (!validateAllInputs()) {
                showToast('‚ùå Cannot start bot: Please fix configuration errors', 'error');
                return;
            }
            
            // Confirm if risky settings
            const risk = parseFloat(document.getElementById('risk-percent').value);
            if (risk > 1) {
                if (!confirm('‚ö†Ô∏è WARNING: Risk per trade is above 1%. This is aggressive. Continue?')) {
                    return;
                }
            }
            
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Starting...';
            
            fetch('/api/bot/start', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('‚úÖ ' + data.message, 'success');
                    } else {
                        showToast('‚ùå ' + data.message, 'error');
                    }
                    updateStatus();
                })
                .catch(err => {
                    showToast('‚ùå Failed to start bot: ' + err.message, 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Start Bot';
                });
        }
        
        function stopBot() {
            if (!confirm('Stop the trading bot? Open positions will remain open.')) {
                return;
            }
            
            const btn = document.getElementById('stop-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Stopping...';
            
            fetch('/api/bot/stop', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('‚úÖ ' + data.message, 'success');
                    } else {
                        showToast('‚ùå ' + data.message, 'error');
                    }
                    updateStatus();
                })
                .catch(err => {
                    showToast('‚ùå Failed to stop bot: ' + err.message, 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Stop Bot';
                });
        }
        
        function restartBot() {
            if (!confirm('Restart the trading bot? This will apply any configuration changes.')) {
                return;
            }
            
            const btn = document.getElementById('restart-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Restarting...';
            
            // First stop the bot
            fetch('/api/bot/stop', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('üîÑ Bot stopped, restarting...', 'info');
                        
                        // Wait 2 seconds then start
                        setTimeout(() => {
                            fetch('/api/bot/start', {method: 'POST'})
                                .then(r => r.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        showToast('‚úÖ Bot restarted successfully', 'success');
                                    } else {
                                        showToast('‚ùå Failed to restart: ' + data.message, 'error');
                                    }
                                    updateStatus();
                                })
                                .catch(err => {
                                    showToast('‚ùå Failed to restart bot: ' + err.message, 'error');
                                })
                                .finally(() => {
                                    btn.disabled = false;
                                    btn.innerHTML = 'üîÑ Restart Bot';
                                });
                        }, 2000);
                    } else {
                        showToast('‚ùå Failed to stop bot: ' + data.message, 'error');
                        btn.disabled = false;
                        btn.innerHTML = 'üîÑ Restart Bot';
                    }
                })
                .catch(err => {
                    showToast('‚ùå Failed to restart bot: ' + err.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Restart Bot';
                });
        }
        
        // Global variable to store all trades
        let allTrades = [];
        let accountCurrency = 'USD'; // Default currency
        
        // Show/hide custom date inputs
        document.getElementById('date-range').addEventListener('change', function() {
            const customFrom = document.getElementById('custom-date-from');
            const customTo = document.getElementById('custom-date-to');
            if (this.value === 'custom') {
                customFrom.style.display = 'block';
                customTo.style.display = 'block';
            } else {
                customFrom.style.display = 'none';
                customTo.style.display = 'none';
            }
        });
        
        // Helper function to get date range
        function getDateRange(rangeType) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;
            
            switch(rangeType) {
                case 'today':
                    startDate = today;
                    endDate = new Date(today.getTime() + 24*60*60*1000);
                    break;
                case 'yesterday':
                    startDate = new Date(today.getTime() - 24*60*60*1000);
                    endDate = today;
                    break;
                case 'last7days':
                    startDate = new Date(today.getTime() - 7*24*60*60*1000);
                    endDate = new Date(today.getTime() + 24*60*60*1000);
                    break;
                case 'last30days':
                    startDate = new Date(today.getTime() - 30*24*60*60*1000);
                    endDate = new Date(today.getTime() + 24*60*60*1000);
                    break;
                case 'thisweek':
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(today.setDate(diff));
                    endDate = new Date(today.getTime() + 7*24*60*60*1000);
                    break;
                case 'lastweek':
                    const lastWeekStart = new Date(today.getTime() - 7*24*60*60*1000);
                    const lastWeekDay = lastWeekStart.getDay();
                    const lastWeekDiff = lastWeekStart.getDate() - lastWeekDay + (lastWeekDay === 0 ? -6 : 1);
                    startDate = new Date(lastWeekStart.setDate(lastWeekDiff));
                    endDate = new Date(startDate.getTime() + 7*24*60*60*1000);
                    break;
                case 'thismonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'lastmonth':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'custom':
                    const fromInput = document.getElementById('date-from').value;
                    const toInput = document.getElementById('date-to').value;
                    if (fromInput) startDate = new Date(fromInput);
                    if (toInput) endDate = new Date(toInput + 'T23:59:59');
                    break;
                case 'all':
                default:
                    return null;
            }
            
            return { startDate, endDate };
        }
        
        // Calculate win rates
        function calculateWinRates(trades) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const last7Days = new Date(today.getTime() - 7*24*60*60*1000);
            
            // Overall
            const overallWins = trades.filter(t => t.profit > 0).length;
            const overallTotal = trades.length;
            const overallWinRate = overallTotal > 0 ? ((overallWins / overallTotal) * 100).toFixed(1) : 0;
            
            // Today
            const todayTrades = trades.filter(t => {
                const tradeDate = new Date(t.time);
                return tradeDate >= today;
            });
            const todayWins = todayTrades.filter(t => t.profit > 0).length;
            const todayTotal = todayTrades.length;
            const todayWinRate = todayTotal > 0 ? ((todayWins / todayTotal) * 100).toFixed(1) : 0;
            
            // Last 7 days
            const weekTrades = trades.filter(t => {
                const tradeDate = new Date(t.time);
                return tradeDate >= last7Days;
            });
            const weekWins = weekTrades.filter(t => t.profit > 0).length;
            const weekTotal = weekTrades.length;
            const weekWinRate = weekTotal > 0 ? ((weekWins / weekTotal) * 100).toFixed(1) : 0;
            
            // Update display
            document.getElementById('overall-win-rate').textContent = overallWinRate + '%';
            document.getElementById('overall-win-rate').className = overallWinRate >= 50 ? 'positive' : 'negative';
            document.getElementById('overall-trades-count').textContent = `${overallWins}W / ${overallTotal - overallWins}L (${overallTotal} trades)`;
            
            document.getElementById('today-win-rate').textContent = todayWinRate + '%';
            document.getElementById('today-win-rate').className = todayWinRate >= 50 ? 'positive' : 'negative';
            document.getElementById('today-trades-count').textContent = `${todayWins}W / ${todayTotal - todayWins}L (${todayTotal} trades)`;
            
            document.getElementById('week-win-rate').textContent = weekWinRate + '%';
            document.getElementById('week-win-rate').className = weekWinRate >= 50 ? 'positive' : 'negative';
            document.getElementById('week-trades-count').textContent = `${weekWins}W / ${weekTotal - weekWins}L (${weekTotal} trades)`;
        }
        
        // Apply sort and filter
        function applySortFilter() {
            let filteredTrades = [...allTrades];
            
            // Apply date range filter
            const dateRange = document.getElementById('date-range').value;
            const range = getDateRange(dateRange);
            
            if (range && range.startDate && range.endDate) {
                filteredTrades = filteredTrades.filter(t => {
                    const tradeDate = new Date(t.time);
                    return tradeDate >= range.startDate && tradeDate < range.endDate;
                });
            }
            
            // Apply win/loss filter
            const filterBy = document.getElementById('filter-by').value;
            if (filterBy === 'wins') {
                filteredTrades = filteredTrades.filter(t => t.profit > 0);
            } else if (filterBy === 'losses') {
                filteredTrades = filteredTrades.filter(t => t.profit < 0);
            }
            
            // Apply symbol filter
            const filterSymbol = document.getElementById('filter-symbol').value;
            if (filterSymbol !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.symbol === filterSymbol);
            }
            
            // Apply sort
            const sortBy = document.getElementById('sort-by').value;
            
            if (sortBy === 'date-desc') {
                filteredTrades.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortBy === 'date-asc') {
                filteredTrades.sort((a, b) => a.timestamp - b.timestamp);
            } else if (sortBy === 'profit-desc') {
                filteredTrades.sort((a, b) => b.profit - a.profit);
            } else if (sortBy === 'profit-asc') {
                filteredTrades.sort((a, b) => a.profit - b.profit);
            } else if (sortBy === 'amount-desc') {
                filteredTrades.sort((a, b) => Math.abs(b.profit) - Math.abs(a.profit));
            } else if (sortBy === 'amount-asc') {
                filteredTrades.sort((a, b) => Math.abs(a.profit) - Math.abs(b.profit));
            }
            
            // Calculate and display win rates (always based on all trades)
            calculateWinRates(allTrades);
            
            // Display filtered and sorted trades
            displayTrades(filteredTrades);
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('date-range').value = 'last7days';
            document.getElementById('sort-by').value = 'date-desc';
            document.getElementById('filter-by').value = 'all';
            document.getElementById('filter-symbol').value = 'all';
            document.getElementById('custom-date-from').style.display = 'none';
            document.getElementById('custom-date-to').style.display = 'none';
            applySortFilter();
        }
        
        // Display trades in table
        function displayTrades(trades) {
            const tbody = document.getElementById('trades-body');
            tbody.innerHTML = '';
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No trades found</td></tr>';
                return;
            }
            
            const currencySymbol = getCurrencySymbol(accountCurrency);
            
            trades.forEach(trade => {
                const row = tbody.insertRow();
                
                // Calculate pips display
                const pips = trade.pips ? trade.pips.toFixed(1) : 'N/A';
                const pipsClass = trade.profit >= 0 ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td>${trade.time}</td>
                    <td>${trade.symbol}</td>
                    <td><span class="badge ${trade.type === 'BUY' ? 'badge-success' : 'badge-danger'}">${trade.type}</span></td>
                    <td>${trade.volume}</td>
                    <td>${trade.price_open ? trade.price_open.toFixed(5) : 'N/A'}</td>
                    <td>${trade.price_close ? trade.price_close.toFixed(5) : 'N/A'}</td>
                    <td class="${pipsClass}">${pips}</td>
                    <td class="${trade.profit >= 0 ? 'positive' : 'negative'}">${currencySymbol}${trade.profit.toFixed(2)}</td>
                `;
            });
        }
        
        function loadTrades() {
            fetch('/api/trades/history')
                .then(r => r.json())
                .then(data => {
                    allTrades = data.trades;
                    
                    // Populate symbol filter
                    const symbols = [...new Set(allTrades.map(t => t.symbol))];
                    const symbolFilter = document.getElementById('filter-symbol');
                    symbolFilter.innerHTML = '<option value="all">All Symbols</option>';
                    symbols.forEach(symbol => {
                        symbolFilter.innerHTML += `<option value="${symbol}">${symbol}</option>`;
                    });
                    
                    // Apply initial sort/filter
                    applySortFilter();
                });
        }
        
        // Auto-refresh interval for positions
        let positionsRefreshInterval = null;
        
        function loadPositions() {
            fetch('/api/trades/open')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('positions-body');
                    tbody.innerHTML = '';
                    
                    // Update last update time
                    const now = new Date();
                    document.getElementById('positions-last-update').textContent = 
                        `Last updated: ${now.toLocaleTimeString()}`;
                    
                    if (data.positions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" class="loading">No open positions</td></tr>';
                        return;
                    }
                    
                    const currencySymbol = getCurrencySymbol(accountCurrency);
                    
                    data.positions.forEach(pos => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${pos.ticket}</td>
                            <td>${pos.symbol}</td>
                            <td><span class="badge ${pos.type === 'BUY' ? 'badge-success' : 'badge-danger'}">${pos.type}</span></td>
                            <td>${pos.volume}</td>
                            <td>${pos.price_open.toFixed(5)}</td>
                            <td>${pos.price_current.toFixed(5)}</td>
                            <td>${pos.sl.toFixed(5)}</td>
                            <td>${pos.tp.toFixed(5)}</td>
                            <td class="${pos.profit >= 0 ? 'positive' : 'negative'}">${currencySymbol}${pos.profit.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.85em;" 
                                        onclick="closePosition(${pos.ticket}, '${pos.symbol}')" 
                                        title="Close this position">
                                    ‚úï Close
                                </button>
                            </td>
                        `;
                    });
                })
                .catch(err => {
                    console.error('Failed to load positions:', err);
                    document.getElementById('positions-last-update').textContent = 
                        `Last updated: Error - ${err.message}`;
                });
        }
        
        function closePosition(ticket, symbol) {
            if (!confirm(`Close position ${ticket} (${symbol})?\n\nThis will immediately close the position at market price.`)) {
                return;
            }
            
            // Disable all close buttons during operation
            const closeButtons = document.querySelectorAll('#positions-body button');
            closeButtons.forEach(btn => btn.disabled = true);
            
            fetch(`/api/trades/close/${ticket}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(`Position ${ticket} closed successfully. Profit: ${data.profit.toFixed(2)}`, 'success');
                    // Refresh positions immediately
                    loadPositions();
                    // Also refresh status to update account balance
                    loadStatus();
                } else {
                    showToast(`Failed to close position: ${data.message}`, 'error');
                }
            })
            .catch(err => {
                showToast(`Error closing position: ${err.message}`, 'error');
            })
            .finally(() => {
                // Re-enable buttons
                const closeButtons = document.querySelectorAll('#positions-body button');
                closeButtons.forEach(btn => btn.disabled = false);
            });
        }
        
        function startPositionsAutoRefresh() {
            // Clear any existing interval
            if (positionsRefreshInterval) {
                clearInterval(positionsRefreshInterval);
            }
            
            // Load immediately
            loadPositions();
            
            // Then refresh every 1 second for real-time updates
            positionsRefreshInterval = setInterval(loadPositions, 1000);
        }
        
        function stopPositionsAutoRefresh() {
            if (positionsRefreshInterval) {
                clearInterval(positionsRefreshInterval);
                positionsRefreshInterval = null;
            }
        }
        
        function loadRecommendations() {
            fetch('/api/analysis/recommendations')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('recommendations-container');
                    container.innerHTML = '';
                    
                    data.recommendations.forEach(rec => {
                        const div = document.createElement('div');
                        div.className = 'recommendation';
                        div.innerHTML = `
                            <h3>Priority ${rec.priority}: ${rec.title}</h3>
                            <p>${rec.description}</p>
                            <p class="impact">${rec.impact}</p>
                            <button class="btn btn-secondary" onclick="alert('${rec.action}')">${rec.action}</button>
                        `;
                        container.appendChild(div);
                    });
                });
        }
        
        // Load charts
        let charts = {};
        
        function loadCharts() {
            fetch('/api/charts/data')
                .then(r => r.json())
                .then(data => {
                    // Destroy existing charts
                    Object.values(charts).forEach(chart => chart.destroy());
                    charts = {};
                    
                    // Profit by Symbol
                    const symbolLabels = Object.keys(data.symbol_profits);
                    const symbolProfits = Object.values(data.symbol_profits);
                    const symbolColors = symbolProfits.map(p => p >= 0 ? '#10b981' : '#ef4444');
                    
                    charts.symbolProfit = new Chart(document.getElementById('symbol-profit-chart'), {
                        type: 'bar',
                        data: {
                            labels: symbolLabels,
                            datasets: [{
                                label: 'Profit ($)',
                                data: symbolProfits,
                                backgroundColor: symbolColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Win/Loss by Symbol
                    const winLossLabels = Object.keys(data.symbol_wins);
                    const wins = Object.values(data.symbol_wins);
                    const losses = Object.values(data.symbol_losses);
                    
                    charts.symbolWinLoss = new Chart(document.getElementById('symbol-winloss-chart'), {
                        type: 'bar',
                        data: {
                            labels: winLossLabels,
                            datasets: [
                                {
                                    label: 'Wins',
                                    data: wins,
                                    backgroundColor: '#10b981'
                                },
                                {
                                    label: 'Losses',
                                    data: losses,
                                    backgroundColor: '#ef4444'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Daily Profit Trend
                    charts.dailyProfit = new Chart(document.getElementById('daily-profit-chart'), {
                        type: 'line',
                        data: {
                            labels: data.daily_labels,
                            datasets: [{
                                label: 'Daily Profit ($)',
                                data: data.daily_values,
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Hourly Performance
                    const hourlyLabels = Object.keys(data.hourly_profits).map(h => h + ':00');
                    const hourlyProfits = Object.values(data.hourly_profits);
                    const hourlyColors = hourlyProfits.map(p => p >= 0 ? '#10b981' : '#ef4444');
                    
                    charts.hourlyProfit = new Chart(document.getElementById('hourly-profit-chart'), {
                        type: 'bar',
                        data: {
                            labels: hourlyLabels,
                            datasets: [{
                                label: 'Profit ($)',
                                data: hourlyProfits,
                                backgroundColor: hourlyColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Trade Distribution (Doughnut)
                    const tradeLabels = Object.keys(data.symbol_trades);
                    const tradeCounts = Object.values(data.symbol_trades);
                    
                    charts.tradeDistribution = new Chart(document.getElementById('trade-distribution-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: tradeLabels,
                            datasets: [{
                                data: tradeCounts,
                                backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { color: '#94a3b8' }
                                }
                            }
                        }
                    });
                });
        }
        
        // Apply chart date range filter
        function applyChartDateRange() {
            const dateRange = document.getElementById('chart-date-range').value;
            
            // Show loading state
            const chartContainers = document.querySelectorAll('.chart-container canvas');
            chartContainers.forEach(canvas => {
                canvas.style.opacity = '0.5';
            });
            
            // Fetch filtered chart data
            fetch(`/api/charts/data?range=${dateRange}`)
                .then(r => r.json())
                .then(data => {
                    // Destroy existing charts
                    Object.values(charts).forEach(chart => chart.destroy());
                    charts = {};
                    
                    // Get range label for chart titles
                    const rangeLabels = {
                        'all': 'All Time',
                        'today': 'Today',
                        'last7days': 'Last 7 Days',
                        'last30days': 'Last 30 Days',
                        'thisweek': 'This Week',
                        'lastweek': 'Last Week',
                        'thismonth': 'This Month',
                        'lastmonth': 'Last Month'
                    };
                    const rangeLabel = rangeLabels[dateRange] || 'All Time';
                    
                    // Profit by Symbol
                    const symbolLabels = Object.keys(data.symbol_profits);
                    const symbolProfits = Object.values(data.symbol_profits);
                    const symbolColors = symbolProfits.map(p => p >= 0 ? '#10b981' : '#ef4444');
                    
                    charts.symbolProfit = new Chart(document.getElementById('symbol-profit-chart'), {
                        type: 'bar',
                        data: {
                            labels: symbolLabels,
                            datasets: [{
                                label: 'Profit ($)',
                                data: symbolProfits,
                                backgroundColor: symbolColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: `Profit by Symbol (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Win/Loss by Symbol
                    const winLossLabels = Object.keys(data.symbol_wins);
                    const wins = Object.values(data.symbol_wins);
                    const losses = Object.values(data.symbol_losses);
                    
                    charts.symbolWinLoss = new Chart(document.getElementById('symbol-winloss-chart'), {
                        type: 'bar',
                        data: {
                            labels: winLossLabels,
                            datasets: [
                                {
                                    label: 'Wins',
                                    data: wins,
                                    backgroundColor: '#10b981'
                                },
                                {
                                    label: 'Losses',
                                    data: losses,
                                    backgroundColor: '#ef4444'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                },
                                title: {
                                    display: true,
                                    text: `Win/Loss by Symbol (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Daily Profit Trend
                    charts.dailyProfit = new Chart(document.getElementById('daily-profit-chart'), {
                        type: 'line',
                        data: {
                            labels: data.daily_labels,
                            datasets: [{
                                label: 'Daily Profit ($)',
                                data: data.daily_values,
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                },
                                title: {
                                    display: true,
                                    text: `Daily Profit Trend (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Hourly Performance
                    const hourlyLabels = Object.keys(data.hourly_profits).map(h => h + ':00');
                    const hourlyProfits = Object.values(data.hourly_profits);
                    const hourlyColors = hourlyProfits.map(p => p >= 0 ? '#10b981' : '#ef4444');
                    
                    charts.hourlyProfit = new Chart(document.getElementById('hourly-profit-chart'), {
                        type: 'bar',
                        data: {
                            labels: hourlyLabels,
                            datasets: [{
                                label: 'Profit ($)',
                                data: hourlyProfits,
                                backgroundColor: hourlyColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: `Hourly Performance (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                    
                    // Trade Distribution (Doughnut)
                    const tradeLabels = Object.keys(data.symbol_trades);
                    const tradeCounts = Object.values(data.symbol_trades);
                    
                    charts.tradeDistribution = new Chart(document.getElementById('trade-distribution-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: tradeLabels,
                            datasets: [{
                                data: tradeCounts,
                                backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { color: '#94a3b8' }
                                },
                                title: {
                                    display: true,
                                    text: `Trade Distribution (${rangeLabel})`,
                                    color: '#94a3b8'
                                }
                            }
                        }
                    });
                    
                    // Restore opacity
                    chartContainers.forEach(canvas => {
                        canvas.style.opacity = '1';
                    });
                    
                    // Show success toast
                    showToast(`Charts updated for ${rangeLabel}`, 'success');
                })
                .catch(err => {
                    console.error('Failed to load chart data:', err);
                    showToast('Failed to update charts', 'error');
                    
                    // Restore opacity
                    chartContainers.forEach(canvas => {
                        canvas.style.opacity = '1';
                    });
                });
        }
        
        // Accordion toggle functionality
        function toggleAccordion(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const header = event.currentTarget;
            
            header.classList.toggle('active');
            content.classList.toggle('active');
        }
        
        // Configuration presets
        const configPresets = {
            profitable: {
                timeframe: '15', // M15 - Optimized
                risk_percent: 0.5,
                reward_ratio: 2.0,
                min_confidence: 50,
                max_daily_loss: 3,
                analysis_bars: 200,
                fast_ma: 20,
                slow_ma: 50,
                rsi_period: 14,
                rsi_overbought: 70,
                rsi_oversold: 30,
                macd_fast: 12,
                macd_slow: 26,
                macd_signal: 9,
                macd_min_histogram: 0.0005,
                atr_period: 14,
                atr_multiplier: 2.0,
                adx_min: 25,
                use_rsi: 'true',
                
                // Pip-Based TP/SL (disabled by default)
                use_pip_based_sl: 'false',
                sl_pips: 50,
                use_pip_based_tp: 'false',
                tp_pips: 100,
                use_macd: 'true',
                use_adx: 'true',
                use_trend_filter: 'true',
                trend_ma_period: 100,
                enable_trading_hours: 'false',
                trading_start_hour: 0,
                trading_end_hour: 23,
                avoid_news: 'true',
                news_buffer: 60,
                use_split_orders: 'true',
                num_positions: 3,
                tp_level_1: 1.5,
                tp_level_2: 2.5,
                tp_level_3: 4.0,
                max_lot_per_order: 0.5,
                max_trades_total: 10,
                max_trades_per_symbol: 3,
                enable_trailing: 'true',
                trail_activation: 1.5,
                trail_distance: 1.0,
                enable_adaptive_risk: 'true',
                max_risk_multiplier: 1.5,
                min_risk_multiplier: 0.5,
                max_drawdown: 10,
                max_daily_trades: 999
            },
            conservative: {
                timeframe: '16388', // H4
                risk_percent: 0.3,
                reward_ratio: 2.5,
                min_confidence: 50,
                max_daily_loss: 2,
                analysis_bars: 300,
                fast_ma: 20,
                slow_ma: 50,
                rsi_period: 14,
                rsi_overbought: 65,
                rsi_oversold: 35,
                macd_fast: 12,
                macd_slow: 26,
                macd_signal: 9,
                macd_min_histogram: 0.0005,
                atr_period: 14,
                atr_multiplier: 2.5,
                adx_min: 30,
                use_rsi: 'true',
                use_macd: 'true',
                use_adx: 'true',
                use_trend_filter: 'true',
                trend_ma_period: 100,
                enable_trading_hours: 'false',
                trading_start_hour: 0,
                trading_end_hour: 23,
                avoid_news: 'true',
                news_buffer: 90,
                use_split_orders: 'true',
                num_positions: 3,
                tp_level_1: 2.0,
                tp_level_2: 3.0,
                tp_level_3: 5.0,
                max_lot_per_order: 0.3,
                max_trades_total: 5,
                max_trades_per_symbol: 2,
                enable_trailing: 'true',
                trail_activation: 2.0,
                trail_distance: 1.2,
                enable_adaptive_risk: 'true',
                max_risk_multiplier: 1.2,
                min_risk_multiplier: 0.3,
                max_drawdown: 8,
                max_daily_trades: 999
            },
            aggressive: {
                timeframe: '30', // M30
                risk_percent: 1.0,
                reward_ratio: 1.5,
                min_confidence: 50,
                max_daily_loss: 5,
                analysis_bars: 150,
                fast_ma: 10,
                slow_ma: 30,
                rsi_period: 14,
                rsi_overbought: 75,
                rsi_oversold: 25,
                macd_fast: 12,
                macd_slow: 26,
                macd_signal: 9,
                macd_min_histogram: 0.0005,
                atr_period: 14,
                atr_multiplier: 1.5,
                adx_min: 20,
                use_rsi: 'true',
                use_macd: 'true',
                use_adx: 'true',
                use_trend_filter: 'false',
                trend_ma_period: 50,
                enable_trading_hours: 'false',
                trading_start_hour: 0,
                trading_end_hour: 23,
                avoid_news: 'false',
                news_buffer: 30,
                use_split_orders: 'true',
                num_positions: 3,
                tp_level_1: 1.0,
                tp_level_2: 1.5,
                tp_level_3: 2.5,
                max_lot_per_order: 1.0,
                max_trades_total: 20,
                max_trades_per_symbol: 5,
                enable_trailing: 'true',
                trail_activation: 1.0,
                trail_distance: 0.8,
                enable_adaptive_risk: 'true',
                max_risk_multiplier: 2.0,
                min_risk_multiplier: 0.5,
                max_drawdown: 15,
                max_daily_trades: 999
            },
            crypto: {
                timeframe: '16385', // H1
                risk_percent: 0.3,
                reward_ratio: 2.5,
                min_confidence: 50,
                max_daily_loss: 4,
                analysis_bars: 250,
                fast_ma: 15,
                slow_ma: 35,
                rsi_period: 14,
                rsi_overbought: 75,
                rsi_oversold: 25,
                macd_fast: 12,
                macd_slow: 26,
                macd_signal: 9,
                macd_min_histogram: 0.0005,
                atr_period: 14,
                atr_multiplier: 1.8,
                adx_min: 25,
                use_rsi: 'true',
                use_macd: 'true',
                use_adx: 'true',
                use_trend_filter: 'true',
                trend_ma_period: 50,
                enable_trading_hours: 'false',
                trading_start_hour: 0,
                trading_end_hour: 23,
                avoid_news: 'true',
                news_buffer: 120,
                use_split_orders: 'true',
                num_positions: 3,
                tp_level_1: 2.0,
                tp_level_2: 3.5,
                tp_level_3: 6.0,
                max_lot_per_order: 0.3,
                max_trades_total: 8,
                max_trades_per_symbol: 2,
                enable_trailing: 'true',
                trail_activation: 1.5,
                trail_distance: 1.2,
                enable_adaptive_risk: 'true',
                max_risk_multiplier: 1.8,
                min_risk_multiplier: 0.4,
                max_drawdown: 12,
                max_daily_trades: 999
            }
        };
        
        // Load preset configuration
        function loadPreset() {
            const preset = document.getElementById('config-preset').value;
            
            if (preset === 'custom') {
                showToast('üí° Custom mode: Adjust settings manually', 'info');
                return;
            }
            
            const config = configPresets[preset];
            if (!config) return;
            
            // Basic settings
            document.getElementById('timeframe').value = config.timeframe;
            document.getElementById('risk-percent').value = config.risk_percent;
            document.getElementById('reward-ratio').value = config.reward_ratio;
            document.getElementById('min-confidence').value = config.min_confidence;
            document.getElementById('max-daily-loss').value = config.max_daily_loss;
            document.getElementById('analysis-bars').value = config.analysis_bars || 200;
            
            // Indicators
            document.getElementById('fast-ma').value = config.fast_ma;
            document.getElementById('slow-ma').value = config.slow_ma;
            document.getElementById('rsi-period').value = config.rsi_period;
            document.getElementById('rsi-overbought').value = config.rsi_overbought;
            document.getElementById('rsi-oversold').value = config.rsi_oversold;
            document.getElementById('macd-fast').value = config.macd_fast;
            document.getElementById('macd-slow').value = config.macd_slow;
            document.getElementById('macd-signal').value = config.macd_signal;
            document.getElementById('macd-min-histogram').value = config.macd_min_histogram;
            document.getElementById('atr-period').value = config.atr_period;
            document.getElementById('atr-multiplier').value = config.atr_multiplier;
            document.getElementById('adx-min').value = config.adx_min;

            // Hour Filter Settings
            document.getElementById('enable-hour-filter').checked = config.enable_hour_filter !== false;
            document.getElementById('golden-hours').value = (config.golden_hours || [8,11,13,14,15,19,23]).join(',');
            document.getElementById('dead-hours').value = (config.dead_hours || [0,1,2,17,20,21,22]).join(',');
            document.getElementById('roc-threshold').value = config.roc_threshold || 0.15;
            
            // Time-Based Exit Settings
            document.getElementById('enable-time-based-exit').checked = config.enable_time_based_exit === true;
            document.getElementById('max-hold-minutes').value = config.max_hold_minutes || 45;
            
            // Breakeven Stop Settings
            document.getElementById('enable-breakeven-stop').checked = config.enable_breakeven_stop !== false;
            document.getElementById('breakeven-atr-threshold').value = config.breakeven_atr_threshold || 0.3;
            
            
            // Pip-Based TP/SL
            document.getElementById('use-pip-based-sl').value = config.use_pip_based_sl !== undefined ? String(config.use_pip_based_sl) : 'false';
            document.getElementById('sl-pips').value = config.sl_pips || 50;
            document.getElementById('use-pip-based-tp').value = config.use_pip_based_tp !== undefined ? String(config.use_pip_based_tp) : 'false';
            document.getElementById('tp-pips').value = config.tp_pips || 100;
            updateTPSLMethodWarning();
            
            // TP Caps
            const tpCaps = config.scalp_tp_caps || {
                'XAUUSD': 2.0,
                'XAGUSD': 0.25,
                'XPTUSD': 3.0,
                'XPDUSD': 5.0,
                'DEFAULT': 0.01
            };
            document.getElementById('tp-cap-xauusd').value = tpCaps.XAUUSD || 2.0;
            document.getElementById('tp-cap-xagusd').value = tpCaps.XAGUSD || 0.25;
            document.getElementById('tp-cap-xptusd').value = tpCaps.XPTUSD || 3.0;
            document.getElementById('tp-cap-xpdusd').value = tpCaps.XPDUSD || 5.0;
            document.getElementById('tp-cap-default').value = tpCaps.DEFAULT || 0.01;
            
            // Filters
            document.getElementById('use-rsi').value = config.use_rsi;
            document.getElementById('use-macd').value = config.use_macd;
            document.getElementById('use-adx').value = config.use_adx;
            document.getElementById('use-trend-filter').value = config.use_trend_filter;
            document.getElementById('trend-ma-period').value = config.trend_ma_period;
            document.getElementById('enable-trading-hours').value = config.enable_trading_hours;
            document.getElementById('trading-start-hour').value = config.trading_start_hour;
            document.getElementById('trading-end-hour').value = config.trading_end_hour;
            document.getElementById('avoid-news').value = config.avoid_news;
            document.getElementById('news-buffer').value = config.news_buffer;
            
            // Position Management
            document.getElementById('use-split-orders').value = config.use_split_orders;
            document.getElementById('num-positions').value = config.num_positions;
            
            // Load TP levels from array (with fallback to individual fields for backward compatibility)
            const tpLevels = config.tp_levels || [config.tp_level_1 || 1.5, config.tp_level_2 || 2.5, config.tp_level_3 || 4.0];
            document.getElementById('tp-level-1').value = tpLevels[0];
            document.getElementById('tp-level-2').value = tpLevels[1];
            document.getElementById('tp-level-3').value = tpLevels[2];
            document.getElementById('max-lot-per-order').value = config.max_lot_per_order || 0.5;
            document.getElementById('max-trades-total').value = config.max_trades_total;
            document.getElementById('max-trades-per-symbol').value = config.max_trades_per_symbol;
            document.getElementById('enable-trailing').value = config.enable_trailing;
            document.getElementById('trail-activation').value = config.trail_activation;
            document.getElementById('trail-distance').value = config.trail_distance;
            
            // Risk Management
            document.getElementById('enable-adaptive-risk').value = config.enable_adaptive_risk;
            document.getElementById('max-risk-multiplier').value = config.max_risk_multiplier;
            document.getElementById('min-risk-multiplier').value = config.min_risk_multiplier;
            document.getElementById('max-drawdown').value = config.max_drawdown;
            document.getElementById('max-daily-trades').value = config.max_daily_trades;
            
            // Volume Analysis
            document.getElementById('use-volume-filter').value = config.use_volume_filter !== undefined ? config.use_volume_filter : true;
            document.getElementById('min-volume-ma').value = config.min_volume_ma || 1.2;
            document.getElementById('volume-ma-period').value = config.volume_ma_period || 20;
            document.getElementById('obv-period').value = config.obv_period || 20;
            
            // Validate after loading
            validateRisk();
            validateConfidence();
            validateDailyLoss();
            validateMaxLotSize();
            validateAnalysisBars();
            
            const presetNames = {
                profitable: 'Profitable Balanced',
                conservative: 'Conservative',
                aggressive: 'Aggressive',
                crypto: 'Crypto Trading'
            };
            
            showToast(`‚úÖ Loaded ${presetNames[preset]} preset`, 'success');
        }
        
        // Save configuration
        document.getElementById('config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate all inputs
            if (!validateAllInputs()) {
                showToast('‚ùå Please fix validation errors before saving', 'error');
                return;
            }
            
            const btn = document.getElementById('save-config-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Saving...';
            
            // Collect all configuration values
            const config = {
                // Basic settings
                symbols: Array.from(document.getElementById('symbols').selectedOptions).map(o => o.value),
                timeframe: parseInt(document.getElementById('timeframe').value),
                risk_percent: parseFloat(document.getElementById('risk-percent').value),
                reward_ratio: parseFloat(document.getElementById('reward-ratio').value),
                min_trade_confidence: parseFloat(document.getElementById('min-confidence').value) / 100,
                max_daily_loss_percent: parseFloat(document.getElementById('max-daily-loss').value),
                analysis_bars: parseInt(document.getElementById('analysis-bars').value),
                
                // Indicators
                fast_ma_period: parseInt(document.getElementById('fast-ma').value),
                slow_ma_period: parseInt(document.getElementById('slow-ma').value),
                rsi_period: parseInt(document.getElementById('rsi-period').value),
                rsi_overbought: parseInt(document.getElementById('rsi-overbought').value),
                rsi_oversold: parseInt(document.getElementById('rsi-oversold').value),
                macd_fast: parseInt(document.getElementById('macd-fast').value),
                macd_slow: parseInt(document.getElementById('macd-slow').value),
                macd_signal: parseInt(document.getElementById('macd-signal').value),
                macd_min_histogram: parseFloat(document.getElementById('macd-min-histogram').value),
                atr_period: parseInt(document.getElementById('atr-period').value),
                atr_multiplier: parseFloat(document.getElementById('atr-multiplier').value),
                adx_min_strength: parseInt(document.getElementById('adx-min').value),

                // Hour Filter Settings
                enable_hour_filter: document.getElementById('enable-hour-filter').checked,
                golden_hours: document.getElementById('golden-hours').value.split(',').map(h => parseInt(h.trim())).filter(h => !isNaN(h)),
                dead_hours: document.getElementById('dead-hours').value.split(',').map(h => parseInt(h.trim())).filter(h => !isNaN(h)),
                roc_threshold: parseFloat(document.getElementById('roc-threshold').value),
                
                // Time-Based Exit Settings
                enable_time_based_exit: document.getElementById('enable-time-based-exit').checked,
                max_hold_minutes: parseInt(document.getElementById('max-hold-minutes').value),
                
                // Breakeven Stop Settings
                enable_breakeven_stop: document.getElementById('enable-breakeven-stop').checked,
                breakeven_atr_threshold: parseFloat(document.getElementById('breakeven-atr-threshold').value),
                
                
                // Pip-Based TP/SL
                use_pip_based_sl: document.getElementById('use-pip-based-sl').value === 'true',
                sl_pips: parseFloat(document.getElementById('sl-pips').value),
                use_pip_based_tp: document.getElementById('use-pip-based-tp').value === 'true',
                tp_pips: parseFloat(document.getElementById('tp-pips').value),
                
                // TP Caps
                scalp_tp_caps: {
                    'XAUUSD': parseFloat(document.getElementById('tp-cap-xauusd').value),
                    'XAGUSD': parseFloat(document.getElementById('tp-cap-xagusd').value),
                    'XPTUSD': parseFloat(document.getElementById('tp-cap-xptusd').value),
                    'XPDUSD': parseFloat(document.getElementById('tp-cap-xpdusd').value),
                    'DEFAULT': parseFloat(document.getElementById('tp-cap-default').value)
                },
                
                // Filters
                use_rsi: document.getElementById('use-rsi').value === 'true',
                use_macd: document.getElementById('use-macd').value === 'true',
                use_adx: document.getElementById('use-adx').value === 'true',
                use_trend_filter: document.getElementById('use-trend-filter').value === 'true',
                trend_ma_period: parseInt(document.getElementById('trend-ma-period').value),
                enable_trading_hours: document.getElementById('enable-trading-hours').value === 'true',
                trading_start_hour: parseInt(document.getElementById('trading-start-hour').value),
                trading_end_hour: parseInt(document.getElementById('trading-end-hour').value),
                avoid_news_trading: document.getElementById('avoid-news').value === 'true',
                news_buffer_minutes: parseInt(document.getElementById('news-buffer').value),
                
                // Position Management
                use_split_orders: document.getElementById('use-split-orders').value === 'true',
                num_positions: parseInt(document.getElementById('num-positions').value),
                tp_levels: [
                    parseFloat(document.getElementById('tp-level-1').value),
                    parseFloat(document.getElementById('tp-level-2').value),
                    parseFloat(document.getElementById('tp-level-3').value)
                ],
                max_lot_per_order: parseFloat(document.getElementById('max-lot-per-order').value),
                max_trades_total: parseInt(document.getElementById('max-trades-total').value),
                max_trades_per_symbol: parseInt(document.getElementById('max-trades-per-symbol').value),
                enable_trailing_stop: document.getElementById('enable-trailing').value === 'true',
                trail_activation: parseFloat(document.getElementById('trail-activation').value),
                trail_distance: parseFloat(document.getElementById('trail-distance').value),
                
                // Risk Management
                use_adaptive_risk: document.getElementById('enable-adaptive-risk').value === 'true',
                max_risk_multiplier: parseFloat(document.getElementById('max-risk-multiplier').value),
                min_risk_multiplier: parseFloat(document.getElementById('min-risk-multiplier').value),
                max_drawdown_percent: parseFloat(document.getElementById('max-drawdown').value),
                max_daily_trades: parseInt(document.getElementById('max-daily-trades').value),
                
                // Volume Analysis
                use_volume_filter: document.getElementById('use-volume-filter').value === 'true',
                min_volume_ma: parseFloat(document.getElementById('min-volume-ma').value),
                volume_ma_period: parseInt(document.getElementById('volume-ma-period').value),
                obv_period: parseInt(document.getElementById('obv-period').value),
                
                // Advanced Trend Detection
                use_trend_detection: document.getElementById('use-trend-detection').value === 'true',
                trend_detection_sensitivity: parseInt(document.getElementById('trend-detection-sensitivity').value),
                min_trend_confidence: parseFloat(document.getElementById('min-trend-confidence').value) / 100,
                enable_early_signals: document.getElementById('enable-early-signals').value === 'true',
                max_analysis_time_ms: parseInt(document.getElementById('max-analysis-time-ms').value),
                
                // EMA Settings
                ema_fast_period: parseInt(document.getElementById('ema-fast-period').value),
                ema_slow_period: parseInt(document.getElementById('ema-slow-period').value),
                
                // Aroon Settings
                aroon_period: parseInt(document.getElementById('aroon-period').value),
                aroon_threshold: parseInt(document.getElementById('aroon-threshold').value),
                
                // Market Structure Settings
                min_swing_strength: parseInt(document.getElementById('min-swing-strength').value),
                structure_break_threshold: parseFloat(document.getElementById('structure-break-threshold').value) / 100,
                
                // Divergence Settings
                divergence_lookback: parseInt(document.getElementById('divergence-lookback').value),
                min_divergence_strength: parseFloat(document.getElementById('min-divergence-strength').value),
                
                // Trendline Settings
                max_trendlines: parseInt(document.getElementById('max-trendlines').value),
                min_trendline_touches: parseInt(document.getElementById('min-trendline-touches').value),
                trendline_angle_min: parseInt(document.getElementById('trendline-angle-min').value),
                trendline_angle_max: parseInt(document.getElementById('trendline-angle-max').value),
                
                // Multi-Timeframe Settings
                enable_mtf_confirmation: document.getElementById('enable-mtf-confirmation').value === 'true',
                mtf_weight: parseFloat(document.getElementById('mtf-weight').value),
                mtf_alignment_threshold: parseFloat(document.getElementById('mtf-alignment-threshold').value),
                mtf_contradiction_penalty: parseFloat(document.getElementById('mtf-contradiction-penalty').value),
                
                // Volume Analysis (including spike threshold)
                volume_spike_threshold: parseFloat(document.getElementById('volume-spike-threshold').value),
                
                // ML Features
                pattern_enabled: document.getElementById('pattern_enabled').checked,
                sentiment_enabled: document.getElementById('sentiment_enabled').checked,
                ml_enabled: document.getElementById('ml_enabled').checked,
                
                technical_weight: parseFloat(document.getElementById('technical_weight').value),
                ml_weight: parseFloat(document.getElementById('ml_weight').value),
                sentiment_weight: parseFloat(document.getElementById('sentiment_weight').value),
                pattern_weight: parseFloat(document.getElementById('pattern_weight').value),
                
                ml_min_confidence: parseFloat(document.getElementById('ml_min_confidence').value),
                ml_require_agreement: document.getElementById('ml_require_agreement').value,
                
                ml_model_path: document.getElementById('ml_model_path').value,
                ml_training_data_path: document.getElementById('ml_training_data_path').value,
                news_data_path: document.getElementById('news_data_path').value,
                
                ml_auto_retrain: document.getElementById('ml_auto_retrain').checked,
                ml_retrain_frequency: document.getElementById('ml_retrain_frequency').value,
                ml_min_training_samples: parseInt(document.getElementById('ml_min_training_samples').value),
                
                pattern_min_confidence: parseFloat(document.getElementById('pattern_min_confidence').value),
                pattern_lookback: parseInt(document.getElementById('pattern_lookback').value),
                
                sentiment_cache_duration: parseFloat(document.getElementById('sentiment_cache_duration').value),
                sentiment_min_confidence: parseFloat(document.getElementById('sentiment_min_confidence').value)
            };
            
            fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('‚úÖ Configuration saved successfully!', 'success');
                } else {
                    showToast('‚ùå Failed to save: ' + data.message, 'error');
                }
            })
            .catch(err => {
                showToast('‚ùå Error saving configuration: ' + err.message, 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = 'üíæ Save Configuration';
            });
        });
        
        // Load configuration from API and update form fields
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                console.log('Loading configuration:', config);
                
                // Update form fields with API values
                if (config.symbols) {
                    const symbolSelect = document.getElementById('symbols');
                    Array.from(symbolSelect.options).forEach(option => {
                        option.selected = config.symbols.includes(option.value);
                    });
                }
                
                if (config.timeframe) document.getElementById('timeframe').value = config.timeframe;
                if (config.risk_percent) document.getElementById('risk-percent').value = config.risk_percent;
                if (config.min_trade_confidence) document.getElementById('min-confidence').value = config.min_trade_confidence * 100;
                if (config.max_daily_loss_percent) document.getElementById('max-daily-loss').value = config.max_daily_loss_percent;
                
                // RSI Configuration
                if (config.rsi_overbought) document.getElementById('rsi-overbought').value = config.rsi_overbought;
                if (config.rsi_oversold) document.getElementById('rsi-oversold').value = config.rsi_oversold;
                if (config.rsi_period) document.getElementById('rsi-period').value = config.rsi_period;
                
                // MACD Configuration
                if (config.macd_fast) document.getElementById('macd-fast').value = config.macd_fast;
                if (config.macd_slow) document.getElementById('macd-slow').value = config.macd_slow;
                if (config.macd_signal) document.getElementById('macd-signal').value = config.macd_signal;
                if (config.macd_min_histogram) document.getElementById('macd-min-histogram').value = config.macd_min_histogram;
                
                // Volume Filter
                if (config.use_volume_filter !== undefined) document.getElementById('use-volume-filter').value = config.use_volume_filter.toString();
                if (config.min_volume_ma) document.getElementById('min-volume-ma').value = config.min_volume_ma;
                if (config.volume_ma_period) document.getElementById('volume-ma-period').value = config.volume_ma_period;
                if (config.obv_period) document.getElementById('obv-period').value = config.obv_period;
                
                // Advanced Trend Detection
                if (config.use_trend_detection !== undefined) document.getElementById('use-trend-detection').value = config.use_trend_detection.toString();
                if (config.trend_detection_sensitivity) document.getElementById('trend-detection-sensitivity').value = config.trend_detection_sensitivity;
                if (config.min_trend_confidence) document.getElementById('min-trend-confidence').value = config.min_trend_confidence * 100;
                if (config.enable_early_signals !== undefined) document.getElementById('enable-early-signals').value = config.enable_early_signals.toString();
                if (config.max_analysis_time_ms) document.getElementById('max-analysis-time-ms').value = config.max_analysis_time_ms;
                
                // EMA Settings
                if (config.ema_fast_period) document.getElementById('ema-fast-period').value = config.ema_fast_period;
                if (config.ema_slow_period) document.getElementById('ema-slow-period').value = config.ema_slow_period;
                
                // Aroon Settings
                if (config.aroon_period) document.getElementById('aroon-period').value = config.aroon_period;
                if (config.aroon_threshold) document.getElementById('aroon-threshold').value = config.aroon_threshold;
                
                // Market Structure Settings
                if (config.min_swing_strength) document.getElementById('min-swing-strength').value = config.min_swing_strength;
                if (config.structure_break_threshold) document.getElementById('structure-break-threshold').value = config.structure_break_threshold * 100;
                
                // Divergence Settings
                if (config.divergence_lookback) document.getElementById('divergence-lookback').value = config.divergence_lookback;
                if (config.min_divergence_strength) document.getElementById('min-divergence-strength').value = config.min_divergence_strength;
                
                // Trendline Settings
                if (config.max_trendlines) document.getElementById('max-trendlines').value = config.max_trendlines;
                if (config.min_trendline_touches) document.getElementById('min-trendline-touches').value = config.min_trendline_touches;
                if (config.trendline_angle_min) document.getElementById('trendline-angle-min').value = config.trendline_angle_min;
                if (config.trendline_angle_max) document.getElementById('trendline-angle-max').value = config.trendline_angle_max;
                
                // Multi-Timeframe Settings
                if (config.enable_mtf_confirmation !== undefined) document.getElementById('enable-mtf-confirmation').value = config.enable_mtf_confirmation.toString();
                if (config.mtf_weight) document.getElementById('mtf-weight').value = config.mtf_weight;
                if (config.mtf_alignment_threshold) document.getElementById('mtf-alignment-threshold').value = config.mtf_alignment_threshold;
                if (config.mtf_contradiction_penalty) document.getElementById('mtf-contradiction-penalty').value = config.mtf_contradiction_penalty;
                
                // Volume Analysis (including spike threshold)
                if (config.volume_spike_threshold) document.getElementById('volume-spike-threshold').value = config.volume_spike_threshold;
                
                // Pip-Based TP/SL
                if (config.use_pip_based_sl !== undefined) document.getElementById('use-pip-based-sl').value = config.use_pip_based_sl.toString();
                if (config.sl_pips) document.getElementById('sl-pips').value = config.sl_pips;
                if (config.use_pip_based_tp !== undefined) document.getElementById('use-pip-based-tp').value = config.use_pip_based_tp.toString();
                if (config.tp_pips) document.getElementById('tp-pips').value = config.tp_pips;
                
                // Update pip-based controls state
                updateTPSLMethodWarning();
                
                console.log('‚úÖ Configuration loaded successfully');
                console.log('RSI Overbought loaded as:', config.rsi_overbought);
                
                // Load ML configuration
                if (config.pattern_enabled !== undefined) document.getElementById('pattern_enabled').checked = config.pattern_enabled;
                if (config.sentiment_enabled !== undefined) document.getElementById('sentiment_enabled').checked = config.sentiment_enabled;
                if (config.ml_enabled !== undefined) document.getElementById('ml_enabled').checked = config.ml_enabled;
                
                if (config.technical_weight) document.getElementById('technical_weight').value = config.technical_weight;
                if (config.ml_weight) document.getElementById('ml_weight').value = config.ml_weight;
                if (config.sentiment_weight) document.getElementById('sentiment_weight').value = config.sentiment_weight;
                if (config.pattern_weight) document.getElementById('pattern_weight').value = config.pattern_weight;
                
                if (config.ml_min_confidence) document.getElementById('ml_min_confidence').value = config.ml_min_confidence;
                if (config.ml_require_agreement) document.getElementById('ml_require_agreement').value = config.ml_require_agreement;
                
                if (config.ml_model_path) document.getElementById('ml_model_path').value = config.ml_model_path;
                if (config.ml_training_data_path) document.getElementById('ml_training_data_path').value = config.ml_training_data_path;
                if (config.news_data_path) document.getElementById('news_data_path').value = config.news_data_path;
                
                if (config.ml_auto_retrain !== undefined) document.getElementById('ml_auto_retrain').checked = config.ml_auto_retrain;
                if (config.ml_retrain_frequency) document.getElementById('ml_retrain_frequency').value = config.ml_retrain_frequency;
                if (config.ml_min_training_samples) document.getElementById('ml_min_training_samples').value = config.ml_min_training_samples;
                
                if (config.pattern_min_confidence) document.getElementById('pattern_min_confidence').value = config.pattern_min_confidence;
                if (config.pattern_lookback) document.getElementById('pattern_lookback').value = config.pattern_lookback;
                
                if (config.sentiment_cache_duration) document.getElementById('sentiment_cache_duration').value = config.sentiment_cache_duration;
                if (config.sentiment_min_confidence) document.getElementById('sentiment_min_confidence').value = config.sentiment_min_confidence;
                
            } catch (error) {
                console.error('‚ùå Failed to load configuration:', error);
            }
        }
        
        // ML Feature Functions
        async function trainMLModel() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Training...';
            
            showMLStatus('Starting ML model training...', 'info');
            
            try {
                // Get paths from config inputs
                const trainingDataPath = document.getElementById('ml_training_data_path')?.value || 'data/training_data.csv';
                const modelPath = document.getElementById('ml_model_path')?.value || 'models/ml_signal_model.pkl';
                
                const response = await fetch('/api/ml/train', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        training_data_path: trainingDataPath,
                        model_path: modelPath
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const stats = result.statistics || {};
                    let statusText = '‚úÖ Model trained successfully!\n';
                    statusText += `Samples: ${stats.samples || 'N/A'}\n`;
                    statusText += `Accuracy: ${stats.accuracy || 'N/A'}%\n`;
                    statusText += `Precision: ${stats.precision || 'N/A'}%\n`;
                    statusText += `Recall: ${stats.recall || 'N/A'}%`;
                    
                    showMLStatus(statusText, 'success');
                    showToast('ML model trained successfully!', 'success');
                } else {
                    showMLStatus('‚ùå Training failed: ' + result.message, 'error');
                    showToast('Training failed: ' + result.message, 'error');
                }
            } catch (error) {
                showMLStatus('‚ùå Training error: ' + error.message, 'error');
                showToast('Training error', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üéì Train ML Model';
            }
        }
        
        async function testMLFeatures() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Testing...';
            
            showMLStatus('Testing ML features...', 'info');
            
            try {
                const response = await fetch('/api/ml/test');
                const result = await response.json();
                
                if (result.success) {
                    let statusText = '‚úÖ ML Features Test Results:\n';
                    statusText += `Pattern Recognition: ${result.pattern_recognition ? '‚úì' : '‚úó'}\n`;
                    statusText += `Sentiment Analysis: ${result.sentiment_analysis ? '‚úì' : '‚úó'}\n`;
                    statusText += `ML Model: ${result.ml_model ? '‚úì' : '‚úó'}\n`;
                    statusText += `Integration: ${result.integration ? '‚úì' : '‚úó'}`;
                    
                    showMLStatus(statusText, 'success');
                    showToast('ML features test complete', 'success');
                } else {
                    showMLStatus('‚ùå Test failed: ' + result.error, 'error');
                    showToast('Test failed', 'error');
                }
            } catch (error) {
                showMLStatus('‚ùå Test error: ' + error.message, 'error');
                showToast('Test error', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üß™ Test ML Features';
            }
        }
        
        async function viewMLStats() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Loading...';
            
            try {
                const response = await fetch('/api/ml/stats');
                const stats = await response.json();
                
                if (stats.success) {
                    let statusText = 'üìä ML Statistics:\n';
                    statusText += `Model Trained: ${stats.model_trained ? 'Yes' : 'No'}\n`;
                    if (stats.model_trained) {
                        statusText += `Training Samples: ${stats.training_samples}\n`;
                        statusText += `Model Accuracy: ${(stats.accuracy * 100).toFixed(1)}%\n`;
                        statusText += `Last Trained: ${stats.last_trained}\n`;
                    }
                    statusText += `Patterns Detected (24h): ${stats.patterns_detected || 0}\n`;
                    statusText += `Sentiment Analyzed (24h): ${stats.sentiment_analyzed || 0}`;
                    
                    showMLStatus(statusText, 'info');
                } else {
                    showMLStatus('‚ùå Failed to load stats', 'error');
                }
            } catch (error) {
                showMLStatus('‚ùå Error loading stats: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üìà View ML Statistics';
            }
        }
        
        async function exportMLData() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Exporting...';
            
            showMLStatus('Exporting training data...', 'info');
            
            try {
                const response = await fetch('/api/ml/export');
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ml_training_data_' + new Date().toISOString().split('T')[0] + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMLStatus('‚úÖ Training data exported successfully', 'success');
                showToast('Data exported successfully', 'success');
            } catch (error) {
                showMLStatus('‚ùå Export error: ' + error.message, 'error');
                showToast('Export failed', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üíæ Export Training Data';
            }
        }
        
        function showMLStatus(message, type) {
            const statusDiv = document.getElementById('ml-status-display');
            const statusText = document.getElementById('ml-status-text');
            
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            statusText.style.whiteSpace = 'pre-line';
            
            // Color based on type
            if (type === 'success') {
                statusDiv.style.borderLeft = '4px solid #10b981';
                statusText.style.color = '#10b981';
            } else if (type === 'error') {
                statusDiv.style.borderLeft = '4px solid #ef4444';
                statusText.style.color = '#ef4444';
            } else {
                statusDiv.style.borderLeft = '4px solid #60a5fa';
                statusText.style.color = '#60a5fa';
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard initializing...');
            loadConfig();
        });
    </script>
</body>
</html>
