<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credentials Form Test</title>
    <link rel="stylesheet" href="../static/css/dashboard.css">
    <style>
        body {
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
        .test-result {
            margin-top: 1rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
        .test-result.pass {
            background-color: #d1fae5;
            color: var(--success-color);
        }
        .test-result.fail {
            background-color: #fee2e2;
            color: var(--danger-color);
        }
    </style>
</head>
<body>
    <h1>Credentials Form Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Kite Form Generation</h2>
        <button onclick="testKiteForm()" class="btn btn-primary">Generate Kite Form</button>
        <div id="kite-form-container" style="margin-top: 1rem;"></div>
        <div id="kite-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Angel One Form with TOTP</h2>
        <button onclick="testAngelForm()" class="btn btn-primary">Generate Angel One Form</button>
        <div id="angel-form-container" style="margin-top: 1rem;"></div>
        <div id="angel-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Form Validation</h2>
        <button onclick="testValidation()" class="btn btn-primary">Test Validation</button>
        <div id="validation-form-container" style="margin-top: 1rem;"></div>
        <div id="validation-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Tooltip Display</h2>
        <button onclick="testTooltips()" class="btn btn-primary">Test Tooltips</button>
        <div id="tooltip-form-container" style="margin-top: 1rem;"></div>
        <div id="tooltip-result" class="test-result" style="display: none;"></div>
    </div>

    <!-- Mock notifications object -->
    <script>
        const notifications = {
            info: (msg) => console.log('INFO:', msg),
            error: (msg) => console.error('ERROR:', msg),
            success: (msg) => console.log('SUCCESS:', msg)
        };
    </script>
    
    <script src="../static/js/credentials-form.js"></script>
    
    <script>
        // Test data
        const kiteFields = [
            {
                name: "api_key",
                type: "text",
                label: "API Key",
                placeholder: "Enter your Kite API Key",
                required: true,
                minlength: 10,
                help: "Get your API Key from https://kite.zerodha.com/apps"
            },
            {
                name: "api_secret",
                type: "password",
                label: "API Secret",
                placeholder: "Enter your Kite API Secret",
                required: true,
                minlength: 10,
                help: "Keep this secret and never share it with anyone"
            }
        ];
        
        const angelFields = [
            {
                name: "client_id",
                type: "text",
                label: "Client ID",
                placeholder: "Enter your Angel One Client ID",
                required: true,
                help: "Your Angel One trading account client ID"
            },
            {
                name: "totp",
                type: "text",
                label: "TOTP",
                placeholder: "Enter 6-digit TOTP",
                required: true,
                pattern: "\\d{6}",
                maxlength: 6,
                help: "Time-based One-Time Password from your authenticator app"
            }
        ];
        
        function testKiteForm() {
            const container = document.getElementById('kite-form-container');
            const result = document.getElementById('kite-result');
            
            try {
                CredentialsForm.generate('kite', kiteFields, container);
                
                // Check if form was generated
                const inputs = container.querySelectorAll('input.form-control');
                const tooltips = container.querySelectorAll('.tooltip-wrapper');
                const passwordToggle = container.querySelector('.password-toggle-btn');
                
                if (inputs.length === 2 && tooltips.length === 2 && passwordToggle) {
                    result.className = 'test-result pass';
                    result.textContent = '✓ PASS: Form generated with 2 inputs, 2 tooltips, and password toggle';
                } else {
                    result.className = 'test-result fail';
                    result.textContent = `✗ FAIL: Expected 2 inputs, 2 tooltips, 1 password toggle. Got ${inputs.length} inputs, ${tooltips.length} tooltips, ${passwordToggle ? 1 : 0} toggle`;
                }
                result.style.display = 'block';
            } catch (error) {
                result.className = 'test-result fail';
                result.textContent = '✗ FAIL: ' + error.message;
                result.style.display = 'block';
            }
        }
        
        function testAngelForm() {
            const container = document.getElementById('angel-form-container');
            const result = document.getElementById('angel-result');
            
            try {
                CredentialsForm.generate('angel_one', angelFields, container);
                
                // Check TOTP field has pattern validation
                const totpInput = container.querySelector('input[name="totp"]');
                
                if (totpInput && totpInput.pattern === '\\d{6}' && totpInput.maxLength === 6) {
                    result.className = 'test-result pass';
                    result.textContent = '✓ PASS: TOTP field has correct pattern and maxlength validation';
                } else {
                    result.className = 'test-result fail';
                    result.textContent = '✗ FAIL: TOTP validation not set correctly';
                }
                result.style.display = 'block';
            } catch (error) {
                result.className = 'test-result fail';
                result.textContent = '✗ FAIL: ' + error.message;
                result.style.display = 'block';
            }
        }
        
        function testValidation() {
            const container = document.getElementById('validation-form-container');
            const result = document.getElementById('validation-result');
            
            try {
                CredentialsForm.generate('kite', kiteFields, container);
                
                // Try to validate empty form
                const isValid = CredentialsForm.validateForm(container);
                
                // Check if validation errors are shown
                const errors = container.querySelectorAll('.form-error[style*="block"]');
                const invalidInputs = container.querySelectorAll('.form-control.invalid');
                
                if (!isValid && errors.length > 0 && invalidInputs.length > 0) {
                    result.className = 'test-result pass';
                    result.textContent = `✓ PASS: Validation correctly failed with ${errors.length} error messages shown`;
                } else {
                    result.className = 'test-result fail';
                    result.textContent = '✗ FAIL: Validation should fail for empty required fields';
                }
                result.style.display = 'block';
            } catch (error) {
                result.className = 'test-result fail';
                result.textContent = '✗ FAIL: ' + error.message;
                result.style.display = 'block';
            }
        }
        
        function testTooltips() {
            const container = document.getElementById('tooltip-form-container');
            const result = document.getElementById('tooltip-result');
            
            try {
                CredentialsForm.generate('kite', kiteFields, container);
                
                // Check tooltip structure
                const tooltips = container.querySelectorAll('.tooltip-wrapper');
                let allValid = true;
                
                tooltips.forEach(tooltip => {
                    const icon = tooltip.querySelector('.tooltip-icon');
                    const content = tooltip.querySelector('.tooltip-content');
                    if (!icon || !content || !content.textContent) {
                        allValid = false;
                    }
                });
                
                if (allValid && tooltips.length > 0) {
                    result.className = 'test-result pass';
                    result.textContent = `✓ PASS: ${tooltips.length} tooltips generated with correct structure`;
                } else {
                    result.className = 'test-result fail';
                    result.textContent = '✗ FAIL: Tooltips not generated correctly';
                }
                result.style.display = 'block';
            } catch (error) {
                result.className = 'test-result fail';
                result.textContent = '✗ FAIL: ' + error.message;
                result.style.display = 'block';
            }
        }
    </script>
</body>
</html>
