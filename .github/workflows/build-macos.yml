name: Build macOS Executable

on:
  # Trigger on push to main branch
  push:
    branches: [ main, master ]
    tags:
      - 'v*'  # Trigger on version tags like v1.0, v2.0
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.0.0)'
        required: false
        default: '2.0.0'

jobs:
  build-macos:
    runs-on: macos-latest  # Free macOS runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'  # Use Python 3.11 for compatibility
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        
        # Create mock MetaTrader5 for macOS build
        mkdir -p mock_packages/MetaTrader5
        cp mock_mt5.py mock_packages/MetaTrader5/__init__.py
        
        # Install dependencies, excluding MetaTrader5
        grep -v "MetaTrader5" requirements.txt > requirements_mac.txt || true
        pip install -r requirements_mac.txt
        pip install pyinstaller
        
        # Install mock MT5
        cd mock_packages/MetaTrader5
        echo "from setuptools import setup; setup(name='MetaTrader5', version='5.0.47', py_modules=['__init__'])" > setup.py
        pip install -e .
        cd ../..
    
    - name: Build macOS executable
      run: |
        chmod +x build_mac.sh
        ./build_mac.sh
      continue-on-error: false
    
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        elif [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=2.0.0-$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        fi
    
    - name: Create ZIP archive
      run: |
        cd dist
        if [ -d "GEM_Trading_Bot_macOS" ]; then
          zip -r "GEM_Trading_Bot_v${{ steps.get_version.outputs.VERSION }}_macOS.zip" GEM_Trading_Bot_macOS
        else
          echo "Build directory not found!"
          exit 1
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: GEM_Trading_Bot_macOS_v${{ steps.get_version.outputs.VERSION }}
        path: dist/GEM_Trading_Bot_v${{ steps.get_version.outputs.VERSION }}_macOS.zip
        retention-days: 90
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/GEM_Trading_Bot_v${{ steps.get_version.outputs.VERSION }}_macOS.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build summary
      run: |
        echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform:** macOS" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Python:** $(python --version)" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifact" >> $GITHUB_STEP_SUMMARY
        echo "Download the macOS executable from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "dist/GEM_Trading_Bot_v${{ steps.get_version.outputs.VERSION }}_macOS.zip" ]; then
          SIZE=$(ls -lh "dist/GEM_Trading_Bot_v${{ steps.get_version.outputs.VERSION }}_macOS.zip" | awk '{print $5}')
          echo "- **File Size:** $SIZE" >> $GITHUB_STEP_SUMMARY
        fi
